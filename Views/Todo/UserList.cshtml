@model IEnumerable<TodoListApp.ViewModels.UserListViewModel>

@{
    ViewData["Title"] = "User List";
}

<div class="dashboard-container fade-in">
    <div class="dashboard-header" style="justify-content: space-between; display: flex; align-items: center;">
        <div>
            <h1>User List</h1>
            <p class="subtitle">Registered users in the system</p>
        </div>
        @if (User.IsInRole("SuperAdmin") || User.IsInRole("Admin"))
        {
            <a asp-action="CreateUser" class="btn-glow-primary">
                <span>+</span> Create New User
            </a>
        }
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mt-3" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #ef4444; padding: 1rem; border-radius: 8px;">
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="toast-container" id="toastContainer"></div>

    <div class="todo-card" style="margin-top: 2rem;">
        <div class="search-container-lite" style="margin-bottom: 1.5rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.6;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" class="search-input-lite" placeholder="Search users by name, email or role..." id="userSearchInput" onkeyup="filterUsers()">
        </div>

        <table class="table table-hover" id="userTable">
            <thead>
                <tr>
                    <th class="text-left">User ID</th>
                    <th class="text-left">Full Name</th>
                    <th class="text-left">Email</th>
                    <th class="text-left">Role</th>
                    <th class="text-left">Password Hash</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td>#@user.Id.Substring(0, 8)</td>
                        <td>@(user.Name ?? "N/A")</td>
                        <td>@user.Email</td>
                        <td>
                            @if (User.IsInRole("SuperAdmin") || (User.IsInRole("Admin") && user.Role != "SuperAdmin" && user.Role != "Admin"))
                            {
                                <select class="role-select-compact" onchange="changeUserRole('@user.Id', this.value)">
                                    @foreach (var r in new[] { "SuperAdmin", "Admin", "Manager", "PrivateUser", "NormalUser" })
                                    {
                                        <option value="@r" selected="@(user.Role == r ? "selected" : null)">@r</option>
                                    }
                                </select>
                            }
                            else
                            {
                                var badgeClass = user.Role.ToLower() switch {
                                    "superadmin" => "role-badge-superadmin",
                                    "admin" => "role-badge-admin",
                                    "manager" => "role-badge-manager",
                                    "privateuser" => "role-badge-privateuser",
                                    _ => "role-badge-normaluser"
                                };
                                <span class="role-badge @badgeClass">@user.Role</span>
                            }
                        </td>
                        <td class="cell-truncate" title="@user.PasswordHash">
                            @(string.IsNullOrEmpty(user.PasswordHash) ? "No Hash" : "********")
                        </td>
                        <td class="text-right">
                            @if (User.IsInRole("SuperAdmin") || User.IsInRole("Admin"))
                            {
                                <button onclick="openManageAccessModal('@user.Id', '@user.Name')" class="btn-manage-access" style="margin-right: 5px;" title="Manage App Access">Access</button>
                                <a asp-action="EditUser" asp-route-id="@user.Id" class="btn-edit-unique" style="margin-right: 5px;">Edit</a>
                                <form asp-controller="Todo" asp-action="DeleteUser" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                    <input type="hidden" name="id" value="@user.Id" />
                                    <button type="submit" class="btn-delete-unique">Delete</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Manage Access Modal -->
<div id="manageAccessModal" class="modal-overlay" style="display: none;">
    <div class="modal-content-wide glass-panel">
        <div class="modal-header">
            <div>
                <h2 id="modalUserName">Manage Access</h2>
                <p class="subtitle" style="margin: 0;">Grant or revoke features and widgets</p>
            </div>
            <button onclick="closeManageAccessModal()" class="btn-close-modal">&times;</button>
        </div>
        
        <div class="modal-body custom-scrollbar" style="max-height: 70vh; overflow-y: auto; padding: 1.5rem;">
            <div id="modalLoading" style="text-align: center; padding: 2rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; opacity: 0.6;">Fetching permissions...</p>
            </div>
            
            <div id="modalFeaturesContainer" style="display: none;">
                <div class="feature-section-header">
                    <h3>Pages</h3>
                    <div class="header-actions">
                        <button type="button" class="btn-select-all-mini" onclick="selectAllByType('Page')">Select All Pages</button>
                    </div>
                </div>
                <div class="feature-grid-mini" id="pageGrid"></div>

                <div class="feature-section-header" style="margin-top: 2rem;">
                    <h3>Dashboard Widgets</h3>
                    <div class="header-actions">
                        <button type="button" class="btn-select-all-mini" onclick="selectAllByType('Widget')">Select All Widgets</button>
                    </div>
                </div>
                <div class="feature-grid-mini" id="widgetGrid"></div>
            </div>
        </div>

        <div class="modal-footer">
            <button onclick="closeManageAccessModal()" class="btn-lite">Cancel</button>
            <button onclick="saveUserFeatures()" class="btn-glow-primary" id="btnSaveFeatures">Save Changes</button>
        </div>
    </div>
</div>

<script>
    let currentEditingUserId = null;

    async function openManageAccessModal(userId, userName) {
        currentEditingUserId = userId;
        document.getElementById('modalUserName').innerText = `Manage Access: ${userName || 'User'}`;
        document.getElementById('manageAccessModal').style.display = 'flex';
        document.getElementById('modalLoading').style.display = 'block';
        document.getElementById('modalFeaturesContainer').style.display = 'none';
        
        try {
            const response = await fetch(`/Todo/GetUserFeatures?userId=${userId}`);
            const data = await response.json();
            
            renderFeatureGrids(data.allFeatures, data.grantedFeatureIds);
            
            document.getElementById('modalLoading').style.display = 'none';
            document.getElementById('modalFeaturesContainer').style.display = 'block';
        } catch (error) {
            showToast('Failed to load user features.', 'error');
            closeManageAccessModal();
        }
    }

    function closeManageAccessModal() {
        document.getElementById('manageAccessModal').style.display = 'none';
        currentEditingUserId = null;
    }

    function renderFeatureGrids(allFeatures, grantedIds) {
        const pageGrid = document.getElementById('pageGrid');
        const widgetGrid = document.getElementById('widgetGrid');
        
        pageGrid.innerHTML = '';
        widgetGrid.innerHTML = '';
        
        allFeatures.forEach(f => {
            const isChecked = grantedIds.includes(f.id);
            const card = document.createElement('div');
            card.className = `feature-card-mini ${isChecked ? 'selected' : ''}`;
            card.onclick = () => toggleFeature(card, f.id);
            card.dataset.type = f.type === 0 ? 'Page' : 'Widget';
            card.dataset.id = f.id;
            
            card.innerHTML = `
                <div class="card-check-mini">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="event.stopPropagation()">
                </div>
                <div class="card-icon-mini">${f.icon}</div>
                <div class="card-info-mini">
                    <span class="card-title-mini">${f.name}</span>
                </div>
            `;
            
            if (f.type === 0) pageGrid.appendChild(card);
            else widgetGrid.appendChild(card);
        });
    }

    function toggleFeature(card, id) {
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        card.classList.toggle('selected', checkbox.checked);
    }

    function selectAllByType(type) {
        const cards = document.querySelectorAll(`.feature-card-mini[data-type="${type}"]`);
        const allSelected = Array.from(cards).every(c => c.querySelector('input').checked);
        
        cards.forEach(c => {
            const cb = c.querySelector('input');
            cb.checked = !allSelected;
            c.classList.toggle('selected', !allSelected);
        });
    }

    async function saveUserFeatures() {
        const btn = document.getElementById('btnSaveFeatures');
        const originalText = btn.innerText;
        btn.innerText = 'Saving...';
        btn.disabled = true;
        
        const selectedIds = Array.from(document.querySelectorAll('.feature-card-mini.selected'))
            .map(c => parseInt(c.dataset.id));
            
        try {
            const response = await fetch(`/Todo/UpdateUserFeatures?userId=${currentEditingUserId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(selectedIds)
            });
            
            const result = await response.json();
            if (result.success) {
                showToast(result.message, 'success');
                closeManageAccessModal();
                // Optionally reload or update UI if needed
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('Failed to update features.', 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function changeUserRole(userId, newRole) {
        try {
            const formData = new FormData();
            formData.append('userId', userId);
            formData.append('newRole', newRole);

            const response = await fetch('/Todo/ChangeRole', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showToast(result.message, 'success');
            } else {
                showToast(result.message, 'error');
                setTimeout(() => location.reload(), 2000);
            }
        } catch (error) {
            showToast('An error occurred while updating the role.', 'error');
        }
    }

    function filterUsers() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("userSearchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("userTable");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            var tdName = tr[i].getElementsByTagName("td")[1];
            var tdEmail = tr[i].getElementsByTagName("td")[2];
            var tdRole = tr[i].getElementsByTagName("td")[3];
            
            if (tdName || tdEmail || tdRole) {
                var txtValueName = tdName ? (tdName.textContent || tdName.innerText) : "";
                var txtValueEmail = tdEmail ? (tdEmail.textContent || tdEmail.innerText) : "";
                var txtValueRole = tdRole ? (tdRole.textContent || tdRole.innerText) : "";
                
                var combined = (txtValueName + " " + txtValueEmail + " " + txtValueRole).toUpperCase();
                if (combined.indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>

