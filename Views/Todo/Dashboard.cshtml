@model TodoListApp.ViewModels.DashboardViewModel

@{
    ViewData["Title"] = "Real-time Dashboard";
}

<!-- Leaflet for Country Maps -->
<!-- Leaflet for Country Maps (Local) -->
<link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />
<script src="~/lib/leaflet/leaflet.js"></script>

<style>
    /* --- Country Explorer Expanded Styles --- */
    .country-summary-box {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        animation: fadeInSlide 0.6s ease-out;
    }

    .country-summary-box h3 {
        font-size: 1.15rem;
        color: #a5b4fc;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-top: 0;
        font-weight: 600;
    }

    .wiki-extract {
        font-size: 0.98rem;
        line-height: 1.75;
        color: rgba(255, 255, 255, 0.85);
        font-style: italic;
        margin-bottom: 0;
    }

    .motto-pill {
        background: rgba(245, 158, 11, 0.15) !important;
        color: #fbbf24 !important;
        border: 1px solid rgba(245, 158, 11, 0.3) !important;
    }

    .administration-note {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Map Styling */
    .country-map-container {
        height: 300px;
        width: 100%;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
        overflow: hidden;
    }

    .info-group .icon {
        font-style: normal;
        margin-right: 0.5rem;
    }

    .places-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .place-tag {
        background: rgba(165, 180, 252, 0.1);
        color: #a5b4fc;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        border: 1px solid rgba(165, 180, 252, 0.2);
    }

    /* Accordion Styles */
    .country-accordion {
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .country-accordion.open {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(165, 180, 252, 0.2);
    }

    .accordion-header {
        padding: 1.25rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
    }

    .accordion-header:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .accordion-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #a5b4fc;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .accordion-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        opacity: 0.6;
    }

    .country-accordion.open .accordion-icon {
        transform: rotate(180deg);
    }

    .accordion-content {
        padding: 0 1.5rem 1.5rem 1.5rem;
        display: none;
        animation: slideDown 0.3s ease-out;
    }

    .country-accordion.open .accordion-content {
        display: block;
    }

    @@keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="dashboard-container centered-view">
    <div class="dashboard-header text-center">
        <h1>Welcome, @Model.UserName</h1>
        <div class="header-controls">
            <div class="format-toggle">
                <span class="toggle-label">24H</span>
                <label class="switch">
                    <input type="checkbox" id="timeFormatToggle">
                    <span class="slider round"></span>
                </label>
                <span class="toggle-label">12H</span>
            </div>
        </div>
        <div class="local-clock-container">
            <div id="localClockTime" class="live-clock">00:00:00</div>
            <div id="localClockDate" class="live-date">Loading date...</div>
            <div id="localTzLabel" class="tz-badge pulse">Detecting Timezone...</div>
        </div>
    </div>

    <div class="realtime-grid">
        <!-- Weather Widget -->
        <div class="insight-card summary-widget weather loading" onclick="openDetails('weather')">
            <div class="widget-preview">
                <div class="insight-icon" id="summaryWeatherIcon">@(string.IsNullOrEmpty(Model.Weather.Icon) ? "üå°Ô∏è" : Model.Weather.Icon)</div>
                <div class="insight-info">
                    <span class="insight-label">Local Weather</span>
                    <span class="insight-value" id="summaryWeatherTemp">@(Model.Weather.Temperature > 0 ? Model.Weather.Temperature + "¬∞C" : "--¬∞C")</span>
                    <span class="insight-meta" id="summaryWeatherMeta">@(string.IsNullOrEmpty(Model.Weather.City) ? Model.SelectedCity + " ‚Ä¢ Loading..." : Model.Weather.City + " ‚Ä¢ " + Model.Weather.Description)</span>
                </div>
            </div>
            <div class="widget-action">
                <span>View Forecast & Details</span>
            </div>
        </div>

        <!-- Currency Widget -->
        <div class="insight-card summary-widget currency loading" onclick="openDetails('currency')">
            <div class="widget-preview">
                <div class="insight-icon">üí±</div>
                <div class="insight-info">
                    <span class="insight-label">Currency Exchange</span>
                    <span class="insight-value" id="summaryCurrencyRate">@(Model.Currency.Rate > 0 ? Model.Currency.Rate.ToString("F4") : "--.----")</span>
                    <span class="insight-meta" id="summaryCurrencyMeta">1 @Model.FromCurrency = @(Model.Currency.Rate > 0 ? Model.Currency.Rate.ToString("F4") : "--") @Model.ToCurrency</span>
                </div>
            </div>
            <div class="widget-action">
                <span>View Chart & Converter</span>
            </div>
        </div>

        <!-- World Clock Widget -->
        <div class="insight-card summary-widget time loading" onclick="openDetails('time')">
            <div class="widget-preview">
                <div class="insight-icon">üåç</div>
                <div class="insight-info">
                    <span class="insight-label">Time Converter</span>
                    <span class="insight-value" id="summaryTargetTime" data-offset="@Model.TimeConversion.TotalOffsetMinutes">@(string.IsNullOrEmpty(Model.TimeConversion.TargetTime) ? "--:--" : Model.TimeConversion.TargetTime)</span>
                    <span class="insight-meta" id="summaryTimeMeta">@Model.TargetTimeZone</span>
                </div>
            </div>
            <div class="widget-action">
                <span>View World Clock</span>
            </div>
        </div>

        <!-- News Widget -->
        <div class="insight-card summary-widget news loading" id="newsWidgetCard" onclick="openDetails('news')">
            <div class="widget-preview">
                <div class="insight-icon">üì∞</div>
                <div class="insight-info">
                    <span class="insight-label">Local & Global News</span>
                    <span class="insight-value" id="summaryNewsCount">-- Items</span>
                    <span class="insight-meta" id="summaryNewsMeta">@Model.SelectedCity ‚Ä¢ Loading...</span>
                </div>
            </div>
            <div class="widget-action">
                <span>Read Latest Stories</span>
            </div>
        </div>

        <!-- Country Details Widget -->
        <div class="insight-card summary-widget country" onclick="openDetails('country')">
            <div class="widget-preview">
                <div class="insight-icon">üåê</div>
                <div class="insight-info">
                    <span class="insight-label">Country Explorer</span>
                    <span class="insight-value" id="summaryCountryName">Search Country</span>
                    <span class="insight-meta" id="summaryCountryMeta">A-Z Global Insight</span>
                </div>
            </div>
            <div class="widget-action">
                <span>Explore Destinations</span>
            </div>
        </div>
    </div>
</div>

<!-- Details Overlay & Panels -->
<div class="details-overlay" id="detailsOverlay" onclick="closeDetails()"></div>

<!-- Weather Details Panel -->
<div class="details-panel" id="weatherDetails" style="max-width: 800px;">
    <div class="panel-header">
        <h2>Detailed Weather</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content weather-expanded">
        <!-- 1. Location Details -->
        <div class="location-header">
            <h3 id="weatherLocation">@Model.Weather.City@(string.IsNullOrEmpty(Model.Weather.District) ? "" : ", " + Model.Weather.District)</h3>
            <p id="weatherSubLocation" class="text-muted">@Model.Weather.State, @Model.Weather.Country</p>
            <p id="weatherCoords">Lat: @Model.Weather.Latitude.ToString("F4") | Lon: @Model.Weather.Longitude.ToString("F4")</p>
        </div>

        <form id="weatherSearchForm" class="detail-form">
            <div class="form-group">
                <div class="input-with-button">
                    <input type="text" id="weatherSearchInput" name="city" value="@Model.SelectedCity" class="form-control" placeholder="Search City, State or Country..." />
                    <button type="submit" class="btn-primary-sm" id="weatherSearchSubmit">Search</button>
                    <button type="button" class="btn-secondary-sm" id="geolocateBtn" title="Use my current location">üìç</button>
                </div>
            </div>
        </form>

        <div class="weather-grid-detailed">
            <!-- 2. Current Weather Hero -->
            <div class="weather-main-section">
                <div class="current-weather-hero">
                    <div class="hero-icon" id="panelWeatherIcon">@Model.Weather.Icon</div>
                    <div class="hero-temp" id="panelTemperature">@Model.Weather.Temperature¬∞C</div>
                    <div class="hero-desc" id="panelDescription">@Model.Weather.Description in @Model.Weather.City</div>
                </div>

                <div class="weather-metrics-grid">
                    <div class="metric-card">
                        <span class="m-label">Feels Like</span>
                        <span class="m-value" id="weatherFeelsLike">@Model.Weather.FeelsLike¬∞C</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Humidity</span>
                        <span class="m-value" id="weatherHumidity">@Model.Weather.Humidity%</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Wind</span>
                        <span class="m-value" id="weatherWind">@Model.Weather.WindSpeed km/h</span>
                        <span class="m-sub" id="weatherWindDir">Dir: @Model.Weather.WindDirection¬∞</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Visibility</span>
                        <span class="m-value" id="weatherVisibility">@Model.Weather.Visibility.ToString("F1") km</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Pressure</span>
                        <span class="m-value" id="weatherPressure">@Model.Weather.Pressure hPa</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Dew Point</span>
                        <span class="m-value" id="weatherDewPoint">@Model.Weather.DewPoint¬∞C</span>
                    </div>
                </div>
            </div>

            <!-- 4. Air Quality & UV -->
            <div class="weather-side-section">
                <div class="info-card-glass aqi-card">
                    <span class="panel-subtitle-small">Air Quality (AQI)</span>
                    <div class="aqi-display">
                        <span class="aqi-val" id="weatherAQI">@Model.Weather.AQI</span>
                        <span class="aqi-level" id="weatherAQILevel">@Model.Weather.AQILevel</span>
                    </div>
                </div>
                <div class="info-card-glass uv-card" style="margin-top: 1rem;">
                    <span class="panel-subtitle-small">UV Index</span>
                    <div class="uv-display">
                        <span class="uv-val" id="weatherUV">@Model.Weather.UVIndex</span>
                        <span class="uv-risk" id="weatherUVRisk">@Model.Weather.UVRisk</span>
                    </div>
                </div>

                <!-- 5. Sun & Moon Data -->
                <div class="info-card-glass astro-card" style="margin-top: 1rem;">
                    <span class="panel-subtitle-small">Sun & Moon</span>
                    <div class="astro-grid">
                        <div class="astro-item">
                            <span>üåÖ Sunrise</span>
                            <strong id="weatherSunrise">@Model.Weather.Sunrise</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåá Sunset</span>
                            <strong id="weatherSunset">@Model.Weather.Sunset</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåô Moonrise</span>
                            <strong id="weatherMoonrise">@Model.Weather.Moonrise</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåí Moonset</span>
                            <strong id="weatherMoonset">@Model.Weather.Moonset</strong>
                        </div>
                    </div>
                    <hr class="glass-hr">
                    <div class="moon-phase-details">
                        <div class="moon-img-container">
                            <span class="moon-icon-huge" id="weatherMoonIcon">@Model.Weather.MoonIcon</span>
                        </div>
                        <div class="moon-text">
                            <span>Moon Phase</span>
                            <strong id="weatherMoonPhase">@Model.Weather.MoonPhase</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 5-Day Forecast -->
        <h3 class="panel-subtitle">5-Day Forecast</h3>
        <div class="weather-forecast-list" id="panelForecastList">
            @foreach (var day in Model.Weather.Forecasts)
            {
                <div class="forecast-item">
                    <span class="day-name">@day.Date</span>
                    <span class="day-icon">@day.Icon</span>
                    <div class="day-temps">
                        <span class="max">@Math.Round(day.MaxTemp)¬∞</span>
                        <span class="min">@Math.Round(day.MinTemp)¬∞</span>
                    </div>
                    <span class="day-desc">@day.Description</span>
                </div>
            }
        </div>
    </div>
</div>

<!-- Currency Details Panel -->
<div class="details-panel" id="currencyDetails">
    <div class="panel-header">
        <h2>Currency Converter</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <form id="currencyForm" class="detail-form">
            <div class="currency-converter-card">
                <div class="form-group">
                    <label>Amount to Convert</label>
                    <input type="number" id="convertAmount" value="1" class="form-control" step="any" />
                </div>
                
                <div class="currency-horizontal-row">
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">From</span>
                        <div class="custom-currency-select" id="fromCurrencyWrapper">
                            <div class="select-header" onclick="focusInput('fromSearch')">
                                <span class="select-icon">üí∞</span>
                                <input type="text" class="btn-search-input" id="fromSearch" placeholder="Search..." data-target="fromCurrencySelect" autocomplete="off" />
                            </div>
                            <div class="custom-options" id="fromOptions">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    var info = TodoListApp.Services.ExternalApiService.GetCurrencyInfo(curr);
                                    <div class="option-item" data-value="@curr" data-text="@info.Flag @curr - @info.Country" data-country="@info.Country">
                                        <span class="opt-flag">@info.Flag</span>
                                        <span class="opt-code">@curr</span>
                                        <span class="opt-country">@info.Country</span>
                                    </div>
                                }
                            </div>
                            <select id="fromCurrencySelect" name="fromCurrency" style="display: none;">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    <option value="@curr" selected="@(curr == Model.FromCurrency)">@curr</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <button type="button" class="central-swap-circle" id="swapCurrencies" title="Swap currencies">‚áÑ</button>
                    
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">To</span>
                        <div class="custom-currency-select" id="toCurrencyWrapper">
                            <div class="select-header" onclick="focusInput('toSearch')">
                                <span class="select-icon">üéØ</span>
                                <input type="text" class="btn-search-input" id="toSearch" placeholder="Search..." data-target="toCurrencySelect" autocomplete="off" />
                            </div>
                            <div class="custom-options" id="toOptions">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    var info = TodoListApp.Services.ExternalApiService.GetCurrencyInfo(curr);
                                    <div class="option-item" data-value="@curr" data-text="@info.Flag @curr - @info.Country" data-country="@info.Country">
                                        <span class="opt-flag">@info.Flag</span>
                                        <span class="opt-code">@curr</span>
                                        <span class="opt-country">@info.Country</span>
                                    </div>
                                }
                            </div>
                            <select id="toCurrencySelect" name="toCurrency" style="display: none;">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    <option value="@curr" selected="@(curr == Model.ToCurrency)">@curr</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="result-display">
                    <div class="result-header">Converted Amount</div>
                    <div class="conversion-result-row">
                        <div id="conversionResult" class="conversion-val">@Model.Currency.Rate</div>
                        <div id="rateMovement" class="movement-badge @(Model.Currency.IsUp == null ? "d-none" : (Model.Currency.IsUp == true ? "up" : "down"))">
                            @(Model.Currency.IsUp == true ? "‚Üë" : "‚Üì")
                        </div>
                    </div>
                    <div id="baseRateInfo" class="rate-info">1 @Model.Currency.From = @Model.Currency.Rate @Model.Currency.To</div>
                    <div id="currencyTimestamp" class="sync-time">Last Synced: @Model.Currency.LastUpdated</div>
                </div>
            </div>
        </form>

        <div class="currency-stats">
            <div class="chart-box">
                <h3 class="panel-subtitle">Market History (Last 7 Days)</h3>
                <div class="chart-container-large">
                    <canvas id="currencyChartFull"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Details Panel -->
<div class="details-panel" id="timeDetails">
    <div class="panel-header">
        <h2>World Clock & Converter</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <form id="timeForm" class="detail-form">
            <div class="header-controls">
                <div class="format-toggle">
                    <span class="toggle-label">12H</span>
                    <label class="switch">
                        <input type="checkbox" id="conversionFormatToggle" onchange="handleConversionFormatChange()">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-label">24H</span>
                </div>
            </div>

            <div class="currency-converter-card">
                
                <div class="currency-horizontal-row">
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">Source Zone</span>
                        <div class="custom-currency-select" id="sourceTimeWrapper">
                            <div class="select-header" onclick="focusInput('sourceTimeSearch')">
                                <span class="select-icon">üìç</span>
                                <input type="text" class="btn-search-input" id="sourceTimeSearch" placeholder="Search city/country..." autocomplete="off" />
                            </div>
                            <div class="custom-options" id="sourceTimeOptions">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <div class="option-item opt-item-layout" data-value="@tz.Id" data-text="@tz.Name" data-full="@tz.FullName">
                                        <div class="opt-main">
                                            <span class="opt-city">@tz.Name</span>
                                            <span class="opt-meta">@tz.Abbr</span>
                                        </div>
                                        <span class="opt-offset">@tz.Offset</span>
                                    </div>
                                }
                            </div>
                            <select id="sourceTimeSelect" name="sourceTime" style="display: none;">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <option value="@tz.Id" selected="@(tz.Id == Model.SourceTimeZone)">@tz.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <button type="button" class="central-swap-circle" id="swapTimeZones" title="Swap timezones">‚áÑ</button>

                    <div class="currency-btn-item">
                        <span class="btn-mini-label">Target Zone</span>
                        <div class="custom-currency-select" id="targetTimeWrapper">
                            <div class="select-header" onclick="focusInput('targetTimeSearch')">
                                <span class="select-icon">üåè</span>
                                <input type="text" class="btn-search-input" id="targetTimeSearch" placeholder="Search city/country..." autocomplete="off" />
                            </div>
                            <div class="custom-options" id="targetTimeOptions">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <div class="option-item opt-item-layout" data-value="@tz.Id" data-text="@tz.Name" data-full="@tz.FullName">
                                        <div class="opt-main">
                                            <span class="opt-city">@tz.Name</span>
                                            <span class="opt-meta">@tz.Abbr</span>
                                        </div>
                                        <span class="opt-offset">@tz.Offset</span>
                                    </div>
                                }
                            </div>
                            <select id="targetTimeSelect" name="targetTime" style="display: none;">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <option value="@tz.Id" selected="@(tz.Id == Model.TargetTimeZone)">@tz.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="result-display">
                    <div class="result-header">Converted Time</div>
                    <div class="conversion-result-row">
                        <div id="timeResultVal" class="conversion-val">@Model.TimeConversion.TargetTime</div>
                        <div id="timeAbbr" class="tz-abbr-badge">@Model.TimeConversion.TargetAbbr</div>
                        <div id="timeDayChange" class="day-change-badge @(Model.TimeConversion.DayChange == "Same Day" ? "d-none" : "")">@Model.TimeConversion.DayChange</div>
                    </div>
                    <div id="timeOffsetInfo" class="rate-info">Difference: @Model.TimeConversion.OffsetDisplay hours</div>
                </div>
            </div>
        </form>

        <h3 class="panel-subtitle">Global Overview</h3>
        <div class="world-clock-list">
            <div class="clock-row">
                <span class="city">New York</span>
                <span class="time" data-tz="America/New_York">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city">London</span>
                <span class="time" data-tz="Europe/London">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city">Mumbai</span>
                <span class="time" data-tz="Asia/Kolkata">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city">Tokyo</span>
                <span class="time" data-tz="Asia/Tokyo">--:--</span>
            </div>
            <div class="clock-row">
                 <span class="city">Dubai</span>
                 <span class="time" data-tz="Asia/Dubai">--:--</span>
            </div>
        </div>
    </div>
</div>

<!-- News Details Panel (Feed) -->
<div class="details-panel" id="newsDetails" style="max-width: 900px;">
    <div class="panel-header">
        <div class="header-info">
            <h2>Local & Global News</h2>
            <p id="newsResolvedLocation" class="text-muted small">Auto-detecting location...</p>
        </div>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <!-- News Controls -->
        <div class="news-controls">
            <div class="search-bar-row">
                <div class="input-with-button">
                    <input type="text" id="newsSearchInput" class="form-control" placeholder="Search news by location or keyword..." />
                    <button type="submit" class="btn-primary-sm" onclick="event.preventDefault(); refreshNewsData();">Search</button>
                </div>
                <div class="sort-selector">
                    <select id="newsSortSelect" onchange="refreshNewsData()" class="form-select-sm">
                        <option value="relevance">Most Relevant</option>
                        <option value="latest">Latest News</option>
                    </select>
                </div>
            </div>
            
            <div class="category-pills" id="newsCategoryPills">
                <button class="pill active" data-category="All">All</button>
                <button class="pill" data-category="World">World</button>
                <button class="pill" data-category="Business">Business</button>
                <button class="pill" data-category="Technology">Technology</button>
                <button class="pill" data-category="Health">Health</button>
                <button class="pill" data-category="Science">Science</button>
                <button class="pill" data-category="Sports">Sports</button>
                <button class="pill" data-category="Entertainment">Entertainment</button>
            </div>
        </div>

        <!-- News Feed Container -->
        <div class="news-feed-container" id="newsFeed">
            <!-- Loading State -->
            <div class="news-loading-state">
                <div class="spinner"></div>
                <p>Fetching authentic news...</p>
            </div>
        </div>

        <div class="news-load-more-container" id="newsLoadMoreContainer" style="display: none; justify-content: center; padding: 2rem 0;">
            <button class="btn-secondary-glass" onclick="loadMoreNews()">Show More Stories</button>
        </div>
    </div>
</div>

<!-- News Article Detail Page (Internal/Immersive) -->
<div class="details-panel" id="newsArticleDetails" style="max-width: 1000px; z-index: 1002;">
    <div class="panel-header">
        <button class="back-btn" onclick="backToNewsFeed()">‚Üê Back to Feed</button>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content article-reader" id="articleReaderContent">
        <div class="article-header">
            <div class="article-meta">
                <span id="articleSource" class="source-badge">Source</span>
                <span id="articleDate" class="date-text">Date</span>
            </div>
            <h1 id="articleTitle">Article Title</h1>
        </div>
        <div id="articleImageContainer" class="article-image-full"></div>
        <div id="articleBody" class="article-body">
            <!-- Content will be injected here -->
            <div class="article-loading">
                <div class="spinner"></div>
                <p>Extracting article content for in-app reading...</p>
            </div>
        </div>
        <div class="article-footer">
            <a id="articleSourceLink" href="#" target="_blank" class="btn-secondary-sm">Read Full Story on Source Website</a>
        </div>
    </div>
</div>

<!-- Country Details Panel -->
<div class="details-panel" id="countryDetails" style="max-width: 900px;">
    <div class="panel-header">
        <div class="header-info">
            <h2>Country Explorer</h2>
            <p class="text-muted small">Global facts & information A-Z</p>
        </div>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content country-explorer">
        <div class="country-search-area">
            <div class="search-input-wrapper">
                <i class="search-icon-glass">üîç</i>
                <input type="text" id="countrySearchInput" class="form-control" placeholder="Search any country (e.g. Canada, Brazil)..." oninput="handleCountrySearchInput(this.value)" autocomplete="off" />
                <div id="countrySearchResults" class="country-dropdown-glass" style="display: none;"></div>
            </div>
        </div>

        <div id="countryLoadingState" class="news-loading-state" style="display: none;">
            <div class="spinner"></div>
            <p>Fetching global data...</p>
        </div>

        <div id="countryPlaceholder" class="placeholder-empty">
            <div class="placeholder-icon">üåè</div>
            <h3>Discover the World</h3>
            <p>Search for any country to view comprehensive details including flags, capitals, populations, and more.</p>
        </div>

        <div id="countryDetailsContent" class="country-details-view" style="display: none;">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- Widget Detail Management ---
        function openDetails(type) {
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(type + 'Details').classList.add('active');
            document.getElementById('detailsOverlay').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scroll

            // Load chart if it's currency
            if (type === 'currency') {
                loadCurrencyHistory();
            }
            
            if (type === 'weather') {
                // Check if we should auto-geolocate
                // (optional: can be done automatically on load, but let's link it to the button too)
            }
        }

        function closeDetails() {
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('detailsOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }


        // --- 1. World Clocks ---
        function updateWorldClocks() {
            const clocks = document.querySelectorAll('.time[data-tz]');
            const now = new Date();
            clocks.forEach(clock => {
                const tz = clock.getAttribute('data-tz');
                try {
                    const timeString = now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit' });
                    clock.textContent = timeString;
                } catch (e) {
                    console.error("Invalid Timezone", tz);
                }
            });
        }
        setInterval(updateWorldClocks, 1000);
        updateWorldClocks();

        // --- 2. Currency Chart (Detailed) ---
        const ctxFull = document.getElementById('currencyChartFull')?.getContext('2d');
        let currencyChartFull;

        async function loadCurrencyHistory() {
            if (!ctxFull) return;
            const from = fromSelect?.value || '@Model.FromCurrency';
            const to = toSelect?.value || '@Model.ToCurrency';
            
            try {
                // Specifically request 7 days of history
                const res = await fetch(`/Todo/GetCurrencyHistoryJson?from=${from}&to=${to}&days=7`);
                const data = await res.json();
                
                if(data.labels && data.values) {
                    if (currencyChartFull) currencyChartFull.destroy();
                    
                    currencyChartFull = new Chart(ctxFull, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: `${from} to ${to} (7D Trend)`,
                                data: data.values,
                                borderColor: '#818cf8',
                                backgroundColor: 'rgba(129, 140, 248, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#818cf8',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', font: { size: 12 } } },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgba(255,255,255,0.1)',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, minRotation: 45 },
                                    grid: { display: false }
                                },
                                y: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load chart", e);
            }
        }

        // --- 3. Ticking Converter Clocks (Summary & Panel) ---
        function startConverterClocks() {
            const displays = [
                document.getElementById('summaryTargetTime'),
                document.getElementById('panelTargetTime')
            ];

            function update() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                
                displays.forEach(display => {
                    if(!display) return;
                    const offsetMinutes = parseFloat(display.getAttribute('data-offset'));
                    if(isNaN(offsetMinutes)) return;
                    const targetTime = new Date(utc + (offsetMinutes * 60000));
                    display.textContent = targetTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                });
            }
            
            setInterval(update, 1000);
            update();
        }
        // --- 4. Auto-Open Panels on Reload ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('city')) openDetails('weather');
            if (params.has('fromCurrency') || params.has('toCurrency')) openDetails('currency');
            if (params.has('sourceTime') || params.has('targetTime')) openDetails('time');
        });

        // --- 5. Geolocation & AJAX Search ---
        const geolocateBtn = document.getElementById('geolocateBtn');
        const weatherForm = document.getElementById('weatherSearchForm');
        const weatherInput = document.getElementById('weatherSearchInput');
        const weatherSubmit = document.getElementById('weatherSearchSubmit');

        if (weatherForm) {
            weatherForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const city = weatherInput.value.trim();
                if (!city) return;

                weatherSubmit.disabled = true;
                weatherSubmit.textContent = 'Searching...';

                try {
                    const response = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(city)}`);
                    const data = await response.json();
                    if (data.description === "City not found") {
                        alert("City not found. Please try a different name.");
                    } else {
                        updateWeatherUI(data);
                    }
                } catch (e) {
                    alert("Failed to fetch weather data.");
                } finally {
                    weatherSubmit.disabled = false;
                    weatherSubmit.textContent = 'Search';
                }
            });
        }

        if (geolocateBtn) {
            geolocateBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    geolocateBtn.classList.add('loading');
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                const response = await fetch(`/Todo/GetWeatherByCoordsJson?lat=${latitude}&lon=${longitude}`);
                                const data = await response.json();
                                updateWeatherUI(data);
                                geolocateBtn.classList.remove('loading');
                            } catch (e) {
                                alert("Failed to fetch weather for your location.");
                                geolocateBtn.classList.remove('loading');
                            }
                        },
                        (error) => {
                            alert("Location access denied. Please use manual search.");
                            geolocateBtn.classList.remove('loading');
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            });
        }

        function updateWeatherUI(data) {
            // 1. Update Layout/Header
            let title = data.city || "My Location";
            if (data.localArea && data.localArea !== data.city) {
                title = `${data.localArea}, ${data.city}`;
            }
            document.getElementById('weatherLocation').textContent = title;

            const subLocParts = [];
            if (data.district && data.district !== data.city && data.district !== data.localArea) subLocParts.push(data.district);
            if (data.state) subLocParts.push(data.state);
            if (data.country) subLocParts.push(data.country);
            
            const subLoc = document.getElementById('weatherSubLocation');
            if (subLoc) subLoc.textContent = subLocParts.join(', ');
            document.getElementById('weatherCoords').textContent = `Lat: ${data.latitude.toFixed(4)} | Lon: ${data.longitude.toFixed(4)}`;

            // 2. Update Summary Widget
            const weatherSummary = document.querySelector('.insight-card.weather');
            if (weatherSummary) {
                weatherSummary.querySelector('.insight-icon').textContent = data.icon;
                weatherSummary.querySelector('.insight-value').textContent = data.temperature + '¬∞C';
                weatherSummary.querySelector('.insight-meta').textContent = title + ' ‚Ä¢ ' + data.description;
            }

            // 3. Update Detail Panel Hero
            document.getElementById('panelWeatherIcon').textContent = data.icon;
            document.getElementById('panelTemperature').textContent = data.temperature + '¬∞C';
            document.getElementById('panelDescription').textContent = `${data.description} in ${data.city}`;

            // 4. Update Detailed Metrics
            document.getElementById('weatherFeelsLike').textContent = data.feelsLike + '¬∞C';
            document.getElementById('weatherHumidity').textContent = data.humidity + '%';
            document.getElementById('weatherWind').textContent = data.windSpeed + ' km/h';
            document.getElementById('weatherWindDir').textContent = `Dir: ${data.windDirection}¬∞`;
            document.getElementById('weatherVisibility').textContent = data.visibility.toFixed(1) + ' km';
            document.getElementById('weatherPressure').textContent = data.pressure + ' hPa';
            document.getElementById('weatherDewPoint').textContent = data.dewPoint + '¬∞C';

            // 5. Update AQI & UV
            document.getElementById('weatherAQI').textContent = data.aqi;
            document.getElementById('weatherAQILevel').textContent = data.aqiLevel;
            document.getElementById('weatherUV').textContent = data.uvIndex;
            document.getElementById('weatherUVRisk').textContent = data.uvRisk;

            // 6. Update Sun & Moon
            document.getElementById('weatherSunrise').textContent = data.sunrise;
            document.getElementById('weatherSunset').textContent = data.sunset;
            document.getElementById('weatherMoonrise').textContent = data.moonrise;
            document.getElementById('weatherMoonset').textContent = data.moonset;
            document.getElementById('weatherMoonPhase').textContent = data.moonPhase;
            document.getElementById('weatherMoonIcon').textContent = data.moonIcon;

            // 7. Update Forecast
            const forecastList = document.getElementById('panelForecastList');
            if (forecastList && data.forecasts) {
                forecastList.innerHTML = data.forecasts.map(day => `
                    <div class="forecast-item">
                        <span class="day-name">${day.date}</span>
                        <span class="day-icon">${day.icon}</span>
                        <div class="day-temps">
                            <span class="max">${Math.round(day.maxTemp)}¬∞</span>
                            <span class="min">${Math.round(day.minTemp)}¬∞</span>
                        </div>
                        <span class="day-desc">${day.description}</span>
                    </div>
                `).join('');
            }
            
            const cityInput = document.querySelector('input[name="city"]');
            if (cityInput) cityInput.value = data.city;
        }

        // Auto-Geolocate logic moved to initDashboard to avoid redundancy

        // --- 6. Currency Converter AJAX ---
        const currencyForm = document.getElementById('currencyForm');
        const fromSelect = document.getElementById('fromCurrencySelect');
        const toSelect = document.getElementById('toCurrencySelect');
        const amountInput = document.getElementById('convertAmount');
        const swapBtn = document.getElementById('swapCurrencies');
        
        let currentRate = @Model.Currency.Rate;

        async function refreshCurrencyData() {
            console.log(">>> refreshCurrencyData() called");
            const from = fromSelect.value;
            const to = toSelect.value;
            console.log("Currency pair:", from, "to", to);
            const card = document.querySelector('.insight-card.currency');
            try {
                const res = await fetch(`/Todo/GetCurrencyJson?from=${from}&to=${to}`);
                console.log("Currency API response status:", res.status);
                const data = await res.json();
                console.log("Currency data received:", data);
                currentRate = data.rate;
                updateCurrencyUI(data);
                loadCurrencyHistory(); // Refresh chart too
                console.log("<<< refreshCurrencyData() complete");
            } catch (e) {
                console.error("Currency fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        function updateCurrencyUI(data) {
            // Update Summary Widget
            const summaryWidget = document.querySelector('.insight-card.currency');
            if (summaryWidget) {
                summaryWidget.classList.remove('loading');
                const rateEl = document.getElementById('summaryCurrencyRate');
                if (rateEl) rateEl.textContent = data.rate;
                const metaEl = document.getElementById('summaryTimeMeta'); // reused meta if exists or others
                const subMetaEl = document.getElementById('summaryCurrencyMeta');
                if (subMetaEl) subMetaEl.textContent = `1 ${data.from} = ${data.rate} ${data.to}`;
            }
            
            // Update Panel Result
            document.getElementById('baseRateInfo').textContent = `1 ${data.from} = ${data.rate} ${data.to}`;
            document.getElementById('currencyTimestamp').textContent = `Last Synced: ${data.lastUpdated}`;
            
            const movementBadge = document.getElementById('rateMovement');
            if (movementBadge) {
                movementBadge.classList.remove('d-none', 'up', 'down');
                if (data.isUp === true) {
                    movementBadge.textContent = '‚Üë';
                    movementBadge.classList.add('up');
                } else if (data.isUp === false) {
                    movementBadge.textContent = '‚Üì';
                    movementBadge.classList.add('down');
                } else {
                    movementBadge.classList.add('d-none');
                }
            }

            calculateResult();
        }

        function calculateResult() {
            if (!amountInput) return;
            const amount = parseFloat(amountInput.value) || 0;
            const result = (amount * currentRate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
            const resultDisplay = document.getElementById('conversionResult');
            if (resultDisplay) resultDisplay.textContent = result;
        }

        if (fromSelect) fromSelect.addEventListener('change', refreshCurrencyData);
        if (toSelect) toSelect.addEventListener('change', refreshCurrencyData);
        if (amountInput) amountInput.addEventListener('input', calculateResult);
        // Helper to focus input
        window.focusInput = function(id) {
            const el = document.getElementById(id);
            if (el) {
                el.focus();
                const wrapper = el.closest('.custom-currency-select');
                if (wrapper) wrapper.classList.add('active');
            }
        };

        // Custom Dropdown & Search Logic (shared by Currency & Time)
        document.querySelectorAll('.custom-currency-select').forEach(wrapper => {
            const input = wrapper.querySelector('.btn-search-input');
            const options = wrapper.querySelector('.custom-options');
            const select = wrapper.querySelector('select');
            const isTime = wrapper.id.includes('Time');
            
            // Set initial value
            if (select && input) {
                const opt = select.options[select.selectedIndex];
                if (opt) input.value = opt.text.trim();
            }

            input.addEventListener('focus', () => {
                wrapper.classList.add('active');
                input.select();
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('active');
                }
            });

            // Filtering
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                const items = options.querySelectorAll('.option-item');
                items.forEach(item => {
                    const text = item.getAttribute('data-text').toLowerCase();
                    const fullName = item.getAttribute('data-full')?.toLowerCase() || "";
                    const match = text.includes(term) || fullName.includes(term);
                    item.style.display = match ? 'flex' : 'none';
                });
            });

            // Selection
            options.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', () => {
                    const val = item.getAttribute('data-value');
                    select.value = val;
                    input.value = item.getAttribute('data-text').trim();
                    wrapper.classList.remove('active');
                    
                    if (isTime) {
                        refreshTimeData();
                    } else {
                        refreshCurrencyData();
                    }
                });
            });

            // Enter Key - Resolution (Only for Currency)
            if (!isTime) {
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const term = input.value.trim();
                        
                        // 1. Direct match check
                        const items = Array.from(options.querySelectorAll('.option-item'));
                        const directMatch = items.find(it => 
                            it.getAttribute('data-value').toLowerCase() === term.toLowerCase() ||
                            it.getAttribute('data-country')?.toLowerCase() === term.toLowerCase()
                        );

                        if (directMatch) {
                            const val = directMatch.getAttribute('data-value');
                            select.value = val;
                            input.value = directMatch.getAttribute('data-text').trim();
                            refreshCurrencyData();
                        } else {
                            // 2. Resolve via Geocoding
                            input.classList.add('resolving');
                            try {
                                const res = await fetch(`/Todo/ResolveCurrencyByLocation?location=${encodeURIComponent(term)}`);
                                const data = await res.json();
                                if (data.currencyCode) {
                                    select.value = data.currencyCode;
                                    const newMatch = items.find(it => it.getAttribute('data-value') === data.currencyCode);
                                    if (newMatch) input.value = newMatch.getAttribute('data-text').trim();
                                    refreshCurrencyData();
                                } else {
                                    alert("Could not resolve location: " + term);
                                }
                            } catch (err) {
                                console.error("Resolution failed", err);
                            } finally {
                                input.classList.remove('resolving');
                            }
                        }
                        input.blur();
                        wrapper.classList.remove('active');
                    }
                });
            } else {
                // Time-specific Enter key - Smart Resolution
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const term = input.value.trim();
                        const items = Array.from(options.querySelectorAll('.option-item'));
                        
                        // 1. Check for exact text match or match within visible options
                        // Use a loose match first on what's filtered
                        const visibleItem = items.find(it => it.style.display !== 'none' && (
                             it.getAttribute('data-text').toLowerCase() === term.toLowerCase() ||
                             it.getAttribute('data-full').toLowerCase().includes(term.toLowerCase())
                        ));

                        if (visibleItem) {
                            visibleItem.click();
                            input.blur();
                            wrapper.classList.remove('active');
                            return;
                        }

                        // 2. Resolve via Geocoding (Smart Auto-Detect)
                        input.classList.add('resolving'); // Add loading spinner style if any
                        const originalPlaceholder = input.placeholder;
                        input.placeholder = "Detecting timezone...";
                        
                        try {
                            const res = await fetch(`/Todo/ResolveTimeZone?location=${encodeURIComponent(term)}`);
                            const data = await res.json();
                            
                            if (data.timezoneId) {
                                // Try to find the IANA ID match
                                // Note: Server returns IANA ID (e.g. Asia/Kolkata), but we might have Windows IDs in values?
                                // Our updated controller ensures IDs are IANA-compatible or we map them.
                                // Let's try matching the ID directly or the IANA part of the name
                                
                                let match = items.find(it => it.getAttribute('data-value') === data.timezoneId);
                                
                                // Fallback: Try matching by text content (e.g. server returns "Asia/Kolkata", option is "Asia/Kolkata (UTC+5.5)")
                                if (!match) {
                                     match = items.find(it => it.getAttribute('data-text').startsWith(data.timezoneId));
                                }

                                if (match) {
                                    // Show success feedback
                                    // toast(`Resolved '${term}' to ${data.timezoneId}`); // If we had a toast function
                                    console.log(`Resolved '${term}' to ${data.timezoneId}`);
                                    
                                    select.value = match.getAttribute('data-value');
                                    input.value = match.getAttribute('data-text').trim();
                                    match.scrollIntoView({ block: 'center' });
                                    
                                    refreshTimeData();
                                } else {
                                    alert(`Location found (${data.timezoneId}), but not in our supported list.`);
                                }
                            } else {
                                alert(`Could not find a timezone for: "${term}". Try a major city name.`);
                            }
                        } catch (err) {
                            console.error("Timezone resolution failed", err);
                            alert("Error detecting timezone. Please check your connection.");
                        } finally {
                            input.classList.remove('resolving');
                            input.placeholder = originalPlaceholder;
                            input.blur();
                            wrapper.classList.remove('active');
                        }
                    }
                });
            }
        });

        // Updated Swap Logic for Unified Buttons
        const updateInputText = (input, val) => {
            const wrapper = input.closest('.custom-currency-select');
            const item = wrapper.querySelector(`.option-item[data-value="${val}"]`);
            if (item) input.value = item.getAttribute('data-text').trim();
        };

        document.getElementById('swapCurrencies')?.addEventListener('click', () => {
            const fromSelect = document.getElementById('fromCurrencySelect');
            const toSelect = document.getElementById('toCurrencySelect');
            const fromInput = document.getElementById('fromSearch');
            const toInput = document.getElementById('toSearch');

            if (!fromSelect || !toSelect) return;

            const tempVal = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempVal;

            if (fromInput) updateInputText(fromInput, fromSelect.value);
            if (toInput) updateInputText(toInput, toSelect.value);

            refreshCurrencyData();
        });

        document.getElementById('swapTimeZones')?.addEventListener('click', () => {
            const srcSel = document.getElementById('sourceTimeSelect');
            const targetSel = document.getElementById('targetTimeSelect');
            const srcInput = document.getElementById('sourceTimeSearch');
            const targetInput = document.getElementById('targetTimeSearch');

            if (!srcSel || !targetSel) return;

            // 1. Swap hidden select values
            const tempVal = srcSel.value;
            srcSel.value = targetSel.value;
            targetSel.value = tempVal;

            // 2. Swap visible input texts directly (much safer than re-looking up)
            if (srcInput && targetInput) {
                const tempText = srcInput.value;
                srcInput.value = targetInput.value;
                targetInput.value = tempText;
            }

            refreshTimeData();
        });

        // --- 7. TIME HUB LOGIC ---
        const timeForm = document.getElementById('timeForm');
        const sourceSelect = document.getElementById('sourceTimeSelect');
        const targetSelect = document.getElementById('targetTimeSelect');
        let lastTimeData = null; // Client-side cache for instant toggling

        function handleTimeFormatChange() {
             if (lastTimeData) {
                 updateTimeUI(lastTimeData);
             }
             refreshLocalClock();
        }

        async function refreshTimeData() {
            console.log(">>> refreshTimeData() called");
            if (!sourceSelect || !targetSelect) return;

            const source = sourceSelect.value;
            const target = targetSelect.value;
            
            // Handle Empty State
            if (!source || !target) {
                console.log("Source or Target empty, clearing result.");
                document.getElementById('timeResultVal').textContent = "--:--";
                document.getElementById('timeAbbr').textContent = "";
                document.querySelector('.insight-card.time')?.classList.remove('loading');
                return;
            }

            const time = ''; // Always use current time
            console.log("Time zones:", source, "to", target);
            const card = document.querySelector('.insight-card.time');
            if (card) card.classList.add('loading');

            try {
                const res = await fetch(`/Todo/GetTimeJson?source=${encodeURIComponent(source)}&target=${encodeURIComponent(target)}&time=${encodeURIComponent(time)}`);
                const data = await res.json();
                lastTimeData = data; // Cache it
                updateTimeUI(data);
            } catch (e) {
                console.error("Time fetch failed:", e);
            } finally {
                if (card) card.classList.remove('loading');
            }
        }



        function handleConversionFormatChange() {
             if (lastTimeData) {
                 updateTimeUI(lastTimeData);
             }
        }

        function updateTimeUI(data) {
            const is12h = document.getElementById('conversionFormatToggle')?.checked;
            
            // Format time helper
            const formatTime = (timeStr) => {
                if (!is12h) return timeStr;
                const [h, m] = timeStr.split(':');
                const hours = parseInt(h);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const h12 = hours % 12 || 12;
                return `${h12}:${m} ${ampm}`;
            };

            const timeWidget = document.querySelector('.insight-card.time');
            if (timeWidget) {
                timeWidget.classList.remove('loading');
                const targetDisplay = document.getElementById('summaryTargetTime');
                if (targetDisplay) {
                    targetDisplay.textContent = formatTime(data.targetTime);
                    targetDisplay.setAttribute('data-offset', data.totalOffsetMinutes);
                }

                // FIX: Update the main panel result with formatting
                const resultVal = document.getElementById('timeResultVal');
                if (resultVal) {
                    resultVal.textContent = formatTime(data.targetTime);
                }
                
                const resultAbbr = document.getElementById('timeAbbr');
                if (resultAbbr) resultAbbr.textContent = data.targetAbbr || 'UTC';
            }

            const resultVal = document.getElementById('timeResultVal');
            if (resultVal) resultVal.textContent = formatTime(data.targetTime);

            const abbrBadge = document.getElementById('timeAbbr');
            if (abbrBadge) abbrBadge.textContent = data.targetAbbr || 'UTC';

            const dayChangeBadge = document.getElementById('timeDayChange');
            if (dayChangeBadge) {
                dayChangeBadge.textContent = data.dayChange;
                if (data.dayChange === "Same Day" || !data.dayChange) {
                    dayChangeBadge.classList.add('d-none');
                } else {
                    dayChangeBadge.classList.remove('d-none');
                    dayChangeBadge.className = 'day-change-badge'; // reset
                    if (data.dayChange === "Next Day") dayChangeBadge.classList.add('next-day');
                    if (data.dayChange === "Previous Day") dayChangeBadge.classList.add('prev-day');
                }
            }

            const offsetInfo = document.getElementById('timeOffsetInfo');
            if (offsetInfo) {
                offsetInfo.textContent = `Difference: ${data.offsetDisplay} hours`;
            }
        }


        if (sourceSelect) sourceSelect.addEventListener('change', refreshTimeData);
        if (targetSelect) targetSelect.addEventListener('change', refreshTimeData);
        
        const swapTimeZonesBtn = document.getElementById('swapTimeZones');
        if (swapTimeZonesBtn) {
            swapTimeZonesBtn.addEventListener('click', () => {
                const temp = sourceSelect.value;
                sourceSelect.value = targetSelect.value;
                targetSelect.value = temp;
                refreshTimeData();
            });
        }

        // --- 11. NEWS WIDGET LOGIC ---
        let currentNewsCategory = 'All';
        let lastResolvedNewsLocation = "";
        let allNewsItems = [];
        let newsVisibleCount = 0;
        const NEWS_PAGE_SIZE = 12;
        const NEWS_PLACEHOLDER_IMG = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=800&q=80"; // Premium abstract news image

        async function refreshNewsData() {
            const feedContainer = document.getElementById('newsFeed');
            const searchInput = document.getElementById('newsSearchInput');
            const sortSelect = document.getElementById('newsSortSelect');
            const resolvedLabel = document.getElementById('newsResolvedLocation');
            const card = document.getElementById('newsWidgetCard');
            
            const location = searchInput.value || lastResolvedNewsLocation || '@Model.SelectedCity' || 'London';
            const category = currentNewsCategory === 'All' ? '' : currentNewsCategory;
            const sortBy = sortSelect.value;
            
            if (card) card.classList.add('loading');
            feedContainer.innerHTML = '<div class="news-loading-state"><div class="spinner"></div><p>Fetching authentic news...</p></div>';

            try {
                const res = await fetch(`/Todo/GetNewsJson?location=${encodeURIComponent(location)}&category=${encodeURIComponent(category)}&sortBy=${sortBy}`);
                const data = await res.json();
                
                lastResolvedNewsLocation = data.resolvedLocation;
                if (resolvedLabel) resolvedLabel.textContent = `Showing news for: ${data.resolvedLocation}`;
                
                // Store all items for pagination
                allNewsItems = data.items || [];
                newsVisibleCount = 0; // Reset index
                
                renderNewsFeed(false); // Initial render (full list replaced)
                updateLoadMoreVisibility();
                
                if (card) {
                    card.classList.remove('loading');
                    const countDisplay = document.getElementById('summaryNewsCount');
                    const metaDisplay = document.getElementById('summaryNewsMeta');
                    if (countDisplay) countDisplay.textContent = `${allNewsItems.length} Stories`;
                    if (metaDisplay) metaDisplay.textContent = `${data.resolvedLocation} ‚Ä¢ ${category || 'General'}`;
                }
            } catch (err) {
                console.error("News fetch failed:", err);
                feedContainer.innerHTML = '<div class="news-loading-state"><p>‚ö†Ô∏è Failed to load news. Please try a different location.</p></div>';
                if (card) card.classList.remove('loading');
            }
        }

        function updateLoadMoreVisibility() {
            const container = document.getElementById('newsLoadMoreContainer');
            if (container) {
                container.style.display = (newsVisibleCount < allNewsItems.length) ? 'flex' : 'none';
            }
        }

        function loadMoreNews() {
            renderNewsFeed(true); // Append mode
            updateLoadMoreVisibility();
        }

        function renderNewsFeed(append = false) {
            const container = document.getElementById('newsFeed');
            
            const start = newsVisibleCount;
            const end = Math.min(start + NEWS_PAGE_SIZE, allNewsItems.length);
            const batch = allNewsItems.slice(start, end);
            newsVisibleCount = end;

            if (!append && batch.length === 0) {
                container.innerHTML = '<div class="news-loading-state"><p>No relevant news stories found for this location.</p></div>';
                return;
            }

            const html = batch.map((item, index) => {
                const globalIndex = start + index;
                const displayImg = item.imageUrl || NEWS_PLACEHOLDER_IMG;

                return `
                    <div class="news-item-card" onclick="viewArticle(${globalIndex})">
                        <div class="news-image" 
                             style="background-image: url('${displayImg.replace(/'/g, "%27")}'), url('${NEWS_PLACEHOLDER_IMG}')"
                             onerror="this.style.backgroundImage='url(${NEWS_PLACEHOLDER_IMG})'">
                        </div>
                        <div class="news-content">
                            <div class="news-source-row">
                                <span class="news-source">${item.source}</span>
                                <span class="news-date">${item.published}</span>
                            </div>
                            <h3 class="news-headline">${item.title}</h3>
                            <p class="news-snippet">${item.description}</p>
                            <div class="news-footer">
                                <button class="btn-read-more">Read More <span class="arrow">‚Üí</span></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (append) {
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }

        function viewArticle(index) {
            window.location.href = `/Todo/NewsDetail?index=${index}`;
        }

        async function openArticleDetail(url, title, source, date, img, description) {
            const detailPanel = document.getElementById('newsArticleDetails');
            const bodyContainer = document.getElementById('articleBody');
            const overlay = document.getElementById('detailsOverlay');
            
            // Ensure any other panel is closed and overlay is visible
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            
            // Show panel and overlay
            detailPanel.classList.add('active');
            if (overlay) overlay.classList.add('active');
            
            // Set content
            document.getElementById('articleTitle').textContent = title || 'Untitled';
            document.getElementById('articleSource').textContent = source || 'News Source';
            document.getElementById('articleDate').textContent = date || '';
            document.getElementById('articleSourceLink').href = url || '#';
            
            const imgContainer = document.getElementById('articleImageContainer');
            imgContainer.innerHTML = `<img src="${img}" alt="Featured Image" class="article-hero-img" onerror="this.src='${NEWS_PLACEHOLDER_IMG}'">`;
            
            // Clean and set description (extended summary)
            bodyContainer.innerHTML = `<div class="article-content-wrapper"><p class="article-intro-text">${description || 'Detailed content not available.'}</p></div>`;
        }

        function backToNewsFeed() {
            openDetails('news');
        }

        // --- Category Pill Interaction ---
        document.querySelectorAll('#newsCategoryPills .pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('#newsCategoryPills .pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentNewsCategory = pill.getAttribute('data-category');
                refreshNewsData();
            });
        });

        // Search on Enter
        const newsSearchInput = document.getElementById('newsSearchInput');
        if (newsSearchInput) {
            newsSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    refreshNewsData();
                }
            });
        }

        // --- 9. GLOBAL INITIALIZATION ---
        async function initDashboard() {
            console.log(">>> initDashboard() started");

            let city = '@Model.SelectedCity';
            console.log("Initial city:", city);
            
            // Try browser geolocation first if no city specified
            if (!city || city === "London") {
                if (navigator.geolocation) {
                    try {
                        console.log("Attempting geolocation...");
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 3000 });
                        });
                        const { latitude, longitude } = position.coords;
                        const res = await fetch(`/Todo/GetWeatherByCoordsJson?lat=${latitude}&lon=${longitude}`);
                        const data = await res.json();
                        updateWeatherUI(data);
                        city = data.city;
                        console.log("Geolocation successful, city:", city);
                    } catch (err) {
                        console.info("Dev Mode: Browser geolocation unavailable (Localhost), trying IP fallback...");
                        try {
                            const ipRes = await fetch('https://ipapi.co/json/');
                            const ipData = await ipRes.json();
                            if (ipData.city) {
                                console.log("IP Fallback successful:", ipData.city);
                                const res = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(ipData.city)}`);
                                const data = await res.json();
                                updateWeatherUI(data);
                                city = data.city;
                            }
                        } catch (e) {
                            console.warn("All location detections failed, using default.");
                        }
                    }
                }
            }

            // Always fetch data on page load
            const finalCity = city || "London";
            console.log("Fetching data for city:", finalCity);
            
            console.log("Calling refreshWeatherData...");
            refreshWeatherData(finalCity);
            
            console.log("Calling refreshCurrencyData...");
            refreshCurrencyData();
            
            console.log("Calling refreshTimeData...");
            refreshTimeData();

            console.log("Calling refreshNewsData...");
            refreshNewsData();
            
            console.log("<<< initDashboard() complete");
        }

        // Modified weather fetch for init
        async function refreshWeatherData(cityValue) {
            console.log(">>> refreshWeatherData() called for:", cityValue);
            const card = document.querySelector('.insight-card.weather');
            try {
                const response = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(cityValue)}`);
                console.log("Weather API response status:", response.status);
                const data = await response.json();
                console.log("Weather data received:", data);
                updateWeatherUI(data);
                if (card) card.classList.remove('loading');
                console.log("<<< refreshWeatherData() complete");
            } catch (e) {
                console.error("Weather fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        // --- 10. Local Clock & Timezone Detection ---
        function refreshLocalClock() {
            const timeDisplay = document.getElementById('localClockTime');
            const dateDisplay = document.getElementById('localClockDate');
            const formatToggle = document.getElementById('timeFormatToggle');
            const now = new Date();
            const is12h = formatToggle ? !formatToggle.checked : true; // Inverted check logic if toggle is structured as 12H-24H
            
            // Get checked state: our toggle is [checked=24H]
            const use24h = formatToggle ? formatToggle.checked : false;

            if (timeDisplay) {
                timeDisplay.textContent = now.toLocaleTimeString(undefined, { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: !use24h 
                });
            }
            if (dateDisplay) dateDisplay.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function startLocalClock() {
            const tzLabel = document.getElementById('localTzLabel');
            const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (tzLabel) tzLabel.textContent = userTz;

            // Attempt to sync Source Zone in converter
            const sourceSel = document.getElementById('sourceTimeSelect');
            const sourceInput = document.getElementById('sourceTimeSearch');
            if (sourceSel && sourceInput) {
                 const ianaCity = userTz.split('/').pop().replace('_', ' ');
                 Array.from(sourceSel.options).forEach(opt => {
                     // Check for IANA ID match or descriptive match
                     if (opt.value === userTz || opt.text.includes(ianaCity)) {
                         sourceSel.value = opt.value;
                         updateInputText(sourceInput, opt.value);
                     }
                 });
            }

            refreshLocalClock();
            setInterval(refreshLocalClock, 1000);
        }

        // --- 11. Country Explorer ---
        let countrySearchTimeout;

        async function handleCountrySearchInput(query) {
            if (countrySearchTimeout) clearTimeout(countrySearchTimeout);
            
            const resultsContainer = document.getElementById('countrySearchResults');
            if (!query || query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            countrySearchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/Todo/SearchCountries?query=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    
                    if (data && data.length > 0) {
                        renderCountrySearchResults(data);
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.style.display = 'none';
                    }
                } catch (e) {
                    console.error("Country search failed:", e);
                }
            }, 300);
        }

        function renderCountrySearchResults(countries) {
            const list = document.getElementById('countrySearchResults');
            list.innerHTML = countries.map(c => `
                <div class="country-search-item" onclick="selectCountry('${c.name.replace(/'/g, "\\'")}')">
                    <span class="flag-mini">${c.flagEmoji}</span>
                    <div class="country-info-mini">
                        <span class="name">${c.name}</span>
                        <span class="capital">${c.capital}</span>
                    </div>
                </div>
            `).join('');
        }

        async function selectCountry(name) {
            document.getElementById('countrySearchResults').style.display = 'none';
            document.getElementById('countryPlaceholder').style.display = 'none';
            document.getElementById('countryLoadingState').style.display = 'flex';
            document.getElementById('countryDetailsContent').style.display = 'none';
            
            try {
                const res = await fetch(`/Todo/GetCountryDetails?name=${encodeURIComponent(name)}`);
                if (!res.ok) throw new Error("Country not found");
                
                const data = await res.json();
                
                if (data && data.name) {
                    renderCountryDetails(data);
                    // Also update summary card
                    document.getElementById('summaryCountryName').textContent = data.name;
                    document.getElementById('summaryCountryMeta').textContent = `${data.flagEmoji} ${data.capital} ‚Ä¢ ${data.region}`;
                    const card = document.querySelector('.insight-card.country');
                    if (card) card.classList.remove('loading');
                } else {
                    throw new Error("Invalid country data");
                }
            } catch (e) {
                console.error("Failed to load country details:", e);
                const container = document.getElementById('countryDetailsContent');
                container.innerHTML = `
                    <div style="text-align:center; padding: 3rem 1rem; color: rgba(255,255,255,0.6);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîé</div>
                        <h3>Country Not Found</h3>
                        <p>We couldn't retrieve details for "${name}". Please try a different name.</p>
                        <button onclick="document.getElementById('countryPlaceholder').style.display='flex'; document.getElementById('countryDetailsContent').style.display='none';" class="btn-primary-sm" style="margin-top:1rem;">Back to Search</button>
                    </div>
                `;
            } finally {
                document.getElementById('countryLoadingState').style.display = 'none';
                document.getElementById('countryDetailsContent').style.display = 'block';
            }
        }

        let countryMap = null;

    function renderCountryDetails(c) {
        const container = document.getElementById('countryDetailsContent');
        if (!container) return;

        // --- Helper: Validate Data ---
        // Returns false if value is missing, empty, or a known fallback
        const isValid = (val) => {
            if (!val) return false;
            if (Array.isArray(val) && val.length === 0) return false;
            const s = String(val).trim().toLowerCase();
            const invalids = ["n/a", "not officially defined", "data not publicly available", "unknown name", "pending", "undefined"];
            return !invalids.includes(s);
        };

        // --- Helper: Render Row ---
        // Renders a detail row only if the value is valid
        const renderRow = (label, value, isHtml = false, capitalizeClass = "") => {
            if (!isValid(value)) return "";
            // Special check for array strings (like invalid fallback in list)
            if (Array.isArray(value) && value.some(v => !isValid(v))) return ""; 
            
            return `<div class="detail-row"><span>${label}</span> ${isHtml ? value : `<strong class="${capitalizeClass}">${value}</strong>`}</div>`;
        };

        // --- Data Preparation ---
        const currs = Object.entries(c.currencies).map(([code, info]) => `${info.name || info.item1} (${info.symbol || info.item2 || code})`).join(', ');
        const langs = c.languages.filter(l => isValid(l)).join(', ');
        const pop = isValid(c.population) ? new Intl.NumberFormat().format(c.population) : "";
        const area = isValid(c.area) ? new Intl.NumberFormat().format(c.area) : "";
        const density = isValid(c.populationDensity) ? new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(c.populationDensity) : "";
        
        let motto = "N/A";
        const mottoMatch = c.wikipediaSummary.match(/motto is [\"']?([^\"\'.]+)[\"']?/i) || c.wikipediaSummary.match(/[\"\']([^\"\']+)[\"\'] is the national motto/i);
        if (mottoMatch) motto = mottoMatch[1];
        
        // Use backend motto if valid, otherwise regex match, otherwise N/A (which will be hidden)
        const finalMotto = isValid(c.nationalMotto) ? c.nationalMotto : (isValid(motto) ? motto : "");

        // --- Build Sections ---
        
        // 1. Geography
        let geoContent = "";
        geoContent += renderRow("Total Area", area ? `${area} km¬≤` : "");
        geoContent += renderRow("Coordinates", (c.latitude && c.longitude) ? `${c.latitude.toFixed(2)}, ${c.longitude.toFixed(2)}` : "");
        geoContent += renderRow("Region", c.region);
        geoContent += renderRow("Sub-region", c.subregion);
        geoContent += renderRow("Continents", c.continents.join(', '));
        
        // Borders (Special rendering)
        let borderContent = "";
        if (c.borderCountryNames && c.borderCountryNames.length > 0) {
             borderContent = c.borderCountryNames.map(b => `<span class="border-pill">${b}</span>`).join('');
        }
        
        // Only show borders section if we have borders OR explicit landlocked context
        let bordersHtml = "";
        if (borderContent && borderContent.indexOf('Data unavailable') === -1) {
             bordersHtml = `
             <div class="borders-section mt-3">
                <span>Borders & Neighbors</span>
                <div class="border-pills">${borderContent}</div>
             </div>`;
        } else if (c.isLandlocked) {
             // Keep landlocked status visible as it is a key geo feature
             bordersHtml = `
             <div class="borders-section mt-3">
                <span>Geography Status</span>
                <div class="border-pills"><em>Landlocked</em></div>
             </div>`;
        } else if (!borderContent && !c.isLandlocked) {
             bordersHtml = `
             <div class="borders-section mt-3">
                <span>Geography Status</span>
                <div class="border-pills"><em>Island / Coastal</em></div>
             </div>`;
        }

        const geoSection = `
            <div class="country-accordion open" id="accGeo">
                <div class="accordion-header" onclick="toggleAccordion('accGeo')">
                    <h3><i class="icon">üß≠</i> Geography & Map</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="country-map-container" id="countryMap"></div>
                    <div class="info-group">
                        ${geoContent}
                        ${bordersHtml}
                    </div>
                </div>
            </div>`;

        // 2. Climate
        let climateRows = "";
        climateRows += renderRow("Climate Type", c.climateType);
        climateRows += renderRow("Avg Temperature", c.averageTemperature);
        climateRows += renderRow("Natural Resources", c.naturalResources);
        
        const climateSection = climateRows ? `
            <div class="country-accordion" id="accClimate">
                <div class="accordion-header" onclick="toggleAccordion('accClimate')">
                    <h3><i class="icon">‚õÖ</i> Climate & Environment</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${climateRows}</div>
                </div>
            </div>` : "";

        // 3. Demographics
        let demoRows = "";
        demoRows += renderRow("Total Population", pop);
        demoRows += renderRow("Pop. Density", density ? `${density} / km¬≤` : "");
        demoRows += renderRow("Religions", c.religions);
        demoRows += renderRow("Languages", langs);
        demoRows += renderRow("Demonym", c.demonym);
        
        const demoSection = demoRows ? `
            <div class="country-accordion" id="accDemo">
                <div class="accordion-header" onclick="toggleAccordion('accDemo')">
                    <h3><i class="icon">üë•</i> Demographics & Culture</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${demoRows}</div>
                </div>
            </div>` : "";

        // 4. Economy
        let econRows = "";
        econRows += renderRow("Total GDP", c.gdp);
        econRows += renderRow("Currencies", currs);
        econRows += renderRow("Major Industries", c.majorIndustries);
        
        // Infra
        let infraRows = "";
        infraRows += renderRow("Electricity", (isValid(c.electricityVoltage) || isValid(c.electricityPlugTypes)) ? `${c.electricityVoltage}, ${c.electricityPlugTypes}` : "");
        infraRows += renderRow("Driving Side", c.drivingSide, false, "text-capitalize");
        infraRows += renderRow("Calling Code", c.callingCode);
        infraRows += renderRow("Domain (TLD)", c.internetDomains && c.internetDomains.length > 0 ? c.internetDomains.join(', ') : "");

        const econSection = (econRows || infraRows) ? `
             <div class="country-accordion" id="accEcon">
                <div class="accordion-header" onclick="toggleAccordion('accEcon')">
                    <h3><i class="icon">üí∞</i> Economy & Infrastructure</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    ${econRows ? `<div class="info-group mb-3">${econRows}</div>` : ""}
                    ${infraRows ? `<div class="info-group">${infraRows}</div>` : ""}
                </div>
            </div>` : "";

        // 5. Culture
        let cultureRows = "";
        cultureRows += renderRow("National Anthem", c.nationalAnthem);
        cultureRows += renderRow("National Animal", c.nationalAnimal);
        cultureRows += renderRow("National Sport", c.nationalSport);
        
        const cultureSection = cultureRows ? `
            <div class="country-accordion" id="accCulture">
                <div class="accordion-header" onclick="toggleAccordion('accCulture')">
                    <h3><i class="icon">üé®</i> Culture & Identity</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${cultureRows}</div>
                </div>
            </div>` : "";
            
        // 6. Global & Extra
        let globalRows = "";
        
        // Rankings
        if (c.globalRankings && Object.keys(c.globalRankings).length > 0) {
            const rankingHtml = Object.entries(c.globalRankings).map(([k, v]) => `<div class="small"><strong>${k}:</strong> ${v}</div>`).join('');
            globalRows += `<div class="detail-row"><span>Global Rankings</span> <div>${rankingHtml}</div></div>`;
        }
        
        // Orgs
        if (c.internationalOrganizations && c.internationalOrganizations.length > 0 && isValid(c.internationalOrganizations[0])) { 
            const orgsHtml = c.internationalOrganizations.map(o => `<span class="pill-sm">${o}</span>`).join('');
            globalRows += `<div class="detail-row"><span>Organizations</span> <div class="scroll-pills">${orgsHtml}</div></div>`;
        }
        
        // Google Maps
        if (isValid(c.googleMapsUrl)) {
             globalRows += `<div class="detail-row"><span>Google Maps</span> <a href="${c.googleMapsUrl}" target="_blank" class="btn-primary-sm" style="display:inline-block; margin-top:0;">Navigate External ‚Üó</a></div>`;
        }

        const globalSection = globalRows ? `
            <div class="country-accordion" id="accAdd">
                <div class="accordion-header" onclick="toggleAccordion('accAdd')">
                    <h3><i class="icon">‚ú®</i> Global Standings & Insight</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${globalRows}</div>
                </div>
            </div>` : "";


        // --- Final Assembly ---
        container.innerHTML = `
            <div class="country-header-premium">
                <div class="flag-hero">
                    <img src="${c.flagUrl}" alt="${c.name} Flag" class="flag-img-big" />
                </div>
                <div class="header-text">
                    <h1>${c.name} ${c.flagEmoji}</h1>
                    <p class="official-name">${c.officialName}</p>
                    <div class="quick-stats-pills">
                        ${isValid(c.capital) ? `<span class="stat-pill">üìç ${c.capital}</span>` : ""}
                        <span class="stat-pill">üÜî ${c.isoCode} ${c.isoCodeAlpha3 ? `/ ${c.isoCodeAlpha3}` : ""}</span>
                        <span class="stat-pill">${c.isLandlocked ? 'üèîÔ∏è Landlocked' : 'üåä Coastal'}</span>
                        ${finalMotto ? `<span class="stat-pill motto-pill">üí¨ ${finalMotto}</span>` : ""}
                    </div>
                </div>
            </div>

            <div class="country-summary-box">
                <h3>About ${c.name}</h3>
                <p class="wiki-extract">${c.wikipediaSummary || 'Fetching detailed historical and political summary...'}</p>
            </div>

            ${geoSection}
            ${climateSection}
            ${demoSection}
            ${econSection}
            ${cultureSection}
            ${globalSection}
        `;

        // Init Map after DOM update
        if (c.latitude && c.longitude) {
            setTimeout(() => initCountryMap(c.latitude, c.longitude, c.name), 100);
        }
    }

        function toggleAccordion(id) {
            const acc = document.getElementById(id);
            if (acc) {
                const isOpen = acc.classList.contains('open');
                // Close others if you want, but user might want multiple open
                // For now just toggle
                acc.classList.toggle('open');
                
                // If opening geography, ensure map resizes
                if (id === 'accGeo' && !isOpen) {
                    setTimeout(() => { if(countryMap) countryMap.invalidateSize(); }, 310);
                }
            }
        }

        function initCountryMap(lat, lng, name) {
            if (countryMap) {
                countryMap.remove();
            }
            
            // Fix Leaflet's default icon path issues by pointing to local assets
            delete L.Icon.Default.prototype._getIconUrl;
            L.Icon.Default.mergeOptions({
                iconRetinaUrl: '/lib/leaflet/images/marker-icon-2x.png',
                iconUrl: '/lib/leaflet/images/marker-icon.png',
                shadowUrl: '/lib/leaflet/images/marker-shadow.png',
            });
            
            countryMap = L.map('countryMap').setView([lat, lng], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(countryMap);

            L.marker([lat, lng]).addTo(countryMap)
                .bindPopup(name)
                .openPopup();
            
            // Fix map resize inside dynamic content
            setTimeout(() => countryMap.invalidateSize(), 300);
        }

        // --- 9. Initialization ---
        function initializeAll() {
            console.log("=== INITIALIZING DASHBOARD ===");
            initDashboard();
            startConverterClocks();
            updateWorldClocks();
            startLocalClock();
            console.log("=== INITIALIZATION COMPLETE ===");
        }

        // Run immediately if DOM is already loaded, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAll);
        } else {
            // DOM is already loaded, run immediately
            initializeAll();
        }
    </script>
}
