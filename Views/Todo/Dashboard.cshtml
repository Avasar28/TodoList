@model TodoListApp.ViewModels.DashboardViewModel

@{
    ViewData["Title"] = "Real-time Dashboard";
}

<!-- Leaflet for Country Maps -->
<!-- Leaflet for Country Maps (Local) -->
<link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />
<script src="~/lib/leaflet/leaflet.js"></script>

<style>
    /* --- Country Explorer Expanded Styles --- */
    .country-summary-box {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        animation: fadeInSlide 0.6s ease-out;
    }

    .country-summary-box h3 {
        font-size: 1.15rem;
        color: #a5b4fc;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-top: 0;
        font-weight: 600;
    }

    .wiki-extract {
        font-size: 0.98rem;
        line-height: 1.75;
        color: rgba(255, 255, 255, 0.85);
        font-style: italic;
        margin-bottom: 0;
    }

    .motto-pill {
        background: rgba(245, 158, 11, 0.15) !important;
        color: #fbbf24 !important;
        border: 1px solid rgba(245, 158, 11, 0.3) !important;
    }

    .administration-note {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Map Styling */
    .country-map-container {
        height: 300px;
        width: 100%;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 10;
        overflow: hidden;
    }

    .info-group .icon {
        font-style: normal;
        margin-right: 0.5rem;
    }

    .places-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .place-tag {
        background: rgba(165, 180, 252, 0.1);
        color: #a5b4fc;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        border: 1px solid rgba(165, 180, 252, 0.2);
    }

    /* Accordion Styles */
    .country-accordion {
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .country-accordion.open {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(165, 180, 252, 0.2);
    }

    .accordion-header {
        padding: 1.25rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
    }

    .accordion-header:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .accordion-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: #a5b4fc;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .accordion-icon {
        font-size: 0.8rem;
        transition: transform 0.3s ease;
        opacity: 0.6;
    }

    .country-accordion.open .accordion-icon {
        transform: rotate(180deg);
    }

    .accordion-content {
        padding: 0 1.5rem 1.5rem 1.5rem;
        display: none;
        animation: slideDown 0.3s ease-out;
    }

    .country-accordion.open .accordion-content {
        display: block;
    }

    @@keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Insight Grid Layout (Text Only) --- */
    .news-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    /* --- Insight-Based News Cards (The Redesign) --- */
    .news-item-card.insight-mode {
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        min-height: 240px; /* Consistent height for grid alignment */
        justify-content: space-between;
    }

    .news-item-card.insight-mode:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(129, 140, 248, 0.4);
        transform: translateY(-5px);
        box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.4);
    }

    /* Insight Tags & Badges */
    .news-tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 1rem;
    }

    .insight-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-category { background: rgba(129, 140, 248, 0.15); color: #a5b4fc; border: 1px solid rgba(129, 140, 248, 0.3); }
    .badge-location { background: rgba(255, 255, 255, 0.08); color: #e2e8f0; border: 1px solid rgba(255, 255, 255, 0.1); }
    
    /* Sentiment Indicators */
    .badge-sentiment {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-sentiment.positive { color: #4ade80; background: rgba(74, 222, 128, 0.1); }
    .badge-sentiment.negative { color: #f87171; background: rgba(248, 113, 113, 0.1); }
    .badge-sentiment.neutral { color: #94a3b8; background: rgba(148, 163, 184, 0.1); }

    .sentiment-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
    }
    .positive .sentiment-dot { background: #4ade80; box-shadow: 0 0 8px #4ade80; }
    .negative .sentiment-dot { background: #f87171; box-shadow: 0 0 8px #f87171; }
    .neutral .sentiment-dot { background: #94a3b8; }

    .news-headline-insight {
        font-size: 1.15rem;
        font-weight: 700;
        line-height: 1.4;
        color: #f8fafc;
        margin: 0 0 0.75rem 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .news-summary-insight {
        font-size: 0.95rem;
        color: #cbd5e1;
        line-height: 1.6;
        margin-bottom: 1.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .news-footer-insight {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .source-meta {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .source-favicon-mini {
        width: 14px;
        height: 14px;
        opacity: 0.8;
    }

    .source-name-mini {
        font-size: 0.75rem;
        color: #94a3b8;
        font-weight: 600;
    }

    .date-meta {
        font-size: 0.75rem;
        color: #64748b;
    }
    /* --- Details Panel & Overlay System --- */
    .details-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .details-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .details-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -45%) scale(0.95);
        width: 90%;
        max-height: 85vh;
        background: #1e293b;
        background: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
    }

    .details-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .panel-header {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(255, 255, 255, 0.02);
    }

    .panel-header h2 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #fff; }

    .close-panel {
        background: rgba(255, 255, 255, 0.05);
        border: none;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .close-panel:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

    .panel-content {
        padding: 2rem;
        overflow-y: auto;
        flex: 1;
    }

    /* Article Reader Skin */
    .article-header { margin-bottom: 2rem; }
    .article-meta { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; font-size: 0.85rem; }
    .source-badge { color: #818cf8; font-weight: 700; text-transform: uppercase; }
    .date-text { color: rgba(255, 255, 255, 0.4); }
    .article-header h1 { font-size: 2.5rem; line-height: 1.2; font-weight: 800; color: #fff; margin: 0; }
    
    .article-body { font-size: 1.15rem; line-height: 1.8; color: rgba(255, 255, 255, 0.85); max-width: 800px; }
    .article-loading { text-align: center; padding: 4rem 0; opacity: 0.7; }
    .article-footer { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.05); }
</style>

<div class="dashboard-container centered-view">
<!-- Top Status Strip -->
    <div class="dashboard-status-strip">
        <div class="status-greeting">
            <h2 id="dynamicGreeting">Good Evening, @Model.UserName</h2>
            <span class="status-date" id="currentDateDisplay">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</span>
        </div>
        
        <div class="status-location-group">
            <div class="status-pill location-pill">
                <span class="loc-icon">üìç</span>
                <span class="loc-text" id="statusLocationText">@Model.SelectedCity</span>
            </div>
            <div class="status-pill time-pill">
                <span class="time-text" id="liveClock">--:--</span>
            </div>
        </div>
    </div>

    <!-- Asymmetric Dashboard Grid -->
    <div class="dashboard-grid-asymmetric">
        
        <!-- Area: Weather (Tall Atmosphere Card) -->
        <div class="grid-area-weather">
             <div class="insight-card widget-weather-live weather loading" onclick="openDetails('weather')">
                <div class="weather-live-indicator">
                    <span class="pulse-dot"></span> <span class="live-text">LIVE</span>
                </div>
                <div class="widget-content-vertical">
                    <div class="weather-visual">
                         <div class="insight-icon-huge" id="summaryWeatherIcon">@(string.IsNullOrEmpty(Model.Weather.Icon) ? "üå§Ô∏è" : Model.Weather.Icon)</div>
                    </div>
                    <div class="weather-data-primary">
                        <span class="insight-value-huge" id="summaryWeatherTemp">@(Model.Weather.Temperature > 0 ? Model.Weather.Temperature + "¬∞" : "--¬∞")</span>
                        <span class="insight-label-lg" id="summaryWeatherDesc">@Model.Weather.Description</span>
                    </div>
                     <div class="weather-meta-row">
                        <span class="meta-item" id="summaryWeatherHum">üíß @Model.Weather.Humidity%</span>
                        <span class="meta-item" id="summaryWeatherWind">üí® @Model.Weather.WindSpeed km/h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Area: Currency (Financial Card) -->
        <div class="grid-area-currency">
            <div class="insight-card widget-currency-live currency compact" onclick="openDetails('currency')">
                <div class="widget-header-row">
                    <span class="widget-title-sm">FOREX MARKET</span>
                    <span class="market-status open">OPEN</span>
                </div>
                <div class="currency-live-data">
                    <div class="pair-display">
                        <span class="curr-code">@Model.FromCurrency</span>
                        <span class="arrow">‚Üí</span>
                        <span class="curr-code">@Model.ToCurrency</span>
                    </div>
                    <div class="rate-large" id="summaryCurrencyRate">
                        @(Model.Currency.Rate > 0 ? Model.Currency.Rate.ToString("F3") : "--.---")
                    </div>
                    <div class="trend-indicator @(Model.Currency.IsUp == true ? "up" : "down")">
                         @(Model.Currency.IsUp == true ? "‚ñ≤" : "‚ñº") <span class="trend-val">0.05%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Area: Time (Digital Clock Card) -->
        <div class="grid-area-time">
            <div class="insight-card widget-time-live time compact" onclick="openDetails('time')">
                 <div class="widget-header-row">
                    <span class="widget-title-sm">WORLD CLOCK</span>
                     <span class="zone-badge">@Model.TargetTimeZone</span>
                </div>
                <div class="time-digital-display">
                    <span class="digital-time" id="summaryTargetTime">@(string.IsNullOrEmpty(Model.TimeConversion.TargetTime) ? "--:--" : Model.TimeConversion.TargetTime)</span>
                    <span class="time-diff-pill">@Model.TimeConversion.OffsetDisplay HRS</span>
                </div>
            </div>
        </div>

        <!-- Area: Holiday (Calendar Card) -->
        <div class="grid-area-holiday">
            <div class="insight-card widget-holiday-live holiday loading" id="holidayWidgetCard" onclick="openDetails('holiday')">
                <div class="widget-header-row">
                    <span class="widget-title-sm">PUBLIC HOLIDAYS</span>
                    <span class="holiday-next-pill" id="nextHolidayBadge">Loading...</span>
                </div>
                <div class="holiday-summary-content">
                    <div class="holiday-count-large" id="summaryHolidayCount">--</div>
                    <span class="holiday-label-sm" id="summaryHolidayLabel">Fetching @DateTime.Now.Year Holidays</span>
                </div>
            </div>
        </div>

        <!-- Area: Translator (Summary Widget) -->
        <div class="grid-area-translator">
            <div class="insight-card widget-translator-summary translator" onclick="openDetails('translator')">
                <div class="widget-header-row">
                    <span class="widget-title-sm">TRANSLATOR</span>
                    <span class="pulse-dot" style="background:#10b981; box-shadow:0 0 10px #10b981;"></span>
                </div>
                <div class="translator-summary-hero">
                    <div class="trans-icon-hero">üàÇÔ∏è</div>
                    <div class="trans-hero-text">
                        <span class="hero-main">Quick Translate</span>
                        <span class="hero-sub">100+ Languages</span>
                    </div>
                </div>
                <div class="trans-action-hint">
                    Click to start translating ‚Üí
                </div>
            </div>
        </div>

        <!-- Area: Country (Explorer Card) -->
        <div class="grid-area-country">
            <div class="insight-card widget-country-live country" onclick="openDetails('country')">
                <div class="country-visual-bg">
                    <div class="search-hint-overlay">
                        <span class="search-icon-lg">üîç</span>
                        <span class="search-text">Explore Global Data</span>
                    </div>
                </div>
                <div class="country-label-overlay">
                    <span class="country-name-lg" id="summaryCountryName">Country Explorer</span>
                    <span class="country-meta-sm" id="summaryCountryMeta" style="display:block; font-size:0.75rem; color:rgba(255,255,255,0.7);">Search to explore</span>
                </div>
            </div>
        </div>

        <!-- Area: News (Timeline Feed) -->

        <div class="grid-area-news">
             <div class="insight-card widget-news-feed news loading" id="newsWidgetCard" onclick="openDetails('news')">
                <div class="widget-header-feed">
                    <span class="feed-title">Live News Feed</span>
                    <span class="feed-live-dot"></span>
                </div>
                <div class="news-timeline-container">
                    <!-- Placeholder Items for Loading -->
                     <div class="timeline-item">
                        <span class="time-stamp">Now</span>
                        <div class="timeline-content">
                            <span class="category-pill-news">Headlines</span>
                            <span class="headline-text">Loading top stories for @Model.SelectedCity...</span>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time-stamp">10m</span>
                        <div class="timeline-content">
                            <span class="category-pill-news">World</span>
                            <span class="headline-text">Global market updates and breaking news...</span>
                        </div>
                    </div>
                     <div class="timeline-item">
                        <span class="time-stamp">1h</span>
                        <div class="timeline-content">
                            <span class="category-pill-news">Tech</span>
                            <span class="headline-text">Latest technology trends and updates...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Area: Emergency (SOS Widget) -->
        <div class="grid-area-emergency">
            <div class="insight-card widget-emergency emergency" onclick="openDetails('emergency')">
                <div class="widget-header-row">
                    <span class="widget-title-sm" style="color: #f87171;">EMERGENCY SOS</span>
                    <span class="pulse-dot"></span>
                </div>
                <div class="emergency-visual">
                    <div class="sos-icon">üÜò</div>
                    <span class="sos-label">Help Center</span>
                </div>
                <div class="emergency-action-hint">
                    Tap for Numbers
                </div>
            </div>
        </div>

        <!-- Area: Habit Tracker (Summary Widget) -->
        <div class="grid-area-habit">
             <div class="insight-card widget-habit-tracker habit" id="habitWidget" onclick="openDetails('habit')">
                <div class="habit-summary-content">
                    <div class="habit-summary-header">
                        <span class="widget-title-sm">DAILY HABITS</span>
                        <div class="summary-badges">
                            <span class="badge-pill" id="habitSummaryCount">0 Active</span>
                        </div>
                    </div>
                    
                    <div class="habit-summary-hero">
                        <div class="hero-left">
                            <span class="hero-stat-label">Best Streak</span>
                            <span class="hero-stat-val" id="habitSummaryBest">0</span>
                        </div>
                         <div class="hero-right">
                             <span class="hero-stat-label">Today's Progress</span>
                            <div class="mini-progress-bar">
                                <div class="mini-progress-fill" id="habitSummaryProgress" style="width: 0%"></div>
                            </div>
                         </div>
                    </div>

                    <div class="habit-summary-footer">
                        <span class="click-hint">Click to manage habits & streaks ‚Üí</span>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Habit Tracker Details Panel -->
<div class="details-panel" id="habitDetails" style="max-width: 600px;">
    <div class="panel-header">
        <h2>My Habits</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        
        <div class="habit-controls-panel">
            <input type="text" id="newHabitInput" placeholder="Add a new habit..." class="form-control" />
            <button id="addHabitBtn" class="btn-primary">Add</button>
        </div>

        <div class="habit-list-container" id="habitList" style="margin-top: 1.5rem;">
            <!-- Items go here -->
        </div>

        <div id="habitEmptyState" class="empty-state" style="display:none; padding: 3rem 1rem;">
             <div class="empty-icon">üå±</div>
            <span>Start small. Add your first habit above!</span>
        </div>

    </div>
</div>

<!-- Holiday Details Panel -->
<div class="details-panel" id="holidayDetails" style="max-width: 800px;">
    <div class="panel-header">
        <div class="header-info">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h2>Holiday Calendar</h2>
                <div class="view-toggle-pills">
                    <button class="view-pill active" id="holidayListViewBtn" onclick="HolidayWidget.setView('list')" title="List View">üìã</button>
                    <button class="view-pill" id="holidayCalendarViewBtn" onclick="HolidayWidget.setView('calendar')" title="Calendar View">üìÖ</button>
                </div>
            </div>
            <p class="text-muted small">Explore public holidays worldwide</p>
        </div>
        <div class="calendar-nav-controls" id="holidayCalendarNav" style="display: none; align-items: center; gap: 0.75rem;">
            <button class="nav-btn-glass" onclick="HolidayWidget.previousMonth()">‚Äπ</button>
            <span class="current-month-year" id="holidayCalendarMonthYear" style="min-width: 140px; text-align: center; font-weight: 600; color: #a5b4fc;">January 2026</span>
            <button class="nav-btn-glass" onclick="HolidayWidget.nextMonth()">‚Ä∫</button>
        </div>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content holiday-expanded-container">
        <div class="holiday-search-section">
            <div class="input-with-button">
                 <div class="custom-currency-select" style="width: 100%;">
                    <div class="select-header" onclick="focusInput('holidayCountrySearch')">
                        <span class="select-icon">üåç</span>
                        <input type="text" class="btn-search-input" id="holidayCountrySearch" placeholder="Search country..." autocomplete="off" />
                    </div>
                    <div class="custom-options" id="holidayCountryOptions">
                        <!-- Populated via JS -->
                    </div>
                    <select id="holidayCountrySelect" style="display: none;"></select>
                </div>
            </div>
            <div class="year-selector">
                <select id="holidayYearSelect" class="form-control">
                    @for (int y = DateTime.Now.Year - 2; y <= DateTime.Now.Year + 5; y++)
                    {
                        <option value="@y" selected="@(y == DateTime.Now.Year)">@y</option>
                    }
                </select>
            </div>
        </div>
        
        <!-- AI Suggestions Section -->
        <div id="aiHolidaySuggestions" class="ai-suggestions-container" style="display: none;">
            <!-- Injected via JS -->
        </div>

        <div id="holidayLoadingState" class="news-loading-state" style="display: none;">
            <div class="spinner"></div>
            <p>Fetching holiday data...</p>
        </div>

        <div id="holidayList" class="holiday-list-grid">
            <!-- Items injected via JS -->
            <div class="initial-search-state">
                <div class="search-icon-placeholder">üìÖ</div>
                <p>Select a country to view its public holidays</p>
            </div>
        </div>
    </div>
</div>

<!-- Details Overlay & Panels -->
<div class="details-overlay" id="detailsOverlay" onclick="closeDetails()"></div>

<!-- Weather Details Panel -->
<div class="details-panel" id="weatherDetails" style="max-width: 800px;">
    <div class="panel-header">
        <h2>Detailed Weather</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content weather-expanded">
        <!-- 1. Location Details -->
        <div class="location-header">
            <h3 id="weatherLocation">@Model.Weather.City@(string.IsNullOrEmpty(Model.Weather.District) ? "" : ", " + Model.Weather.District)</h3>
            <p id="weatherSubLocation" class="text-muted">@Model.Weather.State, @Model.Weather.Country</p>
            <p id="weatherCoords">Lat: @Model.Weather.Latitude.ToString("F4") | Lon: @Model.Weather.Longitude.ToString("F4")</p>
        </div>

        <form id="weatherSearchForm" class="detail-form">
            <div class="form-group">
                <div class="input-with-button">
                    <input type="text" id="weatherSearchInput" name="city" value="@Model.SelectedCity" class="form-control" placeholder="Search City, State or Country..." data-translate="true" data-translate-placeholder="true" />
                    <button type="submit" class="btn-primary-sm" id="weatherSearchSubmit" data-translate="true">Search</button>
                    <button type="button" class="btn-secondary-sm" id="geolocateBtn" title="Use my current location">üìç</button>
                </div>
            </div>
        </form>

        <div class="weather-grid-detailed">
            <!-- 2. Current Weather Hero -->
            <div class="weather-main-section">
                <div class="current-weather-hero">
                    <div class="hero-icon" id="panelWeatherIcon">@Model.Weather.Icon</div>
                    <div class="hero-temp" id="panelTemperature">@Model.Weather.Temperature¬∞C</div>
                    <div class="hero-desc" id="panelDescription">@Model.Weather.Description in @Model.Weather.City</div>
                </div>

                <div class="weather-metrics-grid">
                    <div class="metric-card">
                        <span class="m-label">Feels Like</span>
                        <span class="m-value" id="weatherFeelsLike">@Model.Weather.FeelsLike¬∞C</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Humidity</span>
                        <span class="m-value" id="weatherHumidity">@Model.Weather.Humidity%</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Wind</span>
                        <span class="m-value" id="weatherWind">@Model.Weather.WindSpeed km/h</span>
                        <span class="m-sub" id="weatherWindDir">Dir: @Model.Weather.WindDirection¬∞</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Visibility</span>
                        <span class="m-value" id="weatherVisibility">@Model.Weather.Visibility.ToString("F1") km</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Pressure</span>
                        <span class="m-value" id="weatherPressure">@Model.Weather.Pressure hPa</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Dew Point</span>
                        <span class="m-value" id="weatherDewPoint">@Model.Weather.DewPoint¬∞C</span>
                    </div>
                </div>
            </div>

            <!-- 4. Air Quality & UV -->
            <div class="weather-side-section">
                <div class="info-card-glass aqi-card">
                    <span class="panel-subtitle-small">Air Quality (AQI)</span>
                    <div class="aqi-display">
                        <span class="aqi-val" id="weatherAQI">@Model.Weather.AQI</span>
                        <span class="aqi-level" id="weatherAQILevel">@Model.Weather.AQILevel</span>
                    </div>
                </div>
                <div class="info-card-glass uv-card" style="margin-top: 1rem;">
                    <span class="panel-subtitle-small">UV Index</span>
                    <div class="uv-display">
                        <span class="uv-val" id="weatherUV">@Model.Weather.UVIndex</span>
                        <span class="uv-risk" id="weatherUVRisk">@Model.Weather.UVRisk</span>
                    </div>
                </div>

                <!-- 5. Sun & Moon Data -->
                <div class="info-card-glass astro-card" style="margin-top: 1rem;">
                    <span class="panel-subtitle-small">Sun & Moon</span>
                    <div class="astro-grid">
                        <div class="astro-item">
                            <span>üåÖ Sunrise</span>
                            <strong id="weatherSunrise">@Model.Weather.Sunrise</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåá Sunset</span>
                            <strong id="weatherSunset">@Model.Weather.Sunset</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåô Moonrise</span>
                            <strong id="weatherMoonrise">@Model.Weather.Moonrise</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåí Moonset</span>
                            <strong id="weatherMoonset">@Model.Weather.Moonset</strong>
                        </div>
                    </div>
                    <hr class="glass-hr">
                    <div class="moon-phase-details">
                        <div class="moon-img-container">
                            <span class="moon-icon-huge" id="weatherMoonIcon">@Model.Weather.MoonIcon</span>
                        </div>
                        <div class="moon-text">
                            <span>Moon Phase</span>
                            <strong id="weatherMoonPhase">@Model.Weather.MoonPhase</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 5-Day Forecast -->
        <h3 class="panel-subtitle">5-Day Forecast</h3>
        <div class="weather-forecast-list" id="panelForecastList">
            @foreach (var day in Model.Weather.Forecasts)
            {
                <div class="forecast-item">
                    <span class="day-name">@day.Date</span>
                    <span class="day-icon">@day.Icon</span>
                    <div class="day-temps">
                        <span class="max">@Math.Round(day.MaxTemp)¬∞</span>
                        <span class="min">@Math.Round(day.MinTemp)¬∞</span>
                    </div>
                    <span class="day-desc">@day.Description</span>
                </div>
            }
        </div>
    </div>
</div>

<!-- Currency Details Panel -->
<div class="details-panel" id="currencyDetails">
    <div class="panel-header">
        <h2>Currency Converter</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <form id="currencyForm" class="detail-form">
            <div class="currency-converter-card">
                <div class="form-group">
                    <label data-translate="true">Amount to Convert</label>
                    <input type="number" id="convertAmount" value="1" class="form-control" step="any" />
                </div>
                
                <div class="currency-horizontal-row">
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">From</span>
                        <div class="custom-currency-select" id="fromCurrencyWrapper">
                            <div class="select-header" onclick="focusInput('fromSearch')">
                                <span class="select-icon">üí∞</span>
                                <input type="text" class="btn-search-input" id="fromSearch" placeholder="Search..." data-target="fromCurrencySelect" autocomplete="off" />
                            </div>
                            <div class="custom-options" id="fromOptions">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    var info = TodoListApp.Services.ExternalApiService.GetCurrencyInfo(curr);
                                    <div class="option-item" data-value="@curr" data-text="@info.Flag @curr - @info.Country" data-country="@info.Country">
                                        <span class="opt-flag">@info.Flag</span>
                                        <span class="opt-code" data-no-translate="true">@curr</span>
                                        <span class="opt-country">@info.Country</span>
                                    </div>
                                }
                            </div>
                            <select id="fromCurrencySelect" name="fromCurrency" style="display: none;">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    <option value="@curr" selected="@(curr == Model.FromCurrency)">@curr</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <button type="button" class="central-swap-circle" id="swapCurrencies" title="Swap currencies">‚áÑ</button>
                    
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">To</span>
                        <div class="custom-currency-select" id="toCurrencyWrapper">
                            <div class="select-header" onclick="focusInput('toSearch')">
                                <span class="select-icon">üéØ</span>
                                <input type="text" class="btn-search-input" id="toSearch" placeholder="Search..." data-target="toCurrencySelect" autocomplete="off" />
                            </div>
                            <div class="custom-options" id="toOptions">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    var info = TodoListApp.Services.ExternalApiService.GetCurrencyInfo(curr);
                                    <div class="option-item" data-value="@curr" data-text="@info.Flag @curr - @info.Country" data-country="@info.Country">
                                        <span class="opt-flag">@info.Flag</span>
                                        <span class="opt-code" data-no-translate="true">@curr</span>
                                        <span class="opt-country">@info.Country</span>
                                    </div>
                                }
                            </div>
                            <select id="toCurrencySelect" name="toCurrency" style="display: none;">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    <option value="@curr" selected="@(curr == Model.ToCurrency)">@curr</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="result-display">
                    <div class="result-header" data-translate="true">Converted Amount</div>
                    <div class="conversion-result-row">
                        <div id="conversionResult" class="conversion-val">@Model.Currency.Rate</div>
                        <div id="rateMovement" class="movement-badge @(Model.Currency.IsUp == null ? "d-none" : (Model.Currency.IsUp == true ? "up" : "down"))">
                            @(Model.Currency.IsUp == true ? "‚Üë" : "‚Üì")
                        </div>
                    </div>
                    <div id="baseRateInfo" class="rate-info">1 @Model.Currency.From = @Model.Currency.Rate @Model.Currency.To</div>
                    <div id="currencyTimestamp" class="sync-time">Last Synced: @Model.Currency.LastUpdated</div>
                </div>
            </div>
        </form>

        <div class="currency-stats">
            <div class="chart-box">
                <h3 class="panel-subtitle" data-translate="true">Market History (Last 7 Days)</h3>
                <div class="chart-container-large">
                    <canvas id="currencyChartFull"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Emergency Details Panel -->
<div class="details-panel" id="emergencyDetails">
    <div class="panel-header">
        <h2 style="color: #f87171;">Emergency Numbers</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <div class="emergency-search-hero">
            <input type="text" id="emergencySearchInput" placeholder="Type country name..." class="form-control" autocomplete="off" />
        </div>
        
        <div class="emergency-results-grid" id="emergencyResults">
            <!-- Results populate here -->
        </div>
    </div>
</div>

<!-- Time Details Panel -->
<div class="details-panel" id="timeDetails">
    <div class="panel-header">
        <h2 data-translate="true">World Clock & Converter</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <form id="timeForm" class="detail-form">
            <div class="header-controls">
                <div class="format-toggle">
                    <span class="toggle-label" data-translate="true">12H</span>
                    <label class="switch">
                        <input type="checkbox" id="conversionFormatToggle" onchange="handleConversionFormatChange()">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-label" data-translate="true">24H</span>
                </div>
            </div>

            <div class="currency-converter-card">
                
                <div class="currency-horizontal-row">
                    <div class="currency-btn-item">
                        <span class="btn-mini-label" data-translate="true">Source Zone</span>
                        <div class="custom-currency-select" id="sourceTimeWrapper">
                            <div class="select-header" onclick="focusInput('sourceTimeSearch')">
                                <span class="select-icon">üìç</span>
                                <input type="text" class="btn-search-input" id="sourceTimeSearch" placeholder="Search city/country..." autocomplete="off" />
                            </div>
                            <div class="custom-options" id="sourceTimeOptions">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <div class="option-item opt-item-layout" data-value="@tz.Id" data-text="@tz.Name" data-full="@tz.FullName">
                                        <div class="opt-main">
                                            <span class="opt-city">@tz.Name</span>
                                            <span class="opt-meta">@tz.Abbr</span>
                                        </div>
                                        <span class="opt-offset">@tz.Offset</span>
                                    </div>
                                }
                            </div>
                            <select id="sourceTimeSelect" name="sourceTime" style="display: none;">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <option value="@tz.Id" selected="@(tz.Id == Model.SourceTimeZone)">@tz.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <button type="button" class="central-swap-circle" id="swapTimeZones" title="Swap timezones">‚áÑ</button>

                    <div class="currency-btn-item">
                        <span class="btn-mini-label" data-translate="true">Target Zone</span>
                        <div class="custom-currency-select" id="targetTimeWrapper">
                            <div class="select-header" onclick="focusInput('targetTimeSearch')">
                                <span class="select-icon">üåè</span>
                                <input type="text" class="btn-search-input" id="targetTimeSearch" placeholder="Search city/country..." autocomplete="off" />
                            </div>
                            <div class="custom-options" id="targetTimeOptions">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <div class="option-item opt-item-layout" data-value="@tz.Id" data-text="@tz.Name" data-full="@tz.FullName">
                                        <div class="opt-main">
                                            <span class="opt-city">@tz.Name</span>
                                            <span class="opt-meta">@tz.Abbr</span>
                                        </div>
                                        <span class="opt-offset">@tz.Offset</span>
                                    </div>
                                }
                            </div>
                            <select id="targetTimeSelect" name="targetTime" style="display: none;">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <option value="@tz.Id" selected="@(tz.Id == Model.TargetTimeZone)">@tz.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="result-display">
                    <div class="result-header" data-translate="true">Converted Time</div>
                    <div class="conversion-result-row">
                        <div id="timeResultVal" class="conversion-val" data-no-translate="true">@Model.TimeConversion.TargetTime</div>
                        <div id="timeAbbr" class="tz-abbr-badge">@Model.TimeConversion.TargetAbbr</div>
                        <div id="timeDayChange" class="day-change-badge @(Model.TimeConversion.DayChange == "Same Day" ? "d-none" : "")" data-translate="true">@Model.TimeConversion.DayChange</div>
                    </div>
                    <div id="timeOffsetInfo" class="rate-info" data-translate="true">Difference: @Model.TimeConversion.OffsetDisplay hours</div>
                </div>
            </div>
        </form>

        <h3 class="panel-subtitle" data-translate="true">Global Overview</h3>
        <div class="world-clock-list">
            <div class="clock-row">
                <span class="city" data-translate="true">New York</span>
                <span class="time" data-tz="America/New_York" data-no-translate="true">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city" data-translate="true">London</span>
                <span class="time" data-tz="Europe/London" data-no-translate="true">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city" data-translate="true">Mumbai</span>
                <span class="time" data-tz="Asia/Kolkata" data-no-translate="true">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city" data-translate="true">Tokyo</span>
                <span class="time" data-tz="Asia/Tokyo" data-no-translate="true">--:--</span>
            </div>
            <div class="clock-row">
                 <span class="city" data-translate="true">Dubai</span>
                 <span class="time" data-tz="Asia/Dubai" data-no-translate="true">--:--</span>
            </div>
        </div>
    </div>
</div>

<!-- News Details Panel (Feed) -->
<div class="details-panel" id="newsDetails" style="max-width: 900px;">
    <div class="panel-header">
        <div class="header-info">
            <h2>Local & Global News</h2>
            <p id="newsResolvedLocation" class="text-muted small">Auto-detecting location...</p>
        </div>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <!-- News Controls -->
        <div class="news-controls">
            <div class="search-bar-row">
                <div class="input-with-button">
                    <input type="text" id="newsSearchInput" class="form-control" placeholder="Search news by location or keyword..." data-translate="true" data-translate-placeholder="true" />
                    <button type="submit" class="btn-primary-sm" onclick="event.preventDefault(); refreshNewsData();" data-translate="true">Search</button>
                </div>
                <div class="sort-selector">
                    <select id="newsSortSelect" onchange="refreshNewsData()" class="form-select-sm">
                        <option value="relevance">Most Relevant</option>
                        <option value="latest">Latest News</option>
                    </select>
                </div>
            </div>
            
            <div class="category-pills" id="newsCategoryPills">
                <button class="pill active" data-category="All" data-translate="true">All</button>
                <button class="pill" data-category="World" data-translate="true">World</button>
                <button class="pill" data-category="Business" data-translate="true">Business</button>
                <button class="pill" data-category="Technology" data-translate="true">Technology</button>
                <button class="pill" data-category="Health" data-translate="true">Health</button>
                <button class="pill" data-category="Science" data-translate="true">Science</button>
                <button class="pill" data-category="Sports" data-translate="true">Sports</button>
                <button class="pill" data-category="Entertainment" data-translate="true">Entertainment</button>
            </div>
        </div>

        <!-- News Feed Container -->
        <div class="news-feed-container" id="newsFeed">
            <!-- Loading State -->
            <div class="news-loading-state">
                <div class="spinner"></div>
                <p>Fetching authentic news...</p>
            </div>
        </div>

        <div class="news-load-more-container" id="newsLoadMoreContainer" style="display: none; justify-content: center; padding: 2rem 0;">
            <button class="btn-secondary-glass" onclick="loadMoreNews()" data-translate="true">Show More Stories</button>
        </div>
    </div>
</div>

<!-- News Article Detail Page (Internal/Immersive) -->
<div class="details-panel" id="newsArticleDetails" style="max-width: 1000px; z-index: 1002;">
    <div class="panel-header">
        <button class="back-btn" onclick="backToNewsFeed()">‚Üê Back to Feed</button>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content article-reader" id="articleReaderContent">
        <div class="article-header">
            <div class="news-tags-row mb-3" id="articleBadgeRow">
                <!-- Badges will be injected here -->
            </div>
            <div class="article-meta">
                <span id="articleSource" class="source-badge">Source</span>
                <span id="articleDate" class="date-text">Date</span>
            </div>
            <h1 id="articleTitle">Article Title</h1>
        </div>
        <div id="articleImageContainer" class="article-image-full"></div>
        <div id="articleBody" class="article-body">
            <!-- Content will be injected here -->
            <div class="article-loading">
                <div class="spinner"></div>
                <p>Extracting article content for in-app reading...</p>
            </div>
        </div>
        <div class="article-footer">
            <a id="articleSourceLink" href="#" target="_blank" class="btn-secondary-sm">Read Full Story on Source Website</a>
        </div>
    </div>
</div>

<!-- Translator Details Panel -->
<div class="details-panel" id="translatorDetails" style="max-width: 900px;">
    <div class="panel-header">
        <div class="header-info">
             <h2>Language Translator</h2>
             <p class="text-muted small">AI-powered multi-language translation</p>
        </div>
        <div class="trans-mode-toggle">
            <span class="mode-label active" id="modeTextLabel" onclick="TranslatorWidget.setMode('text')">Text</span>
            <label class="switch">
                <input type="checkbox" id="transModeToggle" onchange="TranslatorWidget.toggleMode()">
                <span class="slider round"></span>
            </label>
            <span class="mode-label" id="modeConvLabel" onclick="TranslatorWidget.setMode('conversation')">Conversation</span>
        </div>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    
    <!-- Standard Text Mode -->
    <div class="panel-content translator-expanded-view" id="transTextView">
         <div class="translator-expanded-body">
             <!-- Source Side -->
             <div class="trans-side source-side">
                  <div class="details-control-row">
                      <label>From:</label>
                      <div class="custom-select-wrapper" id="sourceLangWrapper">
                            <div class="custom-select-trigger" tabindex="0">
                                <span class="selected-text" id="sourceLangLabel">Auto Detect</span>
                                <i class="arrow-icon">‚ñº</i>
                            </div>
                            <div class="custom-options">
                                <div class="search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search..." id="sourceSearch">
                                </div>
                                <div class="options-list" id="sourceOptionsList"></div>
                            </div>
                            <input type="hidden" id="transSourceLang" value="auto">
                      </div>
                  </div>
                  <div class="textarea-wrapper-expanded">
                      <textarea id="transSourceText" class="trans-textarea" placeholder="Enter text..." spellcheck="false"></textarea>
                      <button id="transMicBtn" class="tool-btn mic-btn" title="Voice Input">üé§</button>
                      <div class="trans-footer-row">
                          <span id="transDetectedLang" class="trans-detected"></span>
                          <button id="transActionBtn" class="btn-primary-sm">Translate</button>
                      </div>
                  </div>
             </div>

             <!-- Swap Column (Middle) -->
             <div class="trans-middle-control">
                  <button id="transSwapBtn" class="trans-swap-btn" title="Swap Languages">‚áÑ</button>
                  <span id="transStatus" class="trans-status-dot"></span>
             </div>

             <!-- Target Side -->
             <div class="trans-side target-side">
                  <div class="details-control-row">
                      <label>To:</label>
                      <div class="custom-select-wrapper" id="targetLangWrapper">
                            <div class="custom-select-trigger" tabindex="0">
                                <span class="selected-text" id="targetLangLabel">English</span>
                                <i class="arrow-icon">‚ñº</i>
                            </div>
                            <div class="custom-options">
                                <div class="search-container">
                                    <input type="text" class="dropdown-search" placeholder="Search..." id="targetSearch">
                                </div>
                                <div class="options-list" id="targetOptionsList"></div>
                            </div>
                            <input type="hidden" id="transTargetLang" value="en">
                      </div>
                  </div>
                  <div class="textarea-wrapper-expanded">
                      <textarea id="transTargetText" class="trans-textarea readonly" placeholder="Translation..." readonly></textarea>
                      <div class="trans-tools">
                          <button id="transCopyBtn" class="tool-btn" title="Copy">üìã</button>
                          <button id="transSpeakBtn" class="tool-btn" title="Listen">üîä</button>
                      </div>
                  </div>
             </div>
         </div>
    </div>

    <!-- Conversation Mode -->
    <div class="panel-content conversation-view" id="transConvView" style="display: none;">
        <!-- Global Conversation Controls -->
        <div class="conv-global-controls">
            <button class="icon-btn-sm" id="convMuteBtn" title="Mute Audio" onclick="TranslatorWidget.toggleMute()">
                <span id="convMuteIcon">üîä</span>
            </button>
            <span class="divider-v"></span>
            <button class="icon-btn-sm" id="convClearBtn" title="Clear History" onclick="TranslatorWidget.clearChat()">
                üóëÔ∏è
            </button>
        </div>

        <div class="conv-split-container">
            <!-- Person A (Left) -->
            <div class="conv-side" id="convSideA">
                <div class="conv-header">
                    <div class="custom-select-wrapper" id="convLangAWrapper">
                        <div class="custom-select-trigger" tabindex="0">
                            <span class="selected-text" id="convLangALabel">English</span>
                            <i class="arrow-icon">‚ñº</i>
                        </div>
                        <div class="custom-options">
                            <div class="search-container">
                                <input type="text" class="dropdown-search" placeholder="Search..." id="convSearchA">
                            </div>
                            <div class="options-list" id="convOptionsListA"></div>
                        </div>
                        <input type="hidden" id="convLangA" value="en">
                    </div>
                </div>
                
                <div class="conv-chat-area" id="convChatA">
                    <div class="conv-placeholder">Tap mic to speak...</div>
                </div>

                <div class="conv-controls">
                    <button class="conv-mic-btn" id="convMicBtnA">
                        <span class="mic-icon">üé§</span>
                        <span class="mic-status">Tap to Speak</span>
                    </button>
                </div>
            </div>

            <!-- Divider -->
            <div class="conv-divider"></div>

            <!-- Person B (Right) -->
            <div class="conv-side" id="convSideB">
                <div class="conv-header">
                    <div class="custom-select-wrapper" id="convLangBWrapper">
                        <div class="custom-select-trigger" tabindex="0">
                            <span class="selected-text" id="convLangBLabel">Spanish</span>
                            <i class="arrow-icon">‚ñº</i>
                        </div>
                        <div class="custom-options">
                            <div class="search-container">
                                <input type="text" class="dropdown-search" placeholder="Search..." id="convSearchB">
                            </div>
                            <div class="options-list" id="convOptionsListB"></div>
                        </div>
                        <input type="hidden" id="convLangB" value="es">
                    </div>
                </div>

                <div class="conv-chat-area" id="convChatB">
                    <div class="conv-placeholder">Tap mic to speak...</div>
                </div>

                <div class="conv-controls">
                    <button class="conv-mic-btn" id="convMicBtnB">
                        <span class="mic-icon">üé§</span>
                        <span class="mic-status">Tap to Speak</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Country Details Panel -->
<div class="details-panel" id="countryDetails" style="max-width: 900px;">
    <div class="panel-header">
        <div class="header-info">
            <h2>Country Explorer</h2>
            <p class="text-muted small">Global facts & information A-Z</p>
        </div>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content country-explorer">
        <div class="country-search-area">
            <div class="search-input-wrapper">
                <i class="search-icon-glass">üîç</i>
                <input type="text" id="countrySearchInput" class="form-control" placeholder="Search any country (e.g. Canada, Brazil)..." oninput="handleCountrySearchInput(this.value)" autocomplete="off" data-translate="true" data-translate-placeholder="true" />
                <div id="countrySearchResults" class="country-dropdown-glass" style="display: none;"></div>
            </div>
        </div>

        <div id="countryLoadingState" class="news-loading-state" style="display: none;">
            <div class="spinner"></div>
            <p>Fetching global data...</p>
        </div>

        <div id="countryPlaceholder" class="placeholder-empty">
            <div class="placeholder-icon">üåè</div>
            <h3 data-translate="true">Discover the World</h3>
            <p data-translate="true">Search for any country to view comprehensive details including flags, capitals, populations, and more.</p>
        </div>

        <div id="countryDetailsContent" class="country-details-view" style="display: none;">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- Widget Detail Management ---
        function openDetails(type) {
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(type + 'Details').classList.add('active');
            document.getElementById('detailsOverlay').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scroll

            // Load chart if it's currency
            if (type === 'currency') {
                loadCurrencyHistory();
            }
            
            if (type === 'weather') {
                // Check if we should auto-geolocate
                // (optional: can be done automatically on load, but let's link it to the button too)
            }
        }

        function closeDetails() {
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('detailsOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }


        // --- 1. World Clocks ---
        function updateWorldClocks() {
            const clocks = document.querySelectorAll('.time[data-tz]');
            const now = new Date();
            clocks.forEach(clock => {
                const tz = clock.getAttribute('data-tz');
                try {
                    const timeString = now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit' });
                    clock.textContent = timeString;
                } catch (e) {
                    console.error("Invalid Timezone", tz);
                }
            });
        }
        setInterval(updateWorldClocks, 1000);
        updateWorldClocks();

        // --- 2. Currency Chart (Detailed) ---
        const ctxFull = document.getElementById('currencyChartFull')?.getContext('2d');
        let currencyChartFull;

        async function loadCurrencyHistory() {
            if (!ctxFull) return;
            const from = fromSelect?.value || '@Model.FromCurrency';
            const to = toSelect?.value || '@Model.ToCurrency';
            
            try {
                // Specifically request 7 days of history
                const res = await fetch(`/Todo/GetCurrencyHistoryJson?from=${from}&to=${to}&days=7`);
                const data = await res.json();
                
                if(data.labels && data.values) {
                    if (currencyChartFull) currencyChartFull.destroy();
                    
                    currencyChartFull = new Chart(ctxFull, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: `${from} to ${to} (7D Trend)`,
                                data: data.values,
                                borderColor: '#818cf8',
                                backgroundColor: 'rgba(129, 140, 248, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#818cf8',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', font: { size: 12 } } },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgba(255,255,255,0.1)',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, minRotation: 45 },
                                    grid: { display: false }
                                },
                                y: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load chart", e);
            }
        }

        // --- 3. Ticking Converter Clocks (Summary & Panel) ---
        function startConverterClocks() {
            const displays = [
                document.getElementById('summaryTargetTime'),
                document.getElementById('panelTargetTime')
            ];

            function update() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                
                displays.forEach(display => {
                    if(!display) return;
                    const offsetMinutes = parseFloat(display.getAttribute('data-offset'));
                    if(isNaN(offsetMinutes)) return;
                    const targetTime = new Date(utc + (offsetMinutes * 60000));
                    display.textContent = targetTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                });
            }
            
            setInterval(update, 1000);
            update();
        }
        // --- 4. Auto-Open Panels on Reload ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('city')) openDetails('weather');
            if (params.has('fromCurrency') || params.has('toCurrency')) openDetails('currency');
            if (params.has('sourceTime') || params.has('targetTime')) openDetails('time');
        });

        // --- 5. Geolocation & AJAX Search ---
        const geolocateBtn = document.getElementById('geolocateBtn');
        const weatherForm = document.getElementById('weatherSearchForm');
        const weatherInput = document.getElementById('weatherSearchInput');
        const weatherSubmit = document.getElementById('weatherSearchSubmit');

        if (weatherForm) {
            weatherForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const city = weatherInput.value.trim();
                if (!city) return;

                weatherSubmit.disabled = true;
                weatherSubmit.textContent = 'Searching...';

                try {
                    const response = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(city)}`);
                    const data = await response.json();
                    if (data.description === "City not found") {
                        alert("City not found. Please try a different name.");
                    } else {
                        updateWeatherUI(data);
                    }
                } catch (e) {
                    alert("Failed to fetch weather data.");
                } finally {
                    weatherSubmit.disabled = false;
                    weatherSubmit.textContent = 'Search';
                }
            });
        }

        if (geolocateBtn) {
            geolocateBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    geolocateBtn.classList.add('loading');
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                const response = await fetch(`/Todo/GetWeatherByCoordsJson?lat=${latitude}&lon=${longitude}`);
                                const data = await response.json();
                                updateWeatherUI(data);
                                geolocateBtn.classList.remove('loading');
                            } catch (e) {
                                alert("Failed to fetch weather for your location.");
                                geolocateBtn.classList.remove('loading');
                            }
                        },
                        (error) => {
                            alert("Location access denied. Please use manual search.");
                            geolocateBtn.classList.remove('loading');
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            });
        }

        function updateWeatherUI(data) {
            // 1. Update Layout/Header
            let title = data.city || "My Location";
            if (data.localArea && data.localArea !== data.city) {
                title = `${data.localArea}, ${data.city}`;
            }
            document.getElementById('weatherLocation').textContent = title;

            const subLocParts = [];
            if (data.district && data.district !== data.city && data.district !== data.localArea) subLocParts.push(data.district);
            if (data.state) subLocParts.push(data.state);
            if (data.country) subLocParts.push(data.country);
            
            const subLoc = document.getElementById('weatherSubLocation');
            if (subLoc) subLoc.textContent = subLocParts.join(', ');
            document.getElementById('weatherCoords').textContent = `Lat: ${data.latitude.toFixed(4)} | Lon: ${data.longitude.toFixed(4)}`;

            // 2. Update Summary Widget
            // 2. Update Summary Widget (Live Refined)
            const weatherSummary = document.querySelector('.insight-card.weather');
            if (weatherSummary) {
                // Update specific elements via IDs
                const iconEl = document.getElementById('summaryWeatherIcon');
                if (iconEl) iconEl.textContent = data.icon; // e.g. üå§Ô∏è

                const tempEl = document.getElementById('summaryWeatherTemp');
                if (tempEl) tempEl.textContent = data.temperature + '¬∞'; 

                const descEl = document.getElementById('summaryWeatherDesc');
                if (descEl) descEl.textContent = data.description;

                const humEl = document.getElementById('summaryWeatherHum');
                if (humEl) humEl.textContent = `üíß ${data.humidity}%`;
                
                const windEl = document.getElementById('summaryWeatherWind');
                if (windEl) windEl.textContent = `üí® ${data.windSpeed} km/h`;
                
                // Update Status Strip Location
                const statusLoc = document.getElementById('statusLocationText');
                if (statusLoc) statusLoc.textContent = data.city;
            }

            // 3. Update Detail Panel Hero
            document.getElementById('panelWeatherIcon').textContent = data.icon;
            document.getElementById('panelTemperature').textContent = data.temperature + '¬∞C';
            document.getElementById('panelDescription').textContent = `${data.description} in ${data.city}`;

            // 4. Update Detailed Metrics
            document.getElementById('weatherFeelsLike').textContent = data.feelsLike + '¬∞C';
            document.getElementById('weatherHumidity').textContent = data.humidity + '%';
            document.getElementById('weatherWind').textContent = data.windSpeed + ' km/h';
            document.getElementById('weatherWindDir').textContent = `Dir: ${data.windDirection}¬∞`;
            document.getElementById('weatherVisibility').textContent = data.visibility.toFixed(1) + ' km';
            document.getElementById('weatherPressure').textContent = data.pressure + ' hPa';
            document.getElementById('weatherDewPoint').textContent = data.dewPoint + '¬∞C';

            // 5. Update AQI & UV
            document.getElementById('weatherAQI').textContent = data.aqi;
            document.getElementById('weatherAQILevel').textContent = data.aqiLevel;
            document.getElementById('weatherUV').textContent = data.uvIndex;
            document.getElementById('weatherUVRisk').textContent = data.uvRisk;

            // 6. Update Sun & Moon
            document.getElementById('weatherSunrise').textContent = data.sunrise;
            document.getElementById('weatherSunset').textContent = data.sunset;
            document.getElementById('weatherMoonrise').textContent = data.moonrise;
            document.getElementById('weatherMoonset').textContent = data.moonset;
            document.getElementById('weatherMoonPhase').textContent = data.moonPhase;
            document.getElementById('weatherMoonIcon').textContent = data.moonIcon;

            // 7. Update Forecast
            const forecastList = document.getElementById('panelForecastList');
            if (forecastList && data.forecasts) {
                forecastList.innerHTML = data.forecasts.map(day => `
                    <div class="forecast-item">
                        <span class="day-name">${day.date}</span>
                        <span class="day-icon">${day.icon}</span>
                        <div class="day-temps">
                            <span class="max">${Math.round(day.maxTemp)}¬∞</span>
                            <span class="min">${Math.round(day.minTemp)}¬∞</span>
                        </div>
                        <span class="day-desc">${day.description}</span>
                    </div>
                `).join('');
            }
            
            const cityInput = document.querySelector('input[name="city"]');
            if (cityInput) cityInput.value = data.city;

            // Sync Holiday Widget
            if (typeof HolidayWidget !== 'undefined' && HolidayWidget.syncWithWeather) {
                HolidayWidget.syncWithWeather(data.country, data.countryCode);
            }

            // --- LINKED LOGIC (Old Behavior) ---
            // When weather location changes, sync News context.
            const newsInput = document.getElementById('newsSearchInput');
            if (newsInput) {
                newsInput.value = data.city;
                refreshNewsData(); 
            }

            // --- GLOBAL SIGNAL ---
            // Notify other widgets (Emergency, etc.) about location update
            window.dispatchEvent(new CustomEvent('weather-location-updated', { 
                detail: { 
                    city: data.city, 
                    country: data.country,
                    countryCode: data.countryCode // Might be undefined, but helpful if present
                } 
            }));
        }

        // Auto-Geolocate logic moved to initDashboard to avoid redundancy

        // --- 6. Currency Converter AJAX ---
        const currencyForm = document.getElementById('currencyForm');
        const fromSelect = document.getElementById('fromCurrencySelect');
        const toSelect = document.getElementById('toCurrencySelect');
        const amountInput = document.getElementById('convertAmount');
        const swapBtn = document.getElementById('swapCurrencies');
        
        let currentRate = @Model.Currency.Rate;

        async function refreshCurrencyData() {
            console.log(">>> refreshCurrencyData() called");
            const from = fromSelect.value;
            const to = toSelect.value;
            console.log("Currency pair:", from, "to", to);
            const card = document.querySelector('.insight-card.currency');
            try {
                const res = await fetch(`/Todo/GetCurrencyJson?from=${from}&to=${to}`);
                console.log("Currency API response status:", res.status);
                const data = await res.json();
                console.log("Currency data received:", data);
                currentRate = data.rate;
                updateCurrencyUI(data);
                loadCurrencyHistory(); // Refresh chart too
                console.log("<<< refreshCurrencyData() complete");
            } catch (e) {
                console.error("Currency fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        function updateCurrencyUI(data) {
            // Update Summary Widget
            const summaryWidget = document.querySelector('.insight-card.currency');
            if (summaryWidget) {
                summaryWidget.classList.remove('loading');
                const rateEl = document.getElementById('summaryCurrencyRate');
                if (rateEl) rateEl.textContent = data.rate;
                const metaEl = document.getElementById('summaryTimeMeta'); // reused meta if exists or others
                const subMetaEl = document.getElementById('summaryCurrencyMeta');
                if (subMetaEl) subMetaEl.textContent = `1 ${data.from} = ${data.rate} ${data.to}`;
            }
            
            // Update Panel Result
            document.getElementById('baseRateInfo').textContent = `1 ${data.from} = ${data.rate} ${data.to}`;
            document.getElementById('currencyTimestamp').textContent = `Last Synced: ${data.lastUpdated}`;
            
            const movementBadge = document.getElementById('rateMovement');
            if (movementBadge) {
                movementBadge.classList.remove('d-none', 'up', 'down');
                if (data.isUp === true) {
                    movementBadge.textContent = '‚Üë';
                    movementBadge.classList.add('up');
                } else if (data.isUp === false) {
                    movementBadge.textContent = '‚Üì';
                    movementBadge.classList.add('down');
                } else {
                    movementBadge.classList.add('d-none');
                }
            }

            calculateResult();
        }

        function calculateResult() {
            if (!amountInput) return;
            const amount = parseFloat(amountInput.value) || 0;
            const result = (amount * currentRate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
            const resultDisplay = document.getElementById('conversionResult');
            if (resultDisplay) resultDisplay.textContent = result;
        }

        if (fromSelect) fromSelect.addEventListener('change', refreshCurrencyData);
        if (toSelect) toSelect.addEventListener('change', refreshCurrencyData);
        if (amountInput) amountInput.addEventListener('input', calculateResult);
        // Helper to focus input
        window.focusInput = function(id) {
            const el = document.getElementById(id);
            if (el) {
                el.focus();
                const wrapper = el.closest('.custom-currency-select');
                if (wrapper) wrapper.classList.add('active');
            }
        };

        // Custom Dropdown & Search Logic (shared by Currency & Time)
        document.querySelectorAll('.custom-currency-select').forEach(wrapper => {
            const input = wrapper.querySelector('.btn-search-input');
            const options = wrapper.querySelector('.custom-options');
            const select = wrapper.querySelector('select');
            const isTime = wrapper.id.includes('Time');
            
            // Set initial value
            if (select && input) {
                const opt = select.options[select.selectedIndex];
                if (opt) input.value = opt.text.trim();
            }

            input.addEventListener('focus', () => {
                wrapper.classList.add('active');
                input.select();
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('active');
                }
            });

            // Filtering
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                const items = options.querySelectorAll('.option-item');
                items.forEach(item => {
                    const text = item.getAttribute('data-text').toLowerCase();
                    const fullName = item.getAttribute('data-full')?.toLowerCase() || "";
                    const match = text.includes(term) || fullName.includes(term);
                    item.style.display = match ? 'flex' : 'none';
                });
            });

            // Selection
            options.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', () => {
                    const val = item.getAttribute('data-value');
                    select.value = val;
                    input.value = item.getAttribute('data-text').trim();
                    wrapper.classList.remove('active');
                    
                    if (isTime) {
                        refreshTimeData();
                    } else {
                        refreshCurrencyData();
                    }
                });
            });

            // Enter Key - Resolution (Only for Currency)
            if (!isTime) {
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const term = input.value.trim();
                        
                        // 1. Direct match check
                        const items = Array.from(options.querySelectorAll('.option-item'));
                        const directMatch = items.find(it => 
                            it.getAttribute('data-value').toLowerCase() === term.toLowerCase() ||
                            it.getAttribute('data-country')?.toLowerCase() === term.toLowerCase()
                        );

                        if (directMatch) {
                            const val = directMatch.getAttribute('data-value');
                            select.value = val;
                            input.value = directMatch.getAttribute('data-text').trim();
                            refreshCurrencyData();
                        } else {
                            // 2. Resolve via Geocoding
                            input.classList.add('resolving');
                            try {
                                const res = await fetch(`/Todo/ResolveCurrencyByLocation?location=${encodeURIComponent(term)}`);
                                const data = await res.json();
                                if (data.currencyCode) {
                                    select.value = data.currencyCode;
                                    const newMatch = items.find(it => it.getAttribute('data-value') === data.currencyCode);
                                    if (newMatch) input.value = newMatch.getAttribute('data-text').trim();
                                    refreshCurrencyData();
                                } else {
                                    alert("Could not resolve location: " + term);
                                }
                            } catch (err) {
                                console.error("Resolution failed", err);
                            } finally {
                                input.classList.remove('resolving');
                            }
                        }
                        input.blur();
                        wrapper.classList.remove('active');
                    }
                });
            } else {
                // Time-specific Enter key - Smart Resolution
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const term = input.value.trim();
                        const items = Array.from(options.querySelectorAll('.option-item'));
                        
                        // 1. Check for exact text match or match within visible options
                        // Use a loose match first on what's filtered
                        const visibleItem = items.find(it => it.style.display !== 'none' && (
                             it.getAttribute('data-text').toLowerCase() === term.toLowerCase() ||
                             it.getAttribute('data-full').toLowerCase().includes(term.toLowerCase())
                        ));

                        if (visibleItem) {
                            visibleItem.click();
                            input.blur();
                            wrapper.classList.remove('active');
                            return;
                        }

                        // 2. Resolve via Geocoding (Smart Auto-Detect)
                        input.classList.add('resolving'); // Add loading spinner style if any
                        const originalPlaceholder = input.placeholder;
                        input.placeholder = "Detecting timezone...";
                        
                        try {
                            const res = await fetch(`/Todo/ResolveTimeZone?location=${encodeURIComponent(term)}`);
                            const data = await res.json();
                            
                            if (data.timezoneId) {
                                // Try to find the IANA ID match
                                // Note: Server returns IANA ID (e.g. Asia/Kolkata), but we might have Windows IDs in values?
                                // Our updated controller ensures IDs are IANA-compatible or we map them.
                                // Let's try matching the ID directly or the IANA part of the name
                                
                                let match = items.find(it => it.getAttribute('data-value') === data.timezoneId);
                                
                                // Fallback: Try matching by text content (e.g. server returns "Asia/Kolkata", option is "Asia/Kolkata (UTC+5.5)")
                                if (!match) {
                                     match = items.find(it => it.getAttribute('data-text').startsWith(data.timezoneId));
                                }

                                if (match) {
                                    // Show success feedback
                                    // toast(`Resolved '${term}' to ${data.timezoneId}`); // If we had a toast function
                                    console.log(`Resolved '${term}' to ${data.timezoneId}`);
                                    
                                    select.value = match.getAttribute('data-value');
                                    input.value = match.getAttribute('data-text').trim();
                                    match.scrollIntoView({ block: 'center' });
                                    
                                    refreshTimeData();
                                } else {
                                    alert(`Location found (${data.timezoneId}), but not in our supported list.`);
                                }
                            } else {
                                alert(`Could not find a timezone for: "${term}". Try a major city name.`);
                            }
                        } catch (err) {
                            console.error("Timezone resolution failed", err);
                            alert("Error detecting timezone. Please check your connection.");
                        } finally {
                            input.classList.remove('resolving');
                            input.placeholder = originalPlaceholder;
                            input.blur();
                            wrapper.classList.remove('active');
                        }
                    }
                });
            }
        });

        // Updated Swap Logic for Unified Buttons
        const updateInputText = (input, val) => {
            const wrapper = input.closest('.custom-currency-select');
            const item = wrapper.querySelector(`.option-item[data-value="${val}"]`);
            if (item) input.value = item.getAttribute('data-text').trim();
        };

        document.getElementById('swapCurrencies')?.addEventListener('click', () => {
            const fromSelect = document.getElementById('fromCurrencySelect');
            const toSelect = document.getElementById('toCurrencySelect');
            const fromInput = document.getElementById('fromSearch');
            const toInput = document.getElementById('toSearch');

            if (!fromSelect || !toSelect) return;

            const tempVal = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempVal;

            if (fromInput) updateInputText(fromInput, fromSelect.value);
            if (toInput) updateInputText(toInput, toSelect.value);

            refreshCurrencyData();
        });

        document.getElementById('swapTimeZones')?.addEventListener('click', () => {
            const srcSel = document.getElementById('sourceTimeSelect');
            const targetSel = document.getElementById('targetTimeSelect');
            const srcInput = document.getElementById('sourceTimeSearch');
            const targetInput = document.getElementById('targetTimeSearch');

            if (!srcSel || !targetSel) return;

            // 1. Swap hidden select values
            const tempVal = srcSel.value;
            srcSel.value = targetSel.value;
            targetSel.value = tempVal;

            // 2. Swap visible input texts directly (much safer than re-looking up)
            if (srcInput && targetInput) {
                const tempText = srcInput.value;
                srcInput.value = targetInput.value;
                targetInput.value = tempText;
            }

            refreshTimeData();
        });

        // --- 7. TIME HUB LOGIC ---
        const timeForm = document.getElementById('timeForm');
        const sourceSelect = document.getElementById('sourceTimeSelect');
        const targetSelect = document.getElementById('targetTimeSelect');
        let lastTimeData = null; // Client-side cache for instant toggling

        function handleTimeFormatChange() {
             if (lastTimeData) {
                 updateTimeUI(lastTimeData);
             }
             refreshLocalClock();
        }

        async function refreshTimeData() {
            console.log(">>> refreshTimeData() called");
            if (!sourceSelect || !targetSelect) return;

            const source = sourceSelect.value;
            const target = targetSelect.value;
            
            // Handle Empty State
            if (!source || !target) {
                console.log("Source or Target empty, clearing result.");
                document.getElementById('timeResultVal').textContent = "--:--";
                document.getElementById('timeAbbr').textContent = "";
                document.querySelector('.insight-card.time')?.classList.remove('loading');
                return;
            }

            const time = ''; // Always use current time
            console.log("Time zones:", source, "to", target);
            const card = document.querySelector('.insight-card.time');
            if (card) card.classList.add('loading');

            try {
                const res = await fetch(`/Todo/GetTimeJson?source=${encodeURIComponent(source)}&target=${encodeURIComponent(target)}&time=${encodeURIComponent(time)}`);
                const data = await res.json();
                lastTimeData = data; // Cache it
                updateTimeUI(data);
            } catch (e) {
                console.error("Time fetch failed:", e);
            } finally {
                if (card) card.classList.remove('loading');
            }
        }



        function handleConversionFormatChange() {
             if (lastTimeData) {
                 updateTimeUI(lastTimeData);
             }
        }

        function updateTimeUI(data) {
            const is12h = document.getElementById('conversionFormatToggle')?.checked;
            
            // Format time helper
            const formatTime = (timeStr) => {
                if (!is12h) return timeStr;
                const [h, m] = timeStr.split(':');
                const hours = parseInt(h);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const h12 = hours % 12 || 12;
                return `${h12}:${m} ${ampm}`;
            };

            const timeWidget = document.querySelector('.insight-card.time');
            if (timeWidget) {
                timeWidget.classList.remove('loading');
                const targetDisplay = document.getElementById('summaryTargetTime');
                if (targetDisplay) {
                    targetDisplay.textContent = formatTime(data.targetTime);
                    targetDisplay.setAttribute('data-offset', data.totalOffsetMinutes);
                }

                // FIX: Update the main panel result with formatting
                const resultVal = document.getElementById('timeResultVal');
                if (resultVal) {
                    resultVal.textContent = formatTime(data.targetTime);
                }
                
                const resultAbbr = document.getElementById('timeAbbr');
                if (resultAbbr) resultAbbr.textContent = data.targetAbbr || 'UTC';
            }

            const resultVal = document.getElementById('timeResultVal');
            if (resultVal) resultVal.textContent = formatTime(data.targetTime);

            const abbrBadge = document.getElementById('timeAbbr');
            if (abbrBadge) abbrBadge.textContent = data.targetAbbr || 'UTC';

            const dayChangeBadge = document.getElementById('timeDayChange');
            if (dayChangeBadge) {
                dayChangeBadge.textContent = data.dayChange;
                if (data.dayChange === "Same Day" || !data.dayChange) {
                    dayChangeBadge.classList.add('d-none');
                } else {
                    dayChangeBadge.classList.remove('d-none');
                    dayChangeBadge.className = 'day-change-badge'; // reset
                    if (data.dayChange === "Next Day") dayChangeBadge.classList.add('next-day');
                    if (data.dayChange === "Previous Day") dayChangeBadge.classList.add('prev-day');
                }
            }

            const offsetInfo = document.getElementById('timeOffsetInfo');
            if (offsetInfo) {
                offsetInfo.textContent = `Difference: ${data.offsetDisplay} hours`;
            }
        }


        if (sourceSelect) sourceSelect.addEventListener('change', refreshTimeData);
        if (targetSelect) targetSelect.addEventListener('change', refreshTimeData);
        
        const swapTimeZonesBtn = document.getElementById('swapTimeZones');
        if (swapTimeZonesBtn) {
            swapTimeZonesBtn.addEventListener('click', () => {
                const temp = sourceSelect.value;
                sourceSelect.value = targetSelect.value;
                targetSelect.value = temp;
                refreshTimeData();
            });
        }

        // --- 11. NEWS WIDGET LOGIC ---
        let currentNewsCategory = 'All';
        let lastResolvedNewsLocation = "";
        let allNewsItems = [];
        let newsVisibleCount = 0;
        const NEWS_PAGE_SIZE = 12;
        const NEWS_PLACEHOLDER_IMG = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=800&q=80"; // Premium abstract news image

        async function refreshNewsData() {
            const feedContainer = document.getElementById('newsFeed');
            const searchInput = document.getElementById('newsSearchInput');
            const sortSelect = document.getElementById('newsSortSelect');
            const resolvedLabel = document.getElementById('newsResolvedLocation');
            const card = document.getElementById('newsWidgetCard');
            
            const location = searchInput.value || lastResolvedNewsLocation || '@Model.SelectedCity' || 'London';
            const category = currentNewsCategory === 'All' ? '' : currentNewsCategory;
            const sortBy = sortSelect.value;
            
            if (card) card.classList.add('loading');
            feedContainer.innerHTML = '<div class="news-loading-state"><div class="spinner"></div><p>Fetching authentic news...</p></div>';

            try {
                const res = await fetch(`/Todo/GetNewsJson?location=${encodeURIComponent(location)}&category=${encodeURIComponent(category)}&sortBy=${sortBy}`);
                const data = await res.json();
                
                lastResolvedNewsLocation = data.resolvedLocation;
                if (resolvedLabel) resolvedLabel.textContent = `Showing news for: ${data.resolvedLocation}`;
                
                // Store all items for pagination
                allNewsItems = data.items || [];
                newsVisibleCount = 0; // Reset index
                
                renderNewsFeed(false); // Initial render (full list replaced)
                updateLoadMoreVisibility();
                
                if (card) {
                    card.classList.remove('loading');
                    const countDisplay = document.getElementById('summaryNewsCount');
                    const metaDisplay = document.getElementById('summaryNewsMeta');
                    if (countDisplay) countDisplay.textContent = `${allNewsItems.length} Stories`;
                    if (metaDisplay) metaDisplay.textContent = `${data.resolvedLocation} ‚Ä¢ ${category || 'General'}`;
                }
            } catch (err) {
                console.error("News fetch failed:", err);
                feedContainer.innerHTML = '<div class="news-loading-state"><p>‚ö†Ô∏è Failed to load news. Please try a different location.</p></div>';
                if (card) card.classList.remove('loading');
            }
        }

        function updateLoadMoreVisibility() {
            const container = document.getElementById('newsLoadMoreContainer');
            if (container) {
                container.style.display = (newsVisibleCount < allNewsItems.length) ? 'flex' : 'none';
            }
        }

        function loadMoreNews() {
            renderNewsFeed(true); // Append mode
            updateLoadMoreVisibility();
        }

        function renderNewsFeed(append = false) {
            const container = document.getElementById('newsFeed');
            
            const start = newsVisibleCount;
            const end = Math.min(start + NEWS_PAGE_SIZE, allNewsItems.length);
            const batch = allNewsItems.slice(start, end);
            newsVisibleCount = end;

            if (!append && batch.length === 0) {
                container.innerHTML = '<div class="news-loading-state"><p>No relevant news stories found for this location.</p></div>';
                return;
            }

            const html = batch.map((item, index) => {
                const globalIndex = start + index;
                
                // Favicon Logic
                let faviconUrl = "";
                if (item.sourceUrl && item.sourceUrl.length > 5) {
                    faviconUrl = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(item.sourceUrl)}&sz=32`;
                } else {
                    const guessedDomain = item.source.toLowerCase().replace(/\s+/g, '') + (item.source.toLowerCase().includes('.') ? "" : ".com");
                    faviconUrl = `https://www.google.com/s2/favicons?domain=${guessedDomain}&sz=32`;
                }

                // Sentiment Class mapping
                const sentimentClass = (item.sentiment || 'Neutral').toLowerCase();

                return `
                    <div class="news-item-card insight-mode" onclick="viewArticle(${globalIndex})">
                        <div class="news-card-body">
                            <div class="news-tags-row">
                                <span class="insight-badge badge-category">${item.category}</span>
                                <span class="insight-badge badge-location">üìç ${item.locationTag || 'Global'}</span>
                                <span class="insight-badge badge-sentiment ${sentimentClass}">
                                    <span class="sentiment-dot"></span>
                                    ${item.sentiment}
                                </span>
                            </div>
                            
                            <h3 class="news-headline-insight">${item.title}</h3>
                            <p class="news-summary-insight">${item.description}</p>
                        </div>

                        <div class="news-footer-insight">
                            <div class="source-meta">
                                <img src="${faviconUrl}" class="source-favicon-mini" alt="" onerror="this.style.display='none'">
                                <span class="source-name-mini">${item.source}</span>
                            </div>
                            <span class="date-meta">${item.published}</span>
                        </div>
                    </div>
                `;
            }).join('');


            if (append) {
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }

        function viewArticle(index) {
            const item = allNewsItems[index];
            if (!item) return;
            // No image in modal if we want consistent text-only look? 
            // Or keep image in modal for "Read More" context.
            // User said "remove images from my news widget completely".
            // I'll remove image from the modal HERO too for consistency.
            openArticleDetail(item.link, item.title, item.source, item.published, "", item.description, item.category, item.locationTag, item.sentiment);
        }

        async function openArticleDetail(url, title, source, date, img, description, category, location, sentiment) {
            const detailPanel = document.getElementById('newsArticleDetails');
            const bodyContainer = document.getElementById('articleBody');
            const overlay = document.getElementById('detailsOverlay');
            const badgeRow = document.getElementById('articleBadgeRow');
            
            // 1. Reset and Show UI
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            detailPanel.classList.add('active');
            if (overlay) overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // 2. Set Basic Info
            document.getElementById('articleTitle').textContent = title || 'Untitled';
            document.getElementById('articleSource').textContent = source || 'News Source';
            document.getElementById('articleDate').textContent = date || '';
            document.getElementById('articleSourceLink').href = url || '#';
            
            // 3. Set Badges
            const sentimentClass = (sentiment || 'Neutral').toLowerCase();
            badgeRow.innerHTML = `
                <span class="insight-badge badge-category">${category || 'General'}</span>
                <span class="insight-badge badge-location">üìç ${location || 'Global'}</span>
                <span class="insight-badge badge-sentiment ${sentimentClass}">
                    <span class="sentiment-dot"></span>
                    ${sentiment || 'Neutral'}
                </span>
            `;

            // 4. Clear Previous and Show Loading
            bodyContainer.innerHTML = `
                <div class="article-loading">
                    <div class="spinner"></div>
                    <p>Extracting article content for in-app reading...</p>
                </div>
            `;
            
            // 5. Async Fetch Full Content
            try {
                const response = await fetch(`/Todo/GetNewsDetailJson?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                
                if (data && data.content && data.content.length > 50) {
                    bodyContainer.innerHTML = `
                        <div class="article-content-wrapper">
                            <p class="article-intro-text">${data.content}</p>
                        </div>
                    `;
                } else {
                    bodyContainer.innerHTML = `
                        <div class="article-content-wrapper">
                            <p class="article-intro-text">${description || 'Detailed content not available.'}</p>
                            <div class="article-note">
                                <small>Full content extraction unavailable for this source. Read more on the original website below.</small>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.warn("Article extraction failed:", err);
                bodyContainer.innerHTML = `<p>${description || 'Detailed content not available.'}</p>`;
            }
        }

        function backToNewsFeed() {
            openDetails('news');
        }

        // --- Category Pill Interaction ---
        document.querySelectorAll('#newsCategoryPills .pill').forEach(pill => {
            pill.addEventListener('click', () => {
                document.querySelectorAll('#newsCategoryPills .pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentNewsCategory = pill.getAttribute('data-category');
                refreshNewsData();
            });
        });

        // Search on Enter
        const newsSearchInput = document.getElementById('newsSearchInput');
        if (newsSearchInput) {
            newsSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    refreshNewsData();
                }
            });
        }

        // --- 9. GLOBAL INITIALIZATION ---
        async function initDashboard() {
            console.log(">>> initDashboard() started");

            let city = '@Model.SelectedCity';
            console.log("Initial city:", city);
            
            // Try browser geolocation first if no city specified
            if (!city || city === "London") {
                if (navigator.geolocation) {
                    try {
                        console.log("Attempting geolocation...");
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 3000 });
                        });
                        const { latitude, longitude } = position.coords;
                        const res = await fetch(`/Todo/GetWeatherByCoordsJson?lat=${latitude}&lon=${longitude}`);
                        const data = await res.json();
                        updateWeatherUI(data);
                        city = data.city;
                        console.log("Geolocation successful, city:", city);
                    } catch (err) {
                        console.info("Dev Mode: Browser geolocation unavailable (Localhost), trying IP fallback...");
                        try {
                            // Use backend endpoint to avoid mixed content/rate-limit issues on client
                            const ipRes = await fetch('/Todo/GetLocationJson'); 
                            const ipData = await ipRes.json();
                            if (ipData.city) {
                                console.log("IP Fallback successful:", ipData.city);
                                const res = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(ipData.city)}`);
                                const data = await res.json();
                                updateWeatherUI(data);
                                city = data.city;
                            }
                        } catch (e) {
                            console.warn("Location detection failed, using default (London).");
                        }
                    }
                }
            }

            // Always fetch data on page load
            const finalCity = city || "London";
            console.log("Fetching data for city:", finalCity);
            
            console.log("Calling refreshWeatherData...");
            refreshWeatherData(finalCity);
            
            console.log("Calling refreshCurrencyData...");
            refreshCurrencyData();
            
            console.log("Calling refreshTimeData...");
            refreshTimeData();

            console.log("Calling refreshNewsData...");
            refreshNewsData();
            
            console.log("<<< initDashboard() complete");
        }

        // Modified weather fetch for init
        async function refreshWeatherData(cityValue) {
            console.log(">>> refreshWeatherData() called for:", cityValue);
            const card = document.querySelector('.insight-card.weather');
            try {
                const response = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(cityValue)}`);
                console.log("Weather API response status:", response.status);
                const data = await response.json();
                console.log("Weather data received:", data);
                updateWeatherUI(data);
                if (card) card.classList.remove('loading');
                console.log("<<< refreshWeatherData() complete");
            } catch (e) {
                console.error("Weather fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        // --- 10. Local Clock & Timezone Detection ---
        function refreshLocalClock() {
            const timeDisplay = document.getElementById('localClockTime');
            const dateDisplay = document.getElementById('localClockDate');
            const formatToggle = document.getElementById('timeFormatToggle');
            const now = new Date();
            const is12h = formatToggle ? !formatToggle.checked : true; // Inverted check logic if toggle is structured as 12H-24H
            
            // Get checked state: our toggle is [checked=24H]
            const use24h = formatToggle ? formatToggle.checked : false;

            if (timeDisplay) {
                timeDisplay.textContent = now.toLocaleTimeString(undefined, { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: !use24h 
                });
            }
            if (dateDisplay) dateDisplay.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function startLocalClock() {
            const tzLabel = document.getElementById('localTzLabel');
            const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (tzLabel) tzLabel.textContent = userTz;

            // Attempt to sync Source Zone in converter
            const sourceSel = document.getElementById('sourceTimeSelect');
            const sourceInput = document.getElementById('sourceTimeSearch');
            if (sourceSel && sourceInput) {
                 const ianaCity = userTz.split('/').pop().replace('_', ' ');
                 Array.from(sourceSel.options).forEach(opt => {
                     // Check for IANA ID match or descriptive match
                     if (opt.value === userTz || opt.text.includes(ianaCity)) {
                         sourceSel.value = opt.value;
                         updateInputText(sourceInput, opt.value);
                     }
                 });
            }

            refreshLocalClock();
            setInterval(refreshLocalClock, 1000);
        }

        // --- 11. Country Explorer ---
        let countrySearchTimeout;

        async function handleCountrySearchInput(query) {
            if (countrySearchTimeout) clearTimeout(countrySearchTimeout);
            
            const resultsContainer = document.getElementById('countrySearchResults');
            if (!query || query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }

            countrySearchTimeout = setTimeout(async () => {
                try {
                    const res = await fetch(`/Todo/SearchCountries?query=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    
                    if (data && data.length > 0) {
                        renderCountrySearchResults(data);
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.style.display = 'none';
                    }
                } catch (e) {
                    console.error("Country search failed:", e);
                }
            }, 300);
        }

        function renderCountrySearchResults(countries) {
            const list = document.getElementById('countrySearchResults');
            list.innerHTML = countries.map(c => `
                <div class="country-search-item" onclick="selectCountry('${c.name.replace(/'/g, "\\'")}')">
                    <span class="flag-mini">${c.flagEmoji}</span>
                    <div class="country-info-mini">
                        <span class="name">${c.name}</span>
                        <span class="capital">${c.capital}</span>
                    </div>
                </div>
            `).join('');
        }

        async function selectCountry(name) {
            document.getElementById('countrySearchResults').style.display = 'none';
            document.getElementById('countryPlaceholder').style.display = 'none';
            document.getElementById('countryLoadingState').style.display = 'flex';
            document.getElementById('countryDetailsContent').style.display = 'none';
            
            try {
                const res = await fetch(`/Todo/GetCountryDetails?name=${encodeURIComponent(name)}`);
                if (!res.ok) throw new Error("Country not found");
                
                const data = await res.json();
                
                if (data && data.name) {
                    renderCountryDetails(data);
                    // Also update summary card
                    document.getElementById('summaryCountryName').textContent = data.name;
                    document.getElementById('summaryCountryMeta').textContent = `${data.flagEmoji} ${data.capital} ‚Ä¢ ${data.region}`;
                    const card = document.querySelector('.insight-card.country');
                    if (card) card.classList.remove('loading');

                } else {
                    throw new Error("Invalid country data");
                }
            } catch (e) {
                console.error("Failed to load country details:", e);
                const container = document.getElementById('countryDetailsContent');
                container.innerHTML = `
                    <div style="text-align:center; padding: 3rem 1rem; color: rgba(255,255,255,0.6);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîé</div>
                        <h3>Country Not Found</h3>
                        <p>We couldn't retrieve details for "${name}". Please try a different name.</p>
                        <button onclick="document.getElementById('countryPlaceholder').style.display='flex'; document.getElementById('countryDetailsContent').style.display='none';" class="btn-primary-sm" style="margin-top:1rem;">Back to Search</button>
                    </div>
                `;
            } finally {
                document.getElementById('countryLoadingState').style.display = 'none';
                document.getElementById('countryDetailsContent').style.display = 'block';
            }
        }

        let countryMap = null;

    function renderCountryDetails(c) {
        const container = document.getElementById('countryDetailsContent');
        if (!container) return;

        // --- Helper: Validate Data ---
        // Returns false if value is missing, empty, or a known fallback
        const isValid = (val) => {
            if (!val) return false;
            if (Array.isArray(val) && val.length === 0) return false;
            const s = String(val).trim().toLowerCase();
            const invalids = ["n/a", "not officially defined", "data not publicly available", "unknown name", "pending", "undefined"];
            return !invalids.includes(s);
        };

        // --- Helper: Render Row ---
        // Renders a detail row only if the value is valid
        const renderRow = (label, value, isHtml = false, capitalizeClass = "") => {
            if (!isValid(value)) return "";
            // Special check for array strings (like invalid fallback in list)
            if (Array.isArray(value) && value.some(v => !isValid(v))) return ""; 
            
            return `<div class="detail-row"><span>${label}</span> ${isHtml ? value : `<strong class="${capitalizeClass}">${value}</strong>`}</div>`;
        };

        // --- Data Preparation ---
        const currs = Object.entries(c.currencies).map(([code, info]) => `${info.name || info.item1} (${info.symbol || info.item2 || code})`).join(', ');
        const langs = c.languages.filter(l => isValid(l)).join(', ');
        const pop = isValid(c.population) ? new Intl.NumberFormat().format(c.population) : "";
        const area = isValid(c.area) ? new Intl.NumberFormat().format(c.area) : "";
        const density = isValid(c.populationDensity) ? new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(c.populationDensity) : "";
        
        let motto = "N/A";
        const mottoMatch = c.wikipediaSummary.match(/motto is [\"']?([^\"\'.]+)[\"']?/i) || c.wikipediaSummary.match(/[\"\']([^\"\']+)[\"\'] is the national motto/i);
        if (mottoMatch) motto = mottoMatch[1];
        
        // Use backend motto if valid, otherwise regex match, otherwise N/A (which will be hidden)
        const finalMotto = isValid(c.nationalMotto) ? c.nationalMotto : (isValid(motto) ? motto : "");

        // --- Build Sections ---
        
        // 1. Geography
        let geoContent = "";
        geoContent += renderRow("Total Area", area ? `${area} km¬≤` : "");
        geoContent += renderRow("Coordinates", (c.latitude && c.longitude) ? `${c.latitude.toFixed(2)}, ${c.longitude.toFixed(2)}` : "");
        geoContent += renderRow("Region", c.region);
        geoContent += renderRow("Sub-region", c.subregion);
        geoContent += renderRow("Continents", c.continents.join(', '));
        
        // Borders (Special rendering)
        let borderContent = "";
        if (c.borderCountryNames && c.borderCountryNames.length > 0) {
             borderContent = c.borderCountryNames.map(b => `<span class="border-pill">${b}</span>`).join('');
        }
        
        // Only show borders section if we have borders OR explicit landlocked context
        let bordersHtml = "";
        if (borderContent && borderContent.indexOf('Data unavailable') === -1) {
             bordersHtml = `
             <div class="borders-section mt-3">
                <span>Borders & Neighbors</span>
                <div class="border-pills">${borderContent}</div>
             </div>`;
        } else if (c.isLandlocked) {
             // Keep landlocked status visible as it is a key geo feature
             bordersHtml = `
             <div class="borders-section mt-3">
                <span>Geography Status</span>
                <div class="border-pills"><em>Landlocked</em></div>
             </div>`;
        } else if (!borderContent && !c.isLandlocked) {
             bordersHtml = `
             <div class="borders-section mt-3">
                <span>Geography Status</span>
                <div class="border-pills"><em>Island / Coastal</em></div>
             </div>`;
        }

        const geoSection = `
            <div class="country-accordion open" id="accGeo">
                <div class="accordion-header" onclick="toggleAccordion('accGeo')">
                    <h3><i class="icon">üß≠</i> Geography & Map</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="country-map-container" id="countryMap"></div>
                    <div class="info-group">
                        ${geoContent}
                        ${bordersHtml}
                    </div>
                </div>
            </div>`;

        // 2. Climate
        let climateRows = "";
        climateRows += renderRow("Climate Type", c.climateType);
        climateRows += renderRow("Avg Temperature", c.averageTemperature);
        climateRows += renderRow("Natural Resources", c.naturalResources);
        
        const climateSection = climateRows ? `
            <div class="country-accordion" id="accClimate">
                <div class="accordion-header" onclick="toggleAccordion('accClimate')">
                    <h3><i class="icon">‚õÖ</i> Climate & Environment</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${climateRows}</div>
                </div>
            </div>` : "";

        // 3. Demographics
        let demoRows = "";
        demoRows += renderRow("Total Population", pop);
        demoRows += renderRow("Pop. Density", density ? `${density} / km¬≤` : "");
        demoRows += renderRow("Religions", c.religions);
        demoRows += renderRow("Languages", langs);
        demoRows += renderRow("Demonym", c.demonym);
        
        const demoSection = demoRows ? `
            <div class="country-accordion" id="accDemo">
                <div class="accordion-header" onclick="toggleAccordion('accDemo')">
                    <h3><i class="icon">üë•</i> Demographics & Culture</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${demoRows}</div>
                </div>
            </div>` : "";

        // 4. Economy
        let econRows = "";
        econRows += renderRow("Total GDP", c.gdp);
        econRows += renderRow("Currencies", currs);
        econRows += renderRow("Major Industries", c.majorIndustries);
        
        // Infra
        let infraRows = "";
        infraRows += renderRow("Electricity", (isValid(c.electricityVoltage) || isValid(c.electricityPlugTypes)) ? `${c.electricityVoltage}, ${c.electricityPlugTypes}` : "");
        infraRows += renderRow("Driving Side", c.drivingSide, false, "text-capitalize");
        infraRows += renderRow("Calling Code", c.callingCode);
        infraRows += renderRow("Domain (TLD)", c.internetDomains && c.internetDomains.length > 0 ? c.internetDomains.join(', ') : "");

        const econSection = (econRows || infraRows) ? `
             <div class="country-accordion" id="accEcon">
                <div class="accordion-header" onclick="toggleAccordion('accEcon')">
                    <h3><i class="icon">üí∞</i> Economy & Infrastructure</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    ${econRows ? `<div class="info-group mb-3">${econRows}</div>` : ""}
                    ${infraRows ? `<div class="info-group">${infraRows}</div>` : ""}
                </div>
            </div>` : "";

        // 5. Culture
        let cultureRows = "";
        cultureRows += renderRow("National Anthem", c.nationalAnthem);
        cultureRows += renderRow("National Animal", c.nationalAnimal);
        cultureRows += renderRow("National Sport", c.nationalSport);
        
        const cultureSection = cultureRows ? `
            <div class="country-accordion" id="accCulture">
                <div class="accordion-header" onclick="toggleAccordion('accCulture')">
                    <h3><i class="icon">üé®</i> Culture & Identity</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${cultureRows}</div>
                </div>
            </div>` : "";
            
        // 6. Global & Extra
        let globalRows = "";
        
        // Rankings
        if (c.globalRankings && Object.keys(c.globalRankings).length > 0) {
            const rankingHtml = Object.entries(c.globalRankings).map(([k, v]) => `<div class="small"><strong>${k}:</strong> ${v}</div>`).join('');
            globalRows += `<div class="detail-row"><span>Global Rankings</span> <div>${rankingHtml}</div></div>`;
        }
        
        // Orgs
        if (c.internationalOrganizations && c.internationalOrganizations.length > 0 && isValid(c.internationalOrganizations[0])) { 
            const orgsHtml = c.internationalOrganizations.map(o => `<span class="pill-sm">${o}</span>`).join('');
            globalRows += `<div class="detail-row"><span>Organizations</span> <div class="scroll-pills">${orgsHtml}</div></div>`;
        }
        
        // Google Maps
        if (isValid(c.googleMapsUrl)) {
             globalRows += `<div class="detail-row"><span>Google Maps</span> <a href="${c.googleMapsUrl}" target="_blank" class="btn-primary-sm" style="display:inline-block; margin-top:0;">Navigate External ‚Üó</a></div>`;
        }

        const globalSection = globalRows ? `
            <div class="country-accordion" id="accAdd">
                <div class="accordion-header" onclick="toggleAccordion('accAdd')">
                    <h3><i class="icon">‚ú®</i> Global Standings & Insight</h3>
                    <span class="accordion-icon">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="info-group">${globalRows}</div>
                </div>
            </div>` : "";


        // --- Final Assembly ---
        container.innerHTML = `
            <div class="country-header-premium">
                <div class="flag-hero">
                    <img src="${c.flagUrl}" alt="${c.name} Flag" class="flag-img-big" />
                </div>
                <div class="header-text">
                    <h1>${c.name} ${c.flagEmoji}</h1>
                    <p class="official-name">${c.officialName}</p>
                    <div class="quick-stats-pills">
                        ${isValid(c.capital) ? `<span class="stat-pill">üìç ${c.capital}</span>` : ""}
                        <span class="stat-pill">üÜî ${c.isoCode} ${c.isoCodeAlpha3 ? `/ ${c.isoCodeAlpha3}` : ""}</span>
                        <span class="stat-pill">${c.isLandlocked ? 'üèîÔ∏è Landlocked' : 'üåä Coastal'}</span>
                        ${finalMotto ? `<span class="stat-pill motto-pill">üí¨ ${finalMotto}</span>` : ""}
                    </div>
                </div>
            </div>

            <div class="country-summary-box">
                <h3>About ${c.name}</h3>
                <p class="wiki-extract">${c.wikipediaSummary || 'Fetching detailed historical and political summary...'}</p>
            </div>

            ${geoSection}
            ${climateSection}
            ${demoSection}
            ${econSection}
            ${cultureSection}
            ${globalSection}
        `;

        // Init Map after DOM update
        if (c.latitude && c.longitude) {
            setTimeout(() => initCountryMap(c.latitude, c.longitude, c.name), 100);
        }
    }

        function toggleAccordion(id) {
            const acc = document.getElementById(id);
            if (acc) {
                const isOpen = acc.classList.contains('open');
                // Close others if you want, but user might want multiple open
                // For now just toggle
                acc.classList.toggle('open');
                
                // If opening geography, ensure map resizes
                if (id === 'accGeo' && !isOpen) {
                    setTimeout(() => { if(countryMap) countryMap.invalidateSize(); }, 310);
                }
            }
        }

        function initCountryMap(lat, lng, name) {
            const mapEl = document.getElementById('countryMap');
            if (!mapEl) {
                console.warn("Map container 'countryMap' not found in DOM.");
                return;
            }

            if (countryMap) {
                countryMap.remove();
                countryMap = null;
            }
            
            // Fix Leaflet's default icon path issues by pointing to local assets
            delete L.Icon.Default.prototype._getIconUrl;
            L.Icon.Default.mergeOptions({
                iconRetinaUrl: '/lib/leaflet/images/marker-icon-2x.png',
                iconUrl: '/lib/leaflet/images/marker-icon.png',
                shadowUrl: '/lib/leaflet/images/marker-shadow.png',
            });
            
            countryMap = L.map('countryMap').setView([lat, lng], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(countryMap);

            L.marker([lat, lng]).addTo(countryMap)
                .bindPopup(name)
                .openPopup();
            
            // Fix map resize inside dynamic content
            setTimeout(() => countryMap.invalidateSize(), 300);
        }

        // --- 9. Initialization ---
        function initializeAll() {
            console.log("=== INITIALIZING DASHBOARD ===");
            initDashboard();
            startConverterClocks();
            updateWorldClocks();
            startLocalClock();
            console.log("=== INITIALIZATION COMPLETE ===");
        }

        // Run immediately if DOM is already loaded, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAll);
        } else {
            // DOM is already loaded, run immediately
            initializeAll();
        }
    </script>
    <script src="~/js/habit-tracker.js"></script>
    <script src="~/js/emergency-widget.js"></script>
    <script src="~/js/holiday-widget.js"></script>
<script src="~/js/translator-widget.js"></script>
}
