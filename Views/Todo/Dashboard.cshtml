@model TodoListApp.ViewModels.DashboardViewModel

@{
    ViewData["Title"] = "Real-time Dashboard";
}

<div class="dashboard-container centered-view">
    <div class="dashboard-header text-center">
        <h1>Welcome, @Model.UserName</h1>
        <div class="header-controls">
            <div class="format-toggle">
                <span class="toggle-label">24H</span>
                <label class="switch">
                    <input type="checkbox" id="timeFormatToggle">
                    <span class="slider round"></span>
                </label>
                <span class="toggle-label">12H</span>
            </div>
        </div>
        <div class="local-clock-container">
            <div id="localClockTime" class="live-clock">00:00:00</div>
            <div id="localClockDate" class="live-date">Loading date...</div>
            <div id="localTzLabel" class="tz-badge pulse">Detecting Timezone...</div>
        </div>
    </div>

    <div class="realtime-grid">
        <!-- Weather Widget -->
        <div class="insight-card summary-widget weather loading" onclick="openDetails('weather')">
            <div class="widget-preview">
                <div class="insight-icon" id="summaryWeatherIcon">@(string.IsNullOrEmpty(Model.Weather.Icon) ? "üå°Ô∏è" : Model.Weather.Icon)</div>
                <div class="insight-info">
                    <span class="insight-label">Local Weather</span>
                    <span class="insight-value" id="summaryWeatherTemp">@(Model.Weather.Temperature > 0 ? Model.Weather.Temperature + "¬∞C" : "--¬∞C")</span>
                    <span class="insight-meta" id="summaryWeatherMeta">@(string.IsNullOrEmpty(Model.Weather.City) ? Model.SelectedCity + " ‚Ä¢ Loading..." : Model.Weather.City + " ‚Ä¢ " + Model.Weather.Description)</span>
                </div>
            </div>
            <div class="widget-action">
                <span>View Forecast & Details</span>
            </div>
        </div>

        <!-- Currency Widget -->
        <div class="insight-card summary-widget currency loading" onclick="openDetails('currency')">
            <div class="widget-preview">
                <div class="insight-icon">üí±</div>
                <div class="insight-info">
                    <span class="insight-label">Currency Exchange</span>
                    <span class="insight-value" id="summaryCurrencyRate">@(Model.Currency.Rate > 0 ? Model.Currency.Rate.ToString("F4") : "--.----")</span>
                    <span class="insight-meta" id="summaryCurrencyMeta">1 @Model.FromCurrency = @(Model.Currency.Rate > 0 ? Model.Currency.Rate.ToString("F4") : "--") @Model.ToCurrency</span>
                </div>
            </div>
            <div class="widget-action">
                <span>View Chart & Converter</span>
            </div>
        </div>

        <!-- World Clock Widget -->
        <div class="insight-card summary-widget time loading" onclick="openDetails('time')">
            <div class="widget-preview">
                <div class="insight-icon">üåç</div>
                <div class="insight-info">
                    <span class="insight-label">Time Converter</span>
                    <span class="insight-value" id="summaryTargetTime" data-offset="@Model.TimeConversion.TotalOffsetMinutes">@(string.IsNullOrEmpty(Model.TimeConversion.TargetTime) ? "--:--" : Model.TimeConversion.TargetTime)</span>
                    <span class="insight-meta" id="summaryTimeMeta">@Model.TargetTimeZone</span>
                </div>
            </div>
            <div class="widget-action">
                <span>View World Clock</span>
            </div>
        </div>
    </div>
</div>

<!-- Details Overlay & Panels -->
<div class="details-overlay" id="detailsOverlay" onclick="closeDetails()"></div>

<!-- Weather Details Panel -->
<div class="details-panel" id="weatherDetails" style="max-width: 800px;">
    <div class="panel-header">
        <h2>Detailed Weather</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content weather-expanded">
        <!-- 1. Location Details -->
        <div class="location-header">
            <h3 id="weatherLocation">@Model.Weather.City@(string.IsNullOrEmpty(Model.Weather.District) ? "" : ", " + Model.Weather.District)</h3>
            <p id="weatherSubLocation" class="text-muted">@Model.Weather.State, @Model.Weather.Country</p>
            <p id="weatherCoords">Lat: @Model.Weather.Latitude.ToString("F4") | Lon: @Model.Weather.Longitude.ToString("F4")</p>
        </div>

        <form id="weatherSearchForm" class="detail-form">
            <div class="form-group">
                <div class="input-with-button">
                    <input type="text" id="weatherSearchInput" name="city" value="@Model.SelectedCity" class="form-control" placeholder="Search City, State or Country..." />
                    <button type="submit" class="btn-primary-sm" id="weatherSearchSubmit">Search</button>
                    <button type="button" class="btn-secondary-sm" id="geolocateBtn" title="Use my current location">üìç</button>
                </div>
            </div>
        </form>

        <div class="weather-grid-detailed">
            <!-- 2. Current Weather Hero -->
            <div class="weather-main-section">
                <div class="current-weather-hero">
                    <div class="hero-icon" id="panelWeatherIcon">@Model.Weather.Icon</div>
                    <div class="hero-temp" id="panelTemperature">@Model.Weather.Temperature¬∞C</div>
                    <div class="hero-desc" id="panelDescription">@Model.Weather.Description in @Model.Weather.City</div>
                </div>

                <div class="weather-metrics-grid">
                    <div class="metric-card">
                        <span class="m-label">Feels Like</span>
                        <span class="m-value" id="weatherFeelsLike">@Model.Weather.FeelsLike¬∞C</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Humidity</span>
                        <span class="m-value" id="weatherHumidity">@Model.Weather.Humidity%</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Wind</span>
                        <span class="m-value" id="weatherWind">@Model.Weather.WindSpeed km/h</span>
                        <span class="m-sub" id="weatherWindDir">Dir: @Model.Weather.WindDirection¬∞</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Visibility</span>
                        <span class="m-value" id="weatherVisibility">@Model.Weather.Visibility.ToString("F1") km</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Pressure</span>
                        <span class="m-value" id="weatherPressure">@Model.Weather.Pressure hPa</span>
                    </div>
                    <div class="metric-card">
                        <span class="m-label">Dew Point</span>
                        <span class="m-value" id="weatherDewPoint">@Model.Weather.DewPoint¬∞C</span>
                    </div>
                </div>
            </div>

            <!-- 4. Air Quality & UV -->
            <div class="weather-side-section">
                <div class="info-card-glass aqi-card">
                    <span class="panel-subtitle-small">Air Quality (AQI)</span>
                    <div class="aqi-display">
                        <span class="aqi-val" id="weatherAQI">@Model.Weather.AQI</span>
                        <span class="aqi-level" id="weatherAQILevel">@Model.Weather.AQILevel</span>
                    </div>
                </div>
                <div class="info-card-glass uv-card" style="margin-top: 1rem;">
                    <span class="panel-subtitle-small">UV Index</span>
                    <div class="uv-display">
                        <span class="uv-val" id="weatherUV">@Model.Weather.UVIndex</span>
                        <span class="uv-risk" id="weatherUVRisk">@Model.Weather.UVRisk</span>
                    </div>
                </div>

                <!-- 5. Sun & Moon Data -->
                <div class="info-card-glass astro-card" style="margin-top: 1rem;">
                    <span class="panel-subtitle-small">Sun & Moon</span>
                    <div class="astro-grid">
                        <div class="astro-item">
                            <span>üåÖ Sunrise</span>
                            <strong id="weatherSunrise">@Model.Weather.Sunrise</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåá Sunset</span>
                            <strong id="weatherSunset">@Model.Weather.Sunset</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåô Moonrise</span>
                            <strong id="weatherMoonrise">@Model.Weather.Moonrise</strong>
                        </div>
                        <div class="astro-item">
                            <span>üåí Moonset</span>
                            <strong id="weatherMoonset">@Model.Weather.Moonset</strong>
                        </div>
                    </div>
                    <hr class="glass-hr">
                    <div class="moon-phase-details">
                        <div class="moon-img-container">
                            <span class="moon-icon-huge" id="weatherMoonIcon">@Model.Weather.MoonIcon</span>
                        </div>
                        <div class="moon-text">
                            <span>Moon Phase</span>
                            <strong id="weatherMoonPhase">@Model.Weather.MoonPhase</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 5-Day Forecast -->
        <h3 class="panel-subtitle">5-Day Forecast</h3>
        <div class="weather-forecast-list" id="panelForecastList">
            @foreach (var day in Model.Weather.Forecasts)
            {
                <div class="forecast-item">
                    <span class="day-name">@day.Date</span>
                    <span class="day-icon">@day.Icon</span>
                    <div class="day-temps">
                        <span class="max">@Math.Round(day.MaxTemp)¬∞</span>
                        <span class="min">@Math.Round(day.MinTemp)¬∞</span>
                    </div>
                    <span class="day-desc">@day.Description</span>
                </div>
            }
        </div>
    </div>
</div>

<!-- Currency Details Panel -->
<div class="details-panel" id="currencyDetails">
    <div class="panel-header">
        <h2>Currency Converter</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <form id="currencyForm" class="detail-form">
            <div class="currency-converter-card">
                <div class="form-group">
                    <label>Amount to Convert</label>
                    <input type="number" id="convertAmount" value="1" class="form-control" step="any" />
                </div>
                
                <div class="currency-horizontal-row">
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">From</span>
                        <div class="custom-currency-select" id="fromCurrencyWrapper">
                            <div class="select-header" onclick="focusInput('fromSearch')">
                                <span class="select-icon">üí∞</span>
                                <input type="text" class="btn-search-input" id="fromSearch" placeholder="Search..." data-target="fromCurrencySelect" autocomplete="off" />
                            </div>
                            <div class="custom-options" id="fromOptions">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    var info = TodoListApp.Services.ExternalApiService.GetCurrencyInfo(curr);
                                    <div class="option-item" data-value="@curr" data-text="@info.Flag @curr - @info.Country" data-country="@info.Country">
                                        <span class="opt-flag">@info.Flag</span>
                                        <span class="opt-code">@curr</span>
                                        <span class="opt-country">@info.Country</span>
                                    </div>
                                }
                            </div>
                            <select id="fromCurrencySelect" name="fromCurrency" style="display: none;">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    <option value="@curr" selected="@(curr == Model.FromCurrency)">@curr</option>
                                }
                            </select>
                        </div>
                    </div>
                    
                    <button type="button" class="central-swap-circle" id="swapCurrencies" title="Swap currencies">‚áÑ</button>
                    
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">To</span>
                        <div class="custom-currency-select" id="toCurrencyWrapper">
                            <div class="select-header" onclick="focusInput('toSearch')">
                                <span class="select-icon">üéØ</span>
                                <input type="text" class="btn-search-input" id="toSearch" placeholder="Search..." data-target="toCurrencySelect" autocomplete="off" />
                            </div>
                            <div class="custom-options" id="toOptions">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    var info = TodoListApp.Services.ExternalApiService.GetCurrencyInfo(curr);
                                    <div class="option-item" data-value="@curr" data-text="@info.Flag @curr - @info.Country" data-country="@info.Country">
                                        <span class="opt-flag">@info.Flag</span>
                                        <span class="opt-code">@curr</span>
                                        <span class="opt-country">@info.Country</span>
                                    </div>
                                }
                            </div>
                            <select id="toCurrencySelect" name="toCurrency" style="display: none;">
                                @foreach(var curr in Model.AvailableCurrencies) {
                                    <option value="@curr" selected="@(curr == Model.ToCurrency)">@curr</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="result-display">
                    <div class="result-header">Converted Amount</div>
                    <div class="conversion-result-row">
                        <div id="conversionResult" class="conversion-val">@Model.Currency.Rate</div>
                        <div id="rateMovement" class="movement-badge @(Model.Currency.IsUp == null ? "d-none" : (Model.Currency.IsUp == true ? "up" : "down"))">
                            @(Model.Currency.IsUp == true ? "‚Üë" : "‚Üì")
                        </div>
                    </div>
                    <div id="baseRateInfo" class="rate-info">1 @Model.Currency.From = @Model.Currency.Rate @Model.Currency.To</div>
                    <div id="currencyTimestamp" class="sync-time">Last Synced: @Model.Currency.LastUpdated</div>
                </div>
            </div>
        </form>

        <div class="currency-stats">
            <div class="chart-box">
                <h3 class="panel-subtitle">Market History (Last 7 Days)</h3>
                <div class="chart-container-large">
                    <canvas id="currencyChartFull"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time Details Panel -->
<div class="details-panel" id="timeDetails">
    <div class="panel-header">
        <h2>World Clock & Converter</h2>
        <button class="close-panel" onclick="closeDetails()">√ó</button>
    </div>
    <div class="panel-content">
        <form id="timeForm" class="detail-form">
            <div class="header-controls">
                <div class="format-toggle">
                    <span class="toggle-label">12H</span>
                    <label class="switch">
                        <input type="checkbox" id="timeFormatToggle" onchange="refreshTimeData(); refreshLocalClock();">
                        <span class="slider round"></span>
                    </label>
                    <span class="toggle-label">24H</span>
                </div>
            </div>

            <div class="currency-converter-card">
                <div class="form-group">
                    <label>Time to Convert</label>
                    <input type="time" id="convertTimeInput" class="form-control" />
                    <small class="text-muted">Defaults to current time if left empty</small>
                </div>
                
                <div class="currency-horizontal-row">
                    <div class="currency-btn-item">
                        <span class="btn-mini-label">Source Zone</span>
                        <div class="custom-currency-select" id="sourceTimeWrapper">
                            <div class="select-header" onclick="focusInput('sourceTimeSearch')">
                                <span class="select-icon">üìç</span>
                                <input type="text" class="btn-search-input" id="sourceTimeSearch" placeholder="Search city/country..." autocomplete="off" />
                            </div>
                            <div class="custom-options" id="sourceTimeOptions">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <div class="option-item" data-value="@tz.Id" data-text="@tz.Name" data-full="@tz.FullName">
                                        <span class="opt-code">@tz.Offset</span>
                                        <span class="opt-country">@tz.Name</span>
                                    </div>
                                }
                            </div>
                            <select id="sourceTimeSelect" name="sourceTime" style="display: none;">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <option value="@tz.Id" selected="@(tz.Id == Model.SourceTimeZone)">@tz.Name</option>
                                }
                            </select>
                        </div>
                    </div>

                    <button type="button" class="central-swap-circle" id="swapTimeZones" title="Swap timezones">‚áÑ</button>

                    <div class="currency-btn-item">
                        <span class="btn-mini-label">Target Zone</span>
                        <div class="custom-currency-select" id="targetTimeWrapper">
                            <div class="select-header" onclick="focusInput('targetTimeSearch')">
                                <span class="select-icon">üåè</span>
                                <input type="text" class="btn-search-input" id="targetTimeSearch" placeholder="Search city/country..." autocomplete="off" />
                            </div>
                            <div class="custom-options" id="targetTimeOptions">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <div class="option-item" data-value="@tz.Id" data-text="@tz.Name" data-full="@tz.FullName">
                                        <span class="opt-code">@tz.Offset</span>
                                        <span class="opt-country">@tz.Name</span>
                                    </div>
                                }
                            </div>
                            <select id="targetTimeSelect" name="targetTime" style="display: none;">
                                @foreach(var tz in Model.AvailableTimeZones) {
                                    <option value="@tz.Id" selected="@(tz.Id == Model.TargetTimeZone)">@tz.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="result-display">
                    <div class="result-header">Converted Time</div>
                    <div class="conversion-result-row">
                        <div id="timeResultVal" class="conversion-val">@Model.TimeConversion.TargetTime</div>
                        <div id="timeAbbr" class="tz-abbr-badge">@Model.TimeConversion.TargetAbbr</div>
                        <div id="timeDayChange" class="day-change-badge @(Model.TimeConversion.DayChange == "Same Day" ? "d-none" : "")">@Model.TimeConversion.DayChange</div>
                    </div>
                    <div id="timeOffsetInfo" class="rate-info">Difference: @Model.TimeConversion.OffsetDisplay hours</div>
                </div>
            </div>
        </form>

        <h3 class="panel-subtitle">Global Overview</h3>
        <div class="world-clock-list">
            <div class="clock-row">
                <span class="city">New York</span>
                <span class="time" data-tz="America/New_York">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city">London</span>
                <span class="time" data-tz="Europe/London">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city">Mumbai</span>
                <span class="time" data-tz="Asia/Kolkata">--:--</span>
            </div>
            <div class="clock-row">
                <span class="city">Tokyo</span>
                <span class="time" data-tz="Asia/Tokyo">--:--</span>
            </div>
            <div class="clock-row">
                 <span class="city">Dubai</span>
                 <span class="time" data-tz="Asia/Dubai">--:--</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- Widget Detail Management ---
        function openDetails(type) {
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(type + 'Details').classList.add('active');
            document.getElementById('detailsOverlay').classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scroll

            // Load chart if it's currency
            if (type === 'currency') {
                loadCurrencyHistory();
            }
            
            if (type === 'weather') {
                // Check if we should auto-geolocate
                // (optional: can be done automatically on load, but let's link it to the button too)
            }
        }

        function closeDetails() {
            document.querySelectorAll('.details-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('detailsOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }


        // --- 1. World Clocks ---
        function updateWorldClocks() {
            const clocks = document.querySelectorAll('.time[data-tz]');
            const now = new Date();
            clocks.forEach(clock => {
                const tz = clock.getAttribute('data-tz');
                try {
                    const timeString = now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit' });
                    clock.textContent = timeString;
                } catch (e) {
                    console.error("Invalid Timezone", tz);
                }
            });
        }
        setInterval(updateWorldClocks, 1000);
        updateWorldClocks();

        // --- 2. Currency Chart (Detailed) ---
        const ctxFull = document.getElementById('currencyChartFull')?.getContext('2d');
        let currencyChartFull;

        async function loadCurrencyHistory() {
            if (!ctxFull) return;
            const from = fromSelect?.value || '@Model.FromCurrency';
            const to = toSelect?.value || '@Model.ToCurrency';
            
            try {
                // Specifically request 7 days of history
                const res = await fetch(`/Todo/GetCurrencyHistoryJson?from=${from}&to=${to}&days=7`);
                const data = await res.json();
                
                if(data.labels && data.values) {
                    if (currencyChartFull) currencyChartFull.destroy();
                    
                    currencyChartFull = new Chart(ctxFull, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: `${from} to ${to} (7D Trend)`,
                                data: data.values,
                                borderColor: '#818cf8',
                                backgroundColor: 'rgba(129, 140, 248, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#818cf8',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: true, labels: { color: 'rgba(255,255,255,0.7)', font: { size: 12 } } },
                                tooltip: {
                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    borderColor: 'rgba(255,255,255,0.1)',
                                    borderWidth: 1
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)', maxRotation: 45, minRotation: 45 },
                                    grid: { display: false }
                                },
                                y: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)' },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load chart", e);
            }
        }

        // --- 3. Ticking Converter Clocks (Summary & Panel) ---
        function startConverterClocks() {
            const displays = [
                document.getElementById('summaryTargetTime'),
                document.getElementById('panelTargetTime')
            ];

            function update() {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                
                displays.forEach(display => {
                    if(!display) return;
                    const offsetMinutes = parseFloat(display.getAttribute('data-offset'));
                    if(isNaN(offsetMinutes)) return;
                    const targetTime = new Date(utc + (offsetMinutes * 60000));
                    display.textContent = targetTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                });
            }
            
            setInterval(update, 1000);
            update();
        }
        // --- 4. Auto-Open Panels on Reload ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('city')) openDetails('weather');
            if (params.has('fromCurrency') || params.has('toCurrency')) openDetails('currency');
            if (params.has('sourceTime') || params.has('targetTime')) openDetails('time');
        });

        // --- 5. Geolocation & AJAX Search ---
        const geolocateBtn = document.getElementById('geolocateBtn');
        const weatherForm = document.getElementById('weatherSearchForm');
        const weatherInput = document.getElementById('weatherSearchInput');
        const weatherSubmit = document.getElementById('weatherSearchSubmit');

        if (weatherForm) {
            weatherForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const city = weatherInput.value.trim();
                if (!city) return;

                weatherSubmit.disabled = true;
                weatherSubmit.textContent = 'Searching...';

                try {
                    const response = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(city)}`);
                    const data = await response.json();
                    if (data.description === "City not found") {
                        alert("City not found. Please try a different name.");
                    } else {
                        updateWeatherUI(data);
                    }
                } catch (e) {
                    alert("Failed to fetch weather data.");
                } finally {
                    weatherSubmit.disabled = false;
                    weatherSubmit.textContent = 'Search';
                }
            });
        }

        if (geolocateBtn) {
            geolocateBtn.addEventListener('click', () => {
                if (navigator.geolocation) {
                    geolocateBtn.classList.add('loading');
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            try {
                                const response = await fetch(`/Todo/GetWeatherByCoordsJson?lat=${latitude}&lon=${longitude}`);
                                const data = await response.json();
                                updateWeatherUI(data);
                                geolocateBtn.classList.remove('loading');
                            } catch (e) {
                                alert("Failed to fetch weather for your location.");
                                geolocateBtn.classList.remove('loading');
                            }
                        },
                        (error) => {
                            alert("Location access denied. Please use manual search.");
                            geolocateBtn.classList.remove('loading');
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            });
        }

        function updateWeatherUI(data) {
            // 1. Update Layout/Header
            let title = data.city || "My Location";
            if (data.localArea && data.localArea !== data.city) {
                title = `${data.localArea}, ${data.city}`;
            }
            document.getElementById('weatherLocation').textContent = title;

            const subLocParts = [];
            if (data.district && data.district !== data.city && data.district !== data.localArea) subLocParts.push(data.district);
            if (data.state) subLocParts.push(data.state);
            if (data.country) subLocParts.push(data.country);
            
            const subLoc = document.getElementById('weatherSubLocation');
            if (subLoc) subLoc.textContent = subLocParts.join(', ');
            document.getElementById('weatherCoords').textContent = `Lat: ${data.latitude.toFixed(4)} | Lon: ${data.longitude.toFixed(4)}`;

            // 2. Update Summary Widget
            const weatherSummary = document.querySelector('.insight-card.weather');
            if (weatherSummary) {
                weatherSummary.querySelector('.insight-icon').textContent = data.icon;
                weatherSummary.querySelector('.insight-value').textContent = data.temperature + '¬∞C';
                weatherSummary.querySelector('.insight-meta').textContent = title + ' ‚Ä¢ ' + data.description;
            }

            // 3. Update Detail Panel Hero
            document.getElementById('panelWeatherIcon').textContent = data.icon;
            document.getElementById('panelTemperature').textContent = data.temperature + '¬∞C';
            document.getElementById('panelDescription').textContent = `${data.description} in ${data.city}`;

            // 4. Update Detailed Metrics
            document.getElementById('weatherFeelsLike').textContent = data.feelsLike + '¬∞C';
            document.getElementById('weatherHumidity').textContent = data.humidity + '%';
            document.getElementById('weatherWind').textContent = data.windSpeed + ' km/h';
            document.getElementById('weatherWindDir').textContent = `Dir: ${data.windDirection}¬∞`;
            document.getElementById('weatherVisibility').textContent = data.visibility.toFixed(1) + ' km';
            document.getElementById('weatherPressure').textContent = data.pressure + ' hPa';
            document.getElementById('weatherDewPoint').textContent = data.dewPoint + '¬∞C';

            // 5. Update AQI & UV
            document.getElementById('weatherAQI').textContent = data.aqi;
            document.getElementById('weatherAQILevel').textContent = data.aqiLevel;
            document.getElementById('weatherUV').textContent = data.uvIndex;
            document.getElementById('weatherUVRisk').textContent = data.uvRisk;

            // 6. Update Sun & Moon
            document.getElementById('weatherSunrise').textContent = data.sunrise;
            document.getElementById('weatherSunset').textContent = data.sunset;
            document.getElementById('weatherMoonrise').textContent = data.moonrise;
            document.getElementById('weatherMoonset').textContent = data.moonset;
            document.getElementById('weatherMoonPhase').textContent = data.moonPhase;
            document.getElementById('weatherMoonIcon').textContent = data.moonIcon;

            // 7. Update Forecast
            const forecastList = document.getElementById('panelForecastList');
            if (forecastList && data.forecasts) {
                forecastList.innerHTML = data.forecasts.map(day => `
                    <div class="forecast-item">
                        <span class="day-name">${day.date}</span>
                        <span class="day-icon">${day.icon}</span>
                        <div class="day-temps">
                            <span class="max">${Math.round(day.maxTemp)}¬∞</span>
                            <span class="min">${Math.round(day.minTemp)}¬∞</span>
                        </div>
                        <span class="day-desc">${day.description}</span>
                    </div>
                `).join('');
            }
            
            const cityInput = document.querySelector('input[name="city"]');
            if (cityInput) cityInput.value = data.city;
        }

        // Auto-Geolocate logic moved to initDashboard to avoid redundancy

        // --- 6. Currency Converter AJAX ---
        const currencyForm = document.getElementById('currencyForm');
        const fromSelect = document.getElementById('fromCurrencySelect');
        const toSelect = document.getElementById('toCurrencySelect');
        const amountInput = document.getElementById('convertAmount');
        const swapBtn = document.getElementById('swapCurrencies');
        
        let currentRate = @Model.Currency.Rate;

        async function refreshCurrencyData() {
            console.log(">>> refreshCurrencyData() called");
            const from = fromSelect.value;
            const to = toSelect.value;
            console.log("Currency pair:", from, "to", to);
            const card = document.querySelector('.insight-card.currency');
            try {
                const res = await fetch(`/Todo/GetCurrencyJson?from=${from}&to=${to}`);
                console.log("Currency API response status:", res.status);
                const data = await res.json();
                console.log("Currency data received:", data);
                currentRate = data.rate;
                updateCurrencyUI(data);
                loadCurrencyHistory(); // Refresh chart too
                console.log("<<< refreshCurrencyData() complete");
            } catch (e) {
                console.error("Currency fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        function updateCurrencyUI(data) {
            // Update Summary Widget
            const summaryWidget = document.querySelector('.insight-card.currency');
            if (summaryWidget) {
                summaryWidget.classList.remove('loading');
                const rateEl = document.getElementById('summaryCurrencyRate');
                if (rateEl) rateEl.textContent = data.rate;
                const metaEl = document.getElementById('summaryTimeMeta'); // reused meta if exists or others
                const subMetaEl = document.getElementById('summaryCurrencyMeta');
                if (subMetaEl) subMetaEl.textContent = `1 ${data.from} = ${data.rate} ${data.to}`;
            }
            
            // Update Panel Result
            document.getElementById('baseRateInfo').textContent = `1 ${data.from} = ${data.rate} ${data.to}`;
            document.getElementById('currencyTimestamp').textContent = `Last Synced: ${data.lastUpdated}`;
            
            const movementBadge = document.getElementById('rateMovement');
            if (movementBadge) {
                movementBadge.classList.remove('d-none', 'up', 'down');
                if (data.isUp === true) {
                    movementBadge.textContent = '‚Üë';
                    movementBadge.classList.add('up');
                } else if (data.isUp === false) {
                    movementBadge.textContent = '‚Üì';
                    movementBadge.classList.add('down');
                } else {
                    movementBadge.classList.add('d-none');
                }
            }

            calculateResult();
        }

        function calculateResult() {
            if (!amountInput) return;
            const amount = parseFloat(amountInput.value) || 0;
            const result = (amount * currentRate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 4 });
            const resultDisplay = document.getElementById('conversionResult');
            if (resultDisplay) resultDisplay.textContent = result;
        }

        if (fromSelect) fromSelect.addEventListener('change', refreshCurrencyData);
        if (toSelect) toSelect.addEventListener('change', refreshCurrencyData);
        if (amountInput) amountInput.addEventListener('input', calculateResult);
        // Helper to focus input
        window.focusInput = function(id) {
            const el = document.getElementById(id);
            if (el) {
                el.focus();
                const wrapper = el.closest('.custom-currency-select');
                if (wrapper) wrapper.classList.add('active');
            }
        };

        // Custom Dropdown & Search Logic (shared by Currency & Time)
        document.querySelectorAll('.custom-currency-select').forEach(wrapper => {
            const input = wrapper.querySelector('.btn-search-input');
            const options = wrapper.querySelector('.custom-options');
            const select = wrapper.querySelector('select');
            const isTime = wrapper.id.includes('Time');
            
            // Set initial value
            if (select && input) {
                const opt = select.options[select.selectedIndex];
                if (opt) input.value = opt.text.trim();
            }

            input.addEventListener('focus', () => {
                wrapper.classList.add('active');
                input.select();
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('active');
                }
            });

            // Filtering
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase().trim();
                const items = options.querySelectorAll('.option-item');
                items.forEach(item => {
                    const text = item.getAttribute('data-text').toLowerCase();
                    const fullName = item.getAttribute('data-full')?.toLowerCase() || "";
                    const match = text.includes(term) || fullName.includes(term);
                    item.style.display = match ? 'flex' : 'none';
                });
            });

            // Selection
            options.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', () => {
                    const val = item.getAttribute('data-value');
                    select.value = val;
                    input.value = item.getAttribute('data-text').trim();
                    wrapper.classList.remove('active');
                    
                    if (isTime) {
                        refreshTimeData();
                    } else {
                        refreshCurrencyData();
                    }
                });
            });

            // Enter Key - Resolution (Only for Currency)
            if (!isTime) {
                input.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const term = input.value.trim();
                        
                        // 1. Direct match check
                        const items = Array.from(options.querySelectorAll('.option-item'));
                        const directMatch = items.find(it => 
                            it.getAttribute('data-value').toLowerCase() === term.toLowerCase() ||
                            it.getAttribute('data-country')?.toLowerCase() === term.toLowerCase()
                        );

                        if (directMatch) {
                            const val = directMatch.getAttribute('data-value');
                            select.value = val;
                            input.value = directMatch.getAttribute('data-text').trim();
                            refreshCurrencyData();
                        } else {
                            // 2. Resolve via Geocoding
                            input.classList.add('resolving');
                            try {
                                const res = await fetch(`/Todo/ResolveCurrencyByLocation?location=${encodeURIComponent(term)}`);
                                const data = await res.json();
                                if (data.currencyCode) {
                                    select.value = data.currencyCode;
                                    const newMatch = items.find(it => it.getAttribute('data-value') === data.currencyCode);
                                    if (newMatch) input.value = newMatch.getAttribute('data-text').trim();
                                    refreshCurrencyData();
                                } else {
                                    alert("Could not resolve location: " + term);
                                }
                            } catch (err) {
                                console.error("Resolution failed", err);
                            } finally {
                                input.classList.remove('resolving');
                            }
                        }
                        input.blur();
                        wrapper.classList.remove('active');
                    }
                });
            } else {
                // Time-specific Enter check
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const term = input.value.toLowerCase().trim();
                        const items = Array.from(options.querySelectorAll('.option-item'));
                        const match = items.find(it => 
                            it.getAttribute('data-text').toLowerCase().includes(term) ||
                            it.getAttribute('data-full')?.toLowerCase().includes(term)
                        );
                        if (match) match.click();
                        input.blur();
                    }
                });
            }
        });

        // Updated Swap Logic for Unified Buttons
        const updateInputText = (input, val) => {
            const wrapper = input.closest('.custom-currency-select');
            const item = wrapper.querySelector(`.option-item[data-value="${val}"]`);
            if (item) input.value = item.getAttribute('data-text').trim();
        };

        document.getElementById('swapCurrencies')?.addEventListener('click', () => {
            const fromSelect = document.getElementById('fromCurrencySelect');
            const toSelect = document.getElementById('toCurrencySelect');
            const fromInput = document.getElementById('fromSearch');
            const toInput = document.getElementById('toSearch');

            if (!fromSelect || !toSelect) return;

            const tempVal = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempVal;

            if (fromInput) updateInputText(fromInput, fromSelect.value);
            if (toInput) updateInputText(toInput, toSelect.value);

            refreshCurrencyData();
        });

        document.getElementById('swapTimeZones')?.addEventListener('click', () => {
            const srcSel = document.getElementById('sourceTimeSelect');
            const targetSel = document.getElementById('targetTimeSelect');
            const srcInput = document.getElementById('sourceTimeSearch');
            const targetInput = document.getElementById('targetTimeSearch');

            if (!srcSel || !targetSel) return;

            const temp = srcSel.value;
            srcSel.value = targetSel.value;
            targetSel.value = temp;

            if (srcInput) updateInputText(srcInput, srcSel.value);
            if (targetInput) updateInputText(targetInput, targetSel.value);

            refreshTimeData();
        });

        // --- 7. Time Converter AJAX ---
        const timeForm = document.getElementById('timeForm');
        const sourceSelect = document.getElementById('sourceTimeSelect');
        const targetSelect = document.getElementById('targetTimeSelect');
        const timeInput = document.getElementById('convertTimeInput');

        if (timeInput) timeInput.addEventListener('input', refreshTimeData);

        async function refreshTimeData() {
            console.log(">>> refreshTimeData() called");
            if (!sourceSelect || !targetSelect) {
                console.warn("Time selects not found!");
                return;
            }
            const source = sourceSelect.value;
            const target = targetSelect.value;
            const time = timeInput ? timeInput.value : '';
            console.log("Time zones:", source, "to", target, "time:", time);
            const card = document.querySelector('.insight-card.time');

            try {
                const res = await fetch(`/Todo/GetTimeJson?source=${encodeURIComponent(source)}&target=${encodeURIComponent(target)}&time=${encodeURIComponent(time)}`);
                console.log("Time API response status:", res.status);
                const data = await res.json();
                console.log("Time data received:", data);
                updateTimeUI(data);
                console.log("<<< refreshTimeData() complete");
            } catch (e) {
                console.error("Time fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        function updateTimeUI(data) {
            const is12h = document.getElementById('timeFormatToggle')?.checked;
            
            // Format time helper
            const formatTime = (timeStr) => {
                if (!is12h) return timeStr;
                const [h, m] = timeStr.split(':');
                const hours = parseInt(h);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const h12 = hours % 12 || 12;
                return `${h12}:${m} ${ampm}`;
            };

            const timeWidget = document.querySelector('.insight-card.time');
            if (timeWidget) {
                timeWidget.classList.remove('loading');
                const targetDisplay = document.getElementById('summaryTargetTime');
                if (targetDisplay) {
                    targetDisplay.textContent = formatTime(data.targetTime);
                    targetDisplay.setAttribute('data-offset', data.totalOffsetMinutes);
                }
                const metaDisplay = document.getElementById('summaryTimeMeta');
                if (metaDisplay) metaDisplay.textContent = data.targetZone;
            }

            const resultVal = document.getElementById('timeResultVal');
            if (resultVal) resultVal.textContent = formatTime(data.targetTime);

            const abbrBadge = document.getElementById('timeAbbr');
            if (abbrBadge) abbrBadge.textContent = data.targetAbbr || 'UTC';

            const dayChangeBadge = document.getElementById('timeDayChange');
            if (dayChangeBadge) {
                dayChangeBadge.textContent = data.dayChange;
                if (data.dayChange === "Same Day" || !data.dayChange) {
                    dayChangeBadge.classList.add('d-none');
                } else {
                    dayChangeBadge.classList.remove('d-none');
                    dayChangeBadge.className = 'day-change-badge'; // reset
                    if (data.dayChange === "Next Day") dayChangeBadge.classList.add('next-day');
                    if (data.dayChange === "Previous Day") dayChangeBadge.classList.add('prev-day');
                }
            }

            const offsetInfo = document.getElementById('timeOffsetInfo');
            if (offsetInfo) {
                offsetInfo.textContent = `Difference: ${data.offsetDisplay} hours`;
            }
        }

        if (sourceSelect) sourceSelect.addEventListener('change', refreshTimeData);
        if (targetSelect) targetSelect.addEventListener('change', refreshTimeData);
        if (timeInput) timeInput.addEventListener('input', refreshTimeData);
        
        if (swapTimeBtn) {
            swapTimeBtn.addEventListener('click', () => {
                const temp = sourceSelect.value;
                sourceSelect.value = targetSelect.value;
                targetSelect.value = temp;
                refreshTimeData();
            });
        }

        // --- 9. GLOBAL INITIALIZATION ---
        async function initDashboard() {
            console.log(">>> initDashboard() started");

            let city = '@Model.SelectedCity';
            console.log("Initial city:", city);
            
            // Try browser geolocation first if no city specified
            if (!city || city === "London") {
                if (navigator.geolocation) {
                    try {
                        console.log("Attempting geolocation...");
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 3000 });
                        });
                        const { latitude, longitude } = position.coords;
                        const res = await fetch(`/Todo/GetWeatherByCoordsJson?lat=${latitude}&lon=${longitude}`);
                        const data = await res.json();
                        updateWeatherUI(data);
                        city = data.city;
                        console.log("Geolocation successful, city:", city);
                    } catch (err) {
                        console.warn("Geolocation failed, using default city");
                    }
                }
            }

            // Always fetch data on page load
            const finalCity = city || "London";
            console.log("Fetching data for city:", finalCity);
            
            console.log("Calling refreshWeatherData...");
            refreshWeatherData(finalCity);
            
            console.log("Calling refreshCurrencyData...");
            refreshCurrencyData();
            
            console.log("Calling refreshTimeData...");
            refreshTimeData();
            
            console.log("<<< initDashboard() complete");
        }

        // Modified weather fetch for init
        async function refreshWeatherData(cityValue) {
            console.log(">>> refreshWeatherData() called for:", cityValue);
            const card = document.querySelector('.insight-card.weather');
            try {
                const response = await fetch(`/Todo/GetWeatherJson?city=${encodeURIComponent(cityValue)}`);
                console.log("Weather API response status:", response.status);
                const data = await response.json();
                console.log("Weather data received:", data);
                updateWeatherUI(data);
                if (card) card.classList.remove('loading');
                console.log("<<< refreshWeatherData() complete");
            } catch (e) {
                console.error("Weather fetch failed:", e);
                if (card) card.classList.remove('loading');
            }
        }

        // --- 10. Local Clock & Timezone Detection ---
        function refreshLocalClock() {
            const timeDisplay = document.getElementById('localClockTime');
            const dateDisplay = document.getElementById('localClockDate');
            const formatToggle = document.getElementById('timeFormatToggle');
            const now = new Date();
            const is12h = formatToggle ? !formatToggle.checked : true; // Inverted check logic if toggle is structured as 12H-24H
            
            // Get checked state: our toggle is [checked=24H]
            const use24h = formatToggle ? formatToggle.checked : false;

            if (timeDisplay) {
                timeDisplay.textContent = now.toLocaleTimeString(undefined, { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit', 
                    hour12: !use24h 
                });
            }
            if (dateDisplay) dateDisplay.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function startLocalClock() {
            const tzLabel = document.getElementById('localTzLabel');
            const userTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (tzLabel) tzLabel.textContent = userTz;

            // Attempt to sync Source Zone in converter
            const sourceSel = document.getElementById('sourceTimeSelect');
            const sourceInput = document.getElementById('sourceTimeSearch');
            if (sourceSel && sourceInput) {
                 const ianaCity = userTz.split('/').pop().replace('_', ' ');
                 Array.from(sourceSel.options).forEach(opt => {
                     // Check for IANA ID match or descriptive match
                     if (opt.value === userTz || opt.text.includes(ianaCity)) {
                         sourceSel.value = opt.value;
                         updateInputText(sourceInput, opt.value);
                     }
                 });
            }

            refreshLocalClock();
            setInterval(refreshLocalClock, 1000);
        }

        // --- 9. Initialization ---
        function initializeAll() {
            console.log("=== INITIALIZING DASHBOARD ===");
            initDashboard();
            startConverterClocks();
            updateWorldClocks();
            startLocalClock();
            console.log("=== INITIALIZATION COMPLETE ===");
        }

        // Run immediately if DOM is already loaded, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAll);
        } else {
            // DOM is already loaded, run immediately
            initializeAll();
        }
    </script>
}
