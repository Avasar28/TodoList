@model TodoListApp.ViewModels.DashboardViewModel

@{
    ViewData["Title"] = "Real-time Dashboard";
}

<div class="dashboard-container centered-view">
    <div class="dashboard-header text-center">
        <h1>Welcome, @Model.UserName</h1>
        <p class="subtitle">Your personalized dashboard.</p>
        <button id="saveDefaultsBtn" class="btn-secondary-glass" style="margin-top: 1rem;">
            <span>üíæ Save Current View as Default</span>
        </button>
    </div>

    <div class="realtime-grid featured-grid">
        <!-- Weather Widget -->
        <div class="insight-card featured weather">
            <div class="insight-icon">@Model.Weather.Icon</div>
            <div class="insight-info">
                <form method="get" asp-action="Dashboard" class="widget-form">
                    <input type="text" name="city" value="@Model.SelectedCity" class="widget-input" placeholder="Enter City" onchange="this.form.submit()" />
                    <input type="hidden" name="fromCurrency" value="@Model.FromCurrency" />
                    <input type="hidden" name="toCurrency" value="@Model.ToCurrency" />
                    <input type="hidden" name="sourceTime" value="@Model.SourceTimeZone" />
                    <input type="hidden" name="targetTime" value="@Model.TargetTimeZone" />
                </form>
                <div class="weather-display">
                    <span class="insight-value">@Model.Weather.Temperature¬∞C</span>
                    <span class="insight-meta">@Model.Weather.Description</span>
                </div>
                 @if (Model.Weather.Forecasts.Any())
                {
                    <div class="weather-forecast">
                        @foreach (var day in Model.Weather.Forecasts)
                        {
                            <div class="forecast-day">
                                <span class="day-name">@day.Date</span>
                                <span class="day-icon">@day.Icon</span>
                                <span class="day-temp">@Math.Round(day.MaxTemp)¬∞ / @Math.Round(day.MinTemp)¬∞</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Currency Widget -->
        <div class="insight-card featured currency">
            <div class="insight-icon">üí±</div>
            <div class="insight-info">
                 <form method="get" asp-action="Dashboard" class="widget-form">
                    <div class="currency-selectors">
                        <select name="fromCurrency" asp-for="FromCurrency" asp-items="@(new SelectList(Model.AvailableCurrencies))" class="widget-select" onchange="this.form.submit()"></select>
                        <span class="arrow">‚ûú</span>
                        <select name="toCurrency" asp-for="ToCurrency" asp-items="@(new SelectList(Model.AvailableCurrencies))" class="widget-select" onchange="this.form.submit()"></select>
                    </div>
                    <input type="hidden" name="city" value="@Model.SelectedCity" />
                    <input type="hidden" name="sourceTime" value="@Model.SourceTimeZone" />
                    <input type="hidden" name="targetTime" value="@Model.TargetTimeZone" />
                </form>
                <div class="currency-display">
                    <span class="insight-value">@Model.Currency.Rate</span>
                    <span class="insight-meta">1 @Model.Currency.From = @Model.Currency.Rate @Model.Currency.To</span>
                </div>
                 <div class="chart-container">
                    <canvas id="currencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- World Clock Widget (Replaces simple Time widget) -->
        <div class="insight-card featured time">
            <div class="insight-icon">üåç</div>
            <div class="insight-info" style="width: 100%;">
                 <div class="world-clock-grid">
                     <div class="clock-item">
                         <span class="clock-city">New York</span>
                         <span class="clock-time" data-tz="America/New_York">--:--</span>
                     </div>
                     <div class="clock-item">
                         <span class="clock-city">London</span>
                         <span class="clock-time" data-tz="Europe/London">--:--</span>
                     </div>
                     <div class="clock-item">
                         <span class="clock-city">Dubai</span>
                         <span class="clock-time" data-tz="Asia/Dubai">--:--</span>
                     </div>
                      <div class="clock-item">
                         <span class="clock-city">Mumbai</span>
                         <span class="clock-time" data-tz="Asia/Kolkata">--:--</span>
                     </div>
                     <div class="clock-item">
                         <span class="clock-city">Tokyo</span>
                         <span class="clock-time" data-tz="Asia/Tokyo">--:--</span>
                     </div>
                 </div>
                 
                 <!-- Original Time Converter Button/Link if needed -->
                 <div style="margin-top: 1rem; font-size: 0.8rem; text-align: center;">
                      <form method="get" asp-action="Dashboard" class="widget-form time-form">
                        <div class="time-selectors">
                            <label>From</label>
                            <select name="sourceTime" asp-for="SourceTimeZone" asp-items="@(new SelectList(Model.AvailableTimeZones))" class="widget-select full-width" onchange="this.form.submit()"></select>
                            <label>To</label>
                            <select name="targetTime" asp-for="TargetTimeZone" asp-items="@(new SelectList(Model.AvailableTimeZones))" class="widget-select full-width" onchange="this.form.submit()"></select>
                        </div>
                         <div class="time-display" style="margin-top: 5px;">
                            <span class="insight-value" id="converterTargetTime" data-offset="@Model.TimeConversion.TotalOffsetMinutes">@Model.TimeConversion.TargetTime</span>
                        </div>
                        <input type="hidden" name="city" value="@Model.SelectedCity" />
                        <input type="hidden" name="fromCurrency" value="@Model.FromCurrency" />
                        <input type="hidden" name="toCurrency" value="@Model.ToCurrency" />
                    </form>
                 </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('saveDefaultsBtn').addEventListener('click', async () => {
            const preferences = {
                defaultCity: document.querySelector('input[name="city"]').value,
                defaultFromCurrency: document.querySelector('select[name="fromCurrency"]').value,
                defaultToCurrency: document.querySelector('select[name="toCurrency"]').value,
                defaultSourceTimeZone: document.querySelector('select[name="sourceTime"]').value,
                defaultTargetTimeZone: document.querySelector('select[name="targetTime"]').value
            };

            try {
                const response = await fetch('/Todo/UpdatePreferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(preferences)
                });

                if (response.ok) {
                    alert('Preferences saved successfully!');
                } else {
                    alert('Failed to save preferences.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred.');
            }
        });
    </script>
}

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- 1. World Clock ---
        function updateWorldClocks() {
            const clocks = document.querySelectorAll('.clock-time');
            const now = new Date();
            clocks.forEach(clock => {
                const tz = clock.getAttribute('data-tz');
                try {
                    const timeString = now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit' });
                    clock.textContent = timeString;
                } catch (e) {
                    console.error("Invalid Timezone", tz);
                }
            });
        }
        setInterval(updateWorldClocks, 1000);
        updateWorldClocks(); // Init

        // --- 2. Currency Chart ---
        const ctx = document.getElementById('currencyChart').getContext('2d');
        let currencyChart;

        async function loadCurrencyHistory() {
            const from = '@Model.FromCurrency';
            const to = '@Model.ToCurrency';
            
            try {
                const res = await fetch(`/Todo/GetCurrencyHistoryJson?from=${from}&to=${to}`);
                const data = await res.json();
                
                if(data.labels && data.values) {
                    if (currencyChart) currencyChart.destroy();
                    
                    currencyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: `${from} to ${to}`,
                                data: data.values,
                                borderColor: '#818cf8',
                                backgroundColor: 'rgba(129, 140, 248, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }, // Hide legend to save space
                            scales: {
                                x: { display: false }, // Hide x-axis labels for clean look
                                y: { 
                                    ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 10 } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Failed to load chart", e);
            }
        }
        loadCurrencyHistory();

        // --- 3. Auto-Refresh (Polling) ---
        // Refresh Weather every 10 mins (600,000 ms)
        setInterval(async () => {
             const city = '@Model.SelectedCity';
             try {
                const res = await fetch(`/Todo/GetWeatherJson?city=${city}`);
                const data = await res.json();
                // Update DOM elements if IDs were assigned (simplified for now to just log or reload part)
                // ideally, we'd update spans. implementing generic reload for simplicity in this demo:
                console.log("Weather updated", data); 
             } catch (e) {}
        }, 600000);

        // Refresh Currency every 5 mins (300,000 ms)
        setInterval(async () => {
             // Re-fetch rate logic would go here
        }, 300000);

        // --- 4. Ticking Converter Clock ---
        function startConverterClock() {
            const display = document.getElementById('converterTargetTime');
            if(!display) return;
            
            const offsetMinutes = parseFloat(display.getAttribute('data-offset'));
            if(isNaN(offsetMinutes)) return;

            function update() {
                // Current UTC time in ms
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                
                // Target time
                const targetTime = new Date(utc + (offsetMinutes * 60000));
                
                // Format HH:MM AM/PM
                display.textContent = targetTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            setInterval(update, 1000); // Update every second
            update(); // Initial call
        }
        startConverterClock();
    </script>
