@model TodoListApp.ViewModels.AdminCreateUserViewModel

@{
    ViewData["Title"] = "Create User";
}

<div class="auth-container fade-in">
    <div class="auth-card-wide">
        <div class="auth-header">
            <h1 class="auth-hero-title">Create User</h1>
            <p class="auth-hero-subtitle">Add a new member to your team.</p>
        </div>

        <form id="createUserForm" class="auth-form">
            <div asp-validation-summary="ModelOnly" class="text-danger" style="font-size: 0.9rem;"></div>

            <div class="form-section">
                <div class="form-section-title">Account Information</div>
                
                <div class="form-group mb-3">
                    <label asp-for="Name">Full Name</label>
                    <input asp-for="Name" class="form-control" placeholder="e.g. Sarah Smith" oninput="validateForm()" />
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="Email">Email Address</label>
                    <input asp-for="Email" class="form-control" placeholder="name@company.com" oninput="validateForm()" />
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label asp-for="Password">Password</label>
                        <input asp-for="Password" type="password" class="form-control" placeholder="Min 8 chars" oninput="validateForm()" />
                        <span asp-validation-for="Password" class="text-danger small"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="ConfirmPassword">Confirm</label>
                        <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Repeat" oninput="validateForm()" />
                        <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">System Role</div>
                <div class="role-selection-grid">
                    @foreach (var role in new[] { 
                        new { Name = "SuperAdmin", Desc = "Full system control", Tips = "Can manage all users, view dashboard analytics, and modify system settings." },
                        new { Name = "Admin", Desc = "Full tool access", Tips = "Can use all productivity tools and widgets, but cannot manage users." },
                        new { Name = "Manager", Desc = "User management control", Tips = "Can view user lists and reports, but cannot modify user accounts or system settings." },
                        new { Name = "PrivateUser", Desc = "Restricted privacy mode", Tips = "Can only access their own data tasks, goals, and productivity tools. Invisible to others." },
                        new { Name = "NormalUser", Desc = "Standard level access", Tips = "Default access to dashboard, tasks, news, and productivity widgets." }
                    })
                    {
                        <label class="role-card" onclick="updateRoleDefaults('@role.Name')">
                            <input type="radio" asp-for="Role" value="@role.Name" checked="@(role.Name == "NormalUser" ? "checked" : null)" onchange="updateRoleDefaults(this.value); validateForm()" />
                            <div class="role-card-content">
                                <span class="role-info-trigger" data-tooltip="@role.Tips">ⓘ</span>
                                <span class="role-name">@role.Name</span>
                                <span class="role-description">@role.Desc</span>
                            </div>
                        </label>
                    }
                </div>
                <span asp-validation-for="Role" class="text-danger small"></span>
            </div>


            <!-- Feature & Widget Access Section -->
            <div class="form-section feature-access-section">
                <div class="form-section-title">Feature & Widget Access</div>
                <p class="text-secondary small mb-3">Permissions are strictly based on the selected role.</p>
                
                <div class="feature-grid">
                    @{
                        var features = ViewBag.SystemFeatures as IEnumerable<TodoListApp.Models.SystemFeature>;
                        var groups = features?.GroupBy(f => f.Type) ?? Enumerable.Empty<IGrouping<TodoListApp.Models.FeatureType, TodoListApp.Models.SystemFeature>>();
                    }

                    @foreach (var group in groups)
                    {
                        <div class="feature-type-divider">@group.Key.ToString()s</div>
                        @foreach (var feature in group)
                        {
                            if (feature.TechnicalName == "Page_PdfTools") continue;
                            <div class="feature-card @(feature.IsDefault ? "selected" : "")" 
                                 data-feature-id="@feature.Id" 
                                 data-type="@feature.Type"
                                 data-default="@feature.IsDefault.ToString().ToLower()"
                                 data-technical-name="@feature.TechnicalName">
                                <div class="feature-header">
                                    <div class="feature-icon-box">@feature.Icon</div>
                                    <div class="feature-info">
                                        <div class="feature-title">@feature.Name</div>
                                        <div class="feature-desc">@feature.Description</div>
                                    </div>
                                </div>
                                <div class="card-switch">
                                    <span class="switch-label">Access Granted</span>
                                    <div class="form-check form-switch p-0 m-0">
                                        <input class="form-check-input feature-checkbox" 
                                               type="checkbox" 
                                               disabled
                                               @(feature.IsDefault ? "checked" : "")
                                               onclick="return false;">
                                    </div>
                                </div>
                                <input type="hidden" name="SelectedFeatureIds" value="@feature.Id" @(feature.IsDefault ? "" : "disabled") class="feature-hidden-input">
                            </div>
                        }
                    }
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn-auth-primary" id="btnSubmit" disabled style="opacity: 0.6; cursor: not-allowed;">Confirm & Create User</button>
                <a asp-action="UserList" style="display: block; margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem; text-decoration: none; font-weight: 500;">
                    ← Back to User List
                </a>
            </div>
        </form>
    </div>

<script>
    function updateRoleDefaults(role) {
        // Define allowed features for each role
        const rolePermissions = {
            'SuperAdmin': 'ALL',
            'Admin': ['Page_Dashboard', 'Page_Tasks', 'Page_TimeTracker', 'Widget_Weather', 'Widget_Currency', 'Widget_Time', 'Widget_Habit', 'Widget_PdfTools', 'Widget_GoalTracker', 'Widget_News', 'Widget_Country', 'Widget_Translator', 'Widget_Emergency', 'Widget_Holiday'], // All EXCEPT 'Page_UserManagement'
            'Manager': ['Page_UserManagement'], // Only user list as requested
            'PrivateUser': ['Page_Tasks', 'Page_TimeTracker', 'Page_Dashboard', 'Widget_Weather', 'Widget_Currency', 'Widget_Time', 'Widget_Habit', 'Widget_PdfTools', 'Widget_GoalTracker'],
            'NormalUser': ['Page_Dashboard', 'Page_Tasks', 'Page_TimeTracker', 'Widget_Weather', 'Widget_Currency', 'Widget_Time', 'Widget_Habit', 'Widget_PdfTools', 'Widget_News', 'Widget_Country', 'Widget_Translator', 'Widget_Emergency', 'Widget_Holiday']
        };

        const allowed = rolePermissions[role];
        const cards = document.querySelectorAll('.feature-card');
        
        cards.forEach(card => {
            const techName = card.getAttribute('data-technical-name');
            const checkbox = card.querySelector('.feature-checkbox');
            const hiddenInput = card.querySelector('.feature-hidden-input');
            
            let shouldCheck = false;
            
            if (allowed === 'ALL') {
                shouldCheck = true;
                // Special case: Admin exclusion logic if 'ALL' meant strictly everything.
                // But for 'Manager' it means everything including User Management.
                // For 'SuperAdmin' it means simply everything.
            } else if (Array.isArray(allowed)) {
                shouldCheck = allowed.includes(techName);
            }

            // Update UI
            checkbox.checked = shouldCheck;
            checkbox.disabled = true; // Always disabled per user request ("can't editable this")

            if (shouldCheck) {
                card.classList.add('selected');
                hiddenInput.disabled = false; // Enable submission (Access Granted)
            } else {
                card.classList.remove('selected');
                hiddenInput.disabled = true; // Disable submission (Access Denied)
            }
        });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        const checkedRole = document.querySelector('input[name="Role"]:checked');
        if (checkedRole) {
            updateRoleDefaults(checkedRole.value);
        }
    });

    document.getElementById("createUserForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById("btnSubmit");
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Processing...";
        btn.style.opacity = "0.7";

        const formData = new FormData(this);

        try {
            const response = await fetch('@Url.Action("CreateUser", "Todo")', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, "success");
                setTimeout(() => {
                    window.location.href = result.redirectUrl;
                }, 1500);
            } else {
                showToast(result.message || "An error occurred.", "error");
                btn.disabled = false;
                btn.innerText = originalText;
                btn.style.opacity = "1";
            }
        } catch (error) {
            showToast("Connection error. Please try again.", "error");
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = "1";
        }
    });

    function validateForm() {
        var name = document.getElementById("Name").value;
        var email = document.getElementById("Email").value;
        var password = document.getElementById("Password").value;
        var confirm = document.getElementById("ConfirmPassword").value;
        var btn = document.getElementById("btnSubmit");

        var roleRadios = document.getElementsByName("Role");
        var roleSelected = false;
        for (var i = 0; i < roleRadios.length; i++) {
            if (roleRadios[i].checked) {
                roleSelected = true;
                break;
            }
        }

        var isValid = name.length > 0 && 
                      email.length > 0 && 
                      password.length >= 8 && 
                      password === confirm &&
                      roleSelected;

        if (isValid) {
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
        } else {
            btn.disabled = true;
            btn.style.opacity = "0.6";
            btn.style.cursor = "not-allowed";
        }
    }
</script>
</div>
