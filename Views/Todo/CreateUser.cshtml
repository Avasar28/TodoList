@model TodoListApp.ViewModels.AdminCreateUserViewModel

@{
    ViewData["Title"] = "Create User";
}

<div class="auth-container fade-in">
    <div class="auth-card-wide">
        <div class="auth-header">
            <h1 class="auth-hero-title">Create User</h1>
            <p class="auth-hero-subtitle">Add a new member to your team.</p>
        </div>

        <form id="createUserForm" class="auth-form">
            <div asp-validation-summary="ModelOnly" class="text-danger" style="font-size: 0.9rem;"></div>

            <div class="form-section">
                <div class="form-section-title">Account Information</div>
                
                <div class="form-group mb-3">
                    <label asp-for="Name">Full Name</label>
                    <input asp-for="Name" class="form-control" placeholder="e.g. Sarah Smith" oninput="validateForm()" />
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="Email">Email Address</label>
                    <input asp-for="Email" class="form-control" placeholder="name@company.com" oninput="validateForm()" />
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label asp-for="Password">Password</label>
                        <input asp-for="Password" type="password" class="form-control" placeholder="Min 8 chars" oninput="validateForm()" />
                        <span asp-validation-for="Password" class="text-danger small"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="ConfirmPassword">Confirm</label>
                        <input asp-for="ConfirmPassword" type="password" class="form-control" placeholder="Repeat" oninput="validateForm()" />
                        <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">System Role</div>
                <div class="role-selection-grid">
                    @foreach (var role in new[] { 
                        new { Name = "SuperAdmin", Desc = "Full system control", Tips = "Can manage all users, view dashboard analytics, and modify system settings." },
                        new { Name = "Admin", Desc = "User management control", Tips = "Can create, edit, and delete users and view global PDF history. Cannot delete SuperAdmins." },
                        new { Name = "Manager", Desc = "System monitoring", Tips = "Can view user lists and reports. Cannot modify user accounts or system settings." },
                        new { Name = "PrivateUser", Desc = "Restricted privacy mode", Tips = "Can only access their own data. Completely invisible to other non-admin users." },
                        new { Name = "NormalUser", Desc = "Standard level access", Tips = "Default access to dashboard, todo items, and PDF tools for their own data." }
                    })
                    {
                        <label class="role-card" onclick="updateRoleDefaults('@role.Name')">
                            <input type="radio" asp-for="Role" value="@role.Name" checked="@(role.Name == "NormalUser" ? "checked" : null)" onchange="validateForm()" />
                            <div class="role-card-content">
                                <span class="role-info-trigger" data-tooltip="@role.Tips">ⓘ</span>
                                <span class="role-name">@role.Name</span>
                                <span class="role-description">@role.Desc</span>
                            </div>
                        </label>
                    }
                </div>
                <span asp-validation-for="Role" class="text-danger small"></span>
            </div>


            <!-- Feature & Widget Access Section -->
            <div class="form-section feature-access-section">
                <div class="form-section-title">Feature & Widget Access</div>
                <p class="text-secondary small mb-3">Define granular permissions. These control which pages and widgets the user can access.</p>
                
                <div class="feature-actions">
                    <button type="button" class="btn-feature-action" onclick="selectAll('Everything')">Select Everything</button>
                    <button type="button" class="btn-feature-action" onclick="selectAll('Page')">Select All Pages</button>
                    <button type="button" class="btn-feature-action" onclick="selectAll('Widget')">Select All Widgets</button>
                    <button type="button" class="btn-feature-action" onclick="clearAllFeatures()">Clear All</button>
                </div>

                <div class="feature-grid">
                    @{
                        var features = ViewBag.SystemFeatures as IEnumerable<TodoListApp.Models.SystemFeature>;
                        var groups = features?.GroupBy(f => f.Type) ?? Enumerable.Empty<IGrouping<TodoListApp.Models.FeatureType, TodoListApp.Models.SystemFeature>>();
                    }

                    @foreach (var group in groups)
                    {
                        <div class="feature-type-divider">@group.Key.ToString()s</div>
                        @foreach (var feature in group)
                        {
                            <div class="feature-card @(feature.IsDefault ? "selected" : "")" 
                                 data-feature-id="@feature.Id" 
                                 data-type="@feature.Type"
                                 data-default="@feature.IsDefault.ToString().ToLower()"
                                 onclick="toggleFeature(this)">
                                <div class="feature-header">
                                    <div class="feature-icon-box">@feature.Icon</div>
                                    <div class="feature-info">
                                        <div class="feature-title">@feature.Name</div>
                                        <div class="feature-desc">@feature.Description</div>
                                    </div>
                                </div>
                                <div class="card-switch">
                                    <span class="switch-label">Access Granted</span>
                                    <div class="form-check form-switch p-0 m-0">
                                        <input class="form-check-input feature-checkbox" 
                                               type="checkbox" 
                                               @(feature.IsDefault ? "checked" : "")
                                               onclick="event.stopPropagation(); syncCardState(this)">
                                    </div>
                                </div>
                                <input type="hidden" name="SelectedFeatureIds" value="@feature.Id" @(feature.IsDefault ? "" : "disabled") class="feature-hidden-input">
                            </div>
                        }
                    }
                </div>
            </div>

            <div style="margin-top: 2rem;">
                <button type="submit" class="btn-auth-primary" id="btnSubmit" disabled style="opacity: 0.6; cursor: not-allowed;">Confirm & Create User</button>
                <a asp-action="UserList" style="display: block; margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem; text-decoration: none; font-weight: 500;">
                    ← Back to User List
                </a>
            </div>
        </form>
    </div>

<script>
    function toggleFeature(card) {
        const checkbox = card.querySelector('.feature-checkbox');
        checkbox.checked = !checkbox.checked;
        syncCardState(checkbox);
    }

    function syncCardState(checkbox) {
        const card = checkbox.closest('.feature-card');
        const hiddenInput = card.querySelector('.feature-hidden-input');
        
        if (checkbox.checked) {
            card.classList.add('selected');
            hiddenInput.disabled = false;
        } else {
            card.classList.remove('selected');
            hiddenInput.disabled = true;
        }
    }

    function selectAll(type) {
        const cards = document.querySelectorAll('.feature-card');
        cards.forEach(card => {
            if (type === 'Everything' || card.getAttribute('data-type') === type) {
                const checkbox = card.querySelector('.feature-checkbox');
                checkbox.checked = true;
                syncCardState(checkbox);
            }
        });
    }

    function clearAllFeatures() {
        const cards = document.querySelectorAll('.feature-card');
        cards.forEach(card => {
            const checkbox = card.querySelector('.feature-checkbox');
            checkbox.checked = false;
            syncCardState(checkbox);
        });
    }

    function updateRoleDefaults(role) {
        if (role === 'SuperAdmin' || role === 'Admin') {
            selectAll('Everything');
        } else if (role === 'NormalUser' || role === 'PrivateUser') {
            const cards = document.querySelectorAll('.feature-card');
            cards.forEach(card => {
                const isDefault = card.getAttribute('data-default') === 'true';
                const checkbox = card.querySelector('.feature-checkbox');
                checkbox.checked = isDefault;
                syncCardState(checkbox);
            });
        } else if (role === 'Manager') {
            selectAll('Everything');
            // Uncheck User Management (Example refinement)
            const umCard = Array.from(document.querySelectorAll('.feature-card')).find(c => c.querySelector('.feature-title').innerText.trim() === 'User Management');
            if (umCard) {
                 const checkbox = umCard.querySelector('.feature-checkbox');
                 checkbox.checked = false;
                 syncCardState(checkbox);
            }
        }
    }

    document.getElementById("createUserForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById("btnSubmit");
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Processing...";
        btn.style.opacity = "0.7";

        const formData = new FormData(this);

        try {
            const response = await fetch('@Url.Action("CreateUser", "Todo")', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, "success");
                setTimeout(() => {
                    window.location.href = result.redirectUrl;
                }, 1500);
            } else {
                showToast(result.message || "An error occurred.", "error");
                btn.disabled = false;
                btn.innerText = originalText;
                btn.style.opacity = "1";
            }
        } catch (error) {
            showToast("Connection error. Please try again.", "error");
            btn.disabled = false;
            btn.innerText = originalText;
            btn.style.opacity = "1";
        }
    });

    function validateForm() {
        var name = document.getElementById("Name").value;
        var email = document.getElementById("Email").value;
        var password = document.getElementById("Password").value;
        var confirm = document.getElementById("ConfirmPassword").value;
        var btn = document.getElementById("btnSubmit");

        var roleRadios = document.getElementsByName("Role");
        var roleSelected = false;
        for (var i = 0; i < roleRadios.length; i++) {
            if (roleRadios[i].checked) {
                roleSelected = true;
                break;
            }
        }

        var isValid = name.length > 0 && 
                      email.length > 0 && 
                      password.length >= 8 && 
                      password === confirm &&
                      roleSelected;

        if (isValid) {
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
        } else {
            btn.disabled = true;
            btn.style.opacity = "0.6";
            btn.style.cursor = "not-allowed";
        }
    }
</script>
</div>
