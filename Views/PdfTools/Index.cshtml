@model List<TodoListApp.Models.PdfFileHistory>
@{
    ViewData["Title"] = "PDF Tools";
}

<div class="pdf-page-container">
    
    <!-- Premium Header -->
    <div class="row mb-5 align-items-center">
        <div class="col-lg-7">
            <div class="d-flex align-items-center">
                <div class="me-4 d-none d-md-block" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 20px; color: var(--accent-color);">
                    <i class="fas fa-file-pdf fa-3x"></i>
                </div>
                <div>
                    <h1 class="display-5 fw-bold mb-1" style="color: var(--text-primary);">PDF Studio</h1>
                    <p class="lead text-muted mb-0">Professional tools to Manage, Convert & Secure your documents.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-5 mt-4 mt-lg-0">
            <!-- Stats Panel -->
            <div class="pdf-stat-panel">
                <div class="pdf-stat-row">
                    <span class="stat-label"><i class="fas fa-hdd me-2"></i>Storage</span>
                    <span class="stat-value">@((ViewBag.StorageUsage / 1024.0 / 1024.0).ToString("F1")) / @((ViewBag.StorageLimit / 1024.0 / 1024.0).ToString("F0")) MB</span>
                </div>
                
                <div class="progress mb-3" style="height: 8px; background-color: rgba(255,255,255,0.1); border-radius: 4px;">
                    @{
                        var percent = (long)ViewBag.StorageUsage * 100.0 / (long)ViewBag.StorageLimit;
                        var color = percent > 90 ? "bg-danger" : (percent > 70 ? "bg-warning" : "bg-success");
                    }
                    <div class="progress-bar @color" role="progressbar" style="width: @percent%; border-radius: 4px;" aria-valuenow="@percent" aria-valuemin="0" aria-valuemax="100"></div>
                </div>

                <div class="d-flex align-items-center justify-content-between">
                    <span class="stat-label" style="text-transform: none; font-size: 0.8rem;"><i class="fas fa-clock me-2"></i>Auto-delete (30 days)</span>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input premium-switch" type="checkbox" id="autoDeleteToggle" @(ViewBag.AutoDeleteEnabled == true ? "checked" : "") onchange="toggleAutoDelete(this)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tool Grid Navigation -->
    <div class="pdf-tool-grid" id="tool-grid">
        @{
            var favorites = ViewBag.Favorites as List<string> ?? new List<string>();
            var tools = new[] 
            { 
                new { id = "merge", icon = "fa-layer-group", label = "Merge PDF", desc = "Combine multiple PDFs into one unified document." },
                new { id = "split", icon = "fa-cut", label = "Split PDF", desc = "Extract pages or split extensive documents." },
                new { id = "images", icon = "fa-images", label = "Images to PDF", desc = "Convert JPG/PNG images into a PDF portfolio." },
                new { id = "compress", icon = "fa-compress-arrows-alt", label = "Compress PDF", desc = "Reduce file size while maintaining quality." }
            };
            
            // Sort favorites first
            var sortedTools = tools.OrderByDescending(t => favorites.Contains(t.id)).ToList();
        }

        @foreach (var tool in sortedTools)
        {
            var isFav = favorites.Contains(tool.id);
            <div class="tool-card @(tool.id == "merge" ? "active" : "")" onclick="switchTab('@tool.id')" data-tool="@tool.id">
                <div class="position-absolute top-0 end-0 mt-3 me-3">
                     <i class="fas fa-star star-icon @(isFav ? "text-warning" : "text-muted opacity-25")" 
                       style="cursor: pointer; font-size: 1rem;" 
                       onclick="toggleFavorite('@tool.id', this); event.stopPropagation();"></i>
                </div>
                <div class="tool-icon-wrapper">
                    <i class="fas @tool.icon"></i>
                </div>
                <div class="tool-title">@tool.label</div>
                <div class="tool-desc">@tool.desc</div>
            </div>
        }
    </div>

    <!-- Workspace -->
    <div id="pdf-workspace">
        <div class="d-flex align-items-center mb-4">
            <div class="badge bg-accent text-dark me-2">Active</div>
            <h4 class="mb-0 text-white" id="workspace-title">Merge PDF</h4>
        </div>

<!-- ... table body ... -->


        <!-- Input Area -->
        <div id="drop-zone" class="premium-drop-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-cloud-upload-alt mb-3"></i>
            <h4 class="drop-title">Drag & Drop files here</h4>
            <p class="drop-subtitle">or click to browse from your computer</p>
            <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <!-- Options: Split Range -->
        <div id="split-options" class="mb-4" style="display: none;">
            <label class="form-label" style="color: var(--text-primary);">Page Range (e.g., 1-5, 8)</label>
            <div class="d-flex gap-2">
                <input type="text" id="pageRange" class="form-control" placeholder="Leave empty to split all pages" style="background: rgba(255,255,255,0.05); color: var(--text-primary); border: var(--glass-border);">
                <div class="form-check d-flex align-items-center">
                    <input class="form-check-input" type="checkbox" id="splitAll">
                    <label class="form-check-label ms-2" for="splitAll" style="color: var(--text-secondary);">Split All</label>
                </div>
            </div>
        </div>

        <!-- Options: Compression Level -->
        <div id="compress-options" class="mb-4" style="display: none;">
            <label class="form-label" style="color: var(--text-primary);">Compression Level</label>
            <select id="compressionLevel" class="form-select" style="background: rgba(255,255,255,0.05); color: var(--text-primary); border: var(--glass-border);">
                <option value="standard">Standard</option>
                <option value="high">High (Maximum reduction)</option>
            </select>
        </div>

        <!-- File List -->
        <ul id="file-list" class="file-list"></ul>

        <!-- Action Buttons -->
        <div class="pdf-controls">
            <button class="btn btn-premium-secondary" onclick="clearFiles()">Clear All</button>
            <button id="processBtn" class="btn btn-premium-primary" onclick="processFiles()">
                <span>Process Files</span>
                <div class="loading-spinner" id="spinner"></div>
            </button>
        </div>

        <!-- Info Panel -->
        <div id="info-panel" class="mb-4 p-3 rounded d-none" style="background: var(--glass-bg); border: 1px solid var(--glass-border);">
            <h5 class="mb-3" style="color: var(--accent-color);"><i class="fas fa-info-circle me-2"></i>File Analysis</h5>
            <div class="row g-3" id="info-content">
                <!-- Populated via JS -->
            </div>
        </div>

        <!-- Progress Container -->
        <div id="progress-container" class="mt-4 d-none">
            <div class="d-flex justify-content-between mb-2">
                <span id="progress-label" class="text-white small fw-bold">Uploading...</span>
            </div>
            <div class="progress-premium-container">
                <div id="progress-bar" class="progress-premium-bar">
                    <span id="progress-percent" class="progress-percent-text">0%</span>
                </div>
            </div>
        </div>

        <!-- Result -->
        <div id="result-section" class="result-section">
            <div class="d-flex align-items-center mb-2">
                <div class="checkmark-circle me-2">
                    <div class="checkmark draw"></div>
                </div>
                <span id="result-message" class="result-message">Success! File ready.</span>
            </div>
            <div class="mt-3">
                <button id="preview-btn" class="btn btn-sm btn-outline-info me-2">
                    <i class="fas fa-eye me-2"></i>Preview
                </button>
                <a id="download-link" href="#" class="btn btn-sm btn-light" download>
                    <i class="fas fa-download me-2"></i>Download
                </a>
            </div>
        </div>

        <!-- Modern Toast Container -->
        <div id="toast-container" class="toast-container-premium"></div>

        <!-- Preview Modal -->
        <div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
            <!-- ... existing preview modal ... -->
        </div>

        <!-- Redesigned Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content modal-content-premium">
                    <div class="modal-body modal-body-premium">
                        <div class="modal-icon-wrapper">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="modal-title-premium" id="deleteModalTitle">Confirm Deletion</h3>
                        <p class="modal-text-premium" id="deleteModalMessage">
                            Are you sure you want to delete the selected files? This action cannot be undone and will permanently remove your files from our servers.
                        </p>
                    </div>
                    <div class="modal-footer modal-footer-premium">
                        <button type="button" class="btn btn-secondary-premium" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger-premium" onclick="executeBulkDelete()" id="confirmDeleteBtn">Delete Permanently</button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- Close Workspace -->

    <!-- History Section -->
    <div class="mt-5 pt-4 border-top" style="border-color: var(--glass-border) !important;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0 d-flex align-items-center" style="color: var(--text-primary); font-family: 'Outfit', sans-serif; font-weight: 700;">
                <i class="fas fa-history me-2 text-accent"></i>
                <span>My PDF History @(ViewBag.IsAdmin == true ? "(All Users)" : "")</span>
                <button class="btn btn-icon-premium history-collapse-trigger ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#history-collapse-container" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </h4>
            <div class="d-flex gap-2 align-items-center">
                <div class="form-check d-none" id="selectAllWrapper">
                    <input type="checkbox" class="form-check-input" id="selectAllHistory" onclick="toggleSelectAll(this)">
                    <label class="form-check-label ms-2 text-muted small" for="selectAllHistory">Select All</label>
                </div>
                <button id="bulkDeleteBtn" class="btn btn-sm btn-danger-premium d-none" onclick="confirmBulkDelete()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-trash-alt me-2"></i>Delete Selected
                </button>
            </div>
        </div>

        @if (Model != null && Model.Any())
        {
            <div class="collapse show" id="history-collapse-container">
                <div class="history-grid-premium" id="history-grid">
                @foreach (var item in Model)
                {
                    <div class="history-card-premium" data-id="@item.Id">
                        <div class="d-flex align-items-center gap-3">
                            <input type="checkbox" class="form-check-input history-checkbox" value="@item.Id" onclick="updateBulkDeleteState()">
                            <div class="history-icon-box">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                        </div>
                        
                        <div class="history-info-box">
                            <div class="history-filename" title="@item.OriginalFileNames">@item.OriginalFileNames</div>
                            <div class="history-meta-row">
                                <span class="badge-tool-premium">@item.ToolType</span>
                                <div class="history-meta-item">
                                    <i class="far fa-calendar-alt"></i>
                                    @item.CreatedAt.ToLocalTime().ToString("MMM dd, HH:mm")
                                </div>
                                <div class="history-meta-item">
                                    <i class="fas fa-database"></i>
                                    @((item.FileSize / 1024.0 / 1024.0).ToString("F2")) MB
                                </div>
                                @if (ViewBag.IsAdmin == true)
                                {
                                    <div class="history-meta-item">
                                        <i class="fas fa-user"></i>
                                        @item.UserId
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="history-actions-premium">
                            <button class="btn-icon-premium" onclick="reprocessFile('@item.StoredFilePath', '@item.ToolType')" title="Use Again">
                                <i class="fas fa-redo"></i>
                            </button>
                            <a href="@item.StoredFilePath" class="btn-icon-premium" download title="Download">
                                <i class="fas fa-download"></i>
                            </a>
                            <button class="btn-icon-premium delete" onclick="confirmSingleDelete('@item.Id')" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                }
                </div>
            </div>
            <script>
                document.getElementById('selectAllWrapper').classList.remove('d-none');
            </script>
        }
        else
        {
            <div class="history-empty-state">
                <i class="fas fa-folder-open empty-icon"></i>
                <div class="empty-text">No documents in your history yet.</div>
                <p class="text-muted mt-2">Processed files will appear here for 30 days.</p>
            </div>
        }
    </div>

</div> <!-- Close Page Container -->

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script>
        // --- State ---
        let currentTab = 'merge';
        let selectedFiles = [];
        let currentDownloadUrl = "";
        let deleteTargets = [];

        // --- DOM Elements & Bootstrap Components ---
        let fileList, infoPanel, infoContent, actionBtn, spinner, resultSection, resultMessage, previewBtn, previewFrame, dropZone;
        let previewModal, deleteModal, bulkDeleteBtn;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("PDF Tools: Initializing DOM elements...");
            try {
                // DOM Elements
                fileList = document.getElementById('file-list');
                infoPanel = document.getElementById('info-panel');
                infoContent = document.getElementById('info-content');
                actionBtn = document.getElementById('processBtn');
                spinner = document.getElementById('spinner');
                resultSection = document.getElementById('result-section');
                resultMessage = document.getElementById('result-message');
                previewBtn = document.getElementById('preview-btn');
                previewFrame = document.getElementById('preview-frame');
                bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                dropZone = document.getElementById('drop-zone');

                // Initialize Bootstrap components if bootstrap is defined
                if (typeof bootstrap !== 'undefined') {
                    const previewEl = document.getElementById('previewModal');
                    const deleteEl = document.getElementById('deleteModal');
                    if (previewEl) previewModal = new bootstrap.Modal(previewEl);
                    if (deleteEl) deleteModal = new bootstrap.Modal(deleteEl);
                }
                
                // Initial state sync
                updateBulkDeleteState();
            } catch (e) {
                console.error("Initialization error:", e);
            }
        });

        // --- Tab Switching ---
        function switchTab(tab) {
            try {
                currentTab = tab;
                
                // Update Card Active State
                document.querySelectorAll('.tool-card').forEach(card => card.classList.remove('active'));
                const activeCard = document.querySelector(`.tool-card[data-tool="${tab}"]`);
                if(activeCard) activeCard.classList.add('active');

                // Update Titles
                const titles = {
                    'merge': 'Merge PDF',
                    'split': 'Split PDF',
                    'images': 'Images to PDF',
                    'compress': 'Compress PDF'
                };
                const titleEl = document.getElementById('workspace-title');
                if (titleEl) titleEl.innerText = titles[tab] || 'PDF Tool';

                // Show/Hide Options
                const splitOpt = document.getElementById('split-options');
                if (splitOpt) splitOpt.style.display = tab === 'split' ? 'block' : 'none';
                
                const compressOpt = document.getElementById('compress-options');
                if (compressOpt) compressOpt.style.display = tab === 'compress' ? 'block' : 'none';

                // Reset
                clearFiles();

                // Update Input Attribute
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    if (tab === 'images') {
                        fileInput.accept = '.jpg,.jpeg,.png';
                        fileInput.multiple = true;
                    } else if (tab === 'merge') {
                        fileInput.accept = '.pdf';
                        fileInput.multiple = true;
                    } else {
                        fileInput.accept = '.pdf';
                        fileInput.multiple = false;
                    }
                }

                // Smooth Scroll to Workspace
                const workspace = document.getElementById('pdf-workspace');
                if (workspace) {
                    workspace.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Trigger Animation
                    workspace.classList.remove('workspace-animate');
                    void workspace.offsetWidth; // trigger reflow
                    workspace.classList.add('workspace-animate');
                }
            } catch (e) {
                console.error("Error switching tab:", e);
                showToast("Error switching tool", "error");
            }
        }

        // --- Toasts ---
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-premium ${type}`;
            
            if (!title) {
                if (type === 'success') title = 'Success';
                else if (type === 'error') title = 'Error';
                else title = 'Notification';
            }

            const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle');
            
            toast.innerHTML = `
                <div class="toast-icon"><i class="fas ${iconClass}"></i></div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // --- Drag & Drop ---
        function handleDragOver(e) {
            e.preventDefault();
            if (dropZone) dropZone.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            if (dropZone) dropZone.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            if (dropZone) dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        }

        function handleFileSelect(e) {
            if (e.target && e.target.files) {
                handleFiles(e.target.files);
            }
        }

        function handleFiles(files) {
            const newFiles = Array.from(files);
            
            // Validation
            const invalid = newFiles.filter(f => {
                if (currentTab === 'images') return !f.type.startsWith('image/');
                return f.type !== 'application/pdf';
            });

            if (invalid.length > 0) {
                showToast(`Invalid file type(s) detected. Please upload ${currentTab === 'images' ? 'images' : 'PDFs'}.`, 'error');
                return;
            }

            if (currentTab === 'merge' || currentTab === 'images') {
                selectedFiles = [...selectedFiles, ...newFiles];
            } else {
                selectedFiles = [newFiles[0]];
            }

            updateFileList();
            analyzeFiles();
        }

        function clearFiles() {
            selectedFiles = [];
            updateFileList();
            if (infoPanel) infoPanel.classList.add('d-none');
            if (resultSection) resultSection.classList.add('d-none');
        }

        function updateFileList() {
            if (!fileList) return;
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="file-info">
                        <i class="fas ${file.type.startsWith('image/') ? 'fa-image text-warning' : 'fa-file-pdf text-accent'} file-icon"></i>
                        <div>
                            <div class="fw-bold">${file.name}</div>
                            <div class="text-muted small">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})"><i class="fas fa-times"></i></button>
                `;
                fileList.appendChild(li);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            if (selectedFiles.length === 0) infoPanel.classList.add('d-none');
        }

        async function analyzeFiles() {
            if (selectedFiles.length === 0 || currentTab === 'images') return;
            // Analysis logic simplified for brevity - usually calls an endpoint
        }

        // --- Core Processing ---
        async function processFiles() {
            if (selectedFiles.length === 0) {
                showToast("Please select files first", 'info');
                return;
            }

            const formData = new FormData();
            selectedFiles.forEach(f => formData.append('files', f));
            
            // Add options based on tab
            const pageRangeEl = document.getElementById('pageRange');
            const splitAllEl = document.getElementById('splitAll');
            const compressionLevelEl = document.getElementById('compressionLevel');

            if (currentTab === 'split') {
                if (pageRangeEl) formData.append('pageRange', pageRangeEl.value);
                if (splitAllEl) formData.append('splitAll', splitAllEl.checked);
            } else if (currentTab === 'compress') {
                if (compressionLevelEl) formData.append('compressionLevel', compressionLevelEl.value);
            }

            try {
                // UI State
                if (actionBtn) actionBtn.disabled = true;
                if (spinner) spinner.style.display = 'block';
                if (resultSection) resultSection.classList.add('d-none');
                
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const progressPercent = document.getElementById('progress-percent');
                const progressLabel = document.getElementById('progress-label');
                
                if (progressContainer) progressContainer.classList.remove('d-none');
                if (progressBar) progressBar.style.width = '0%';
                if (progressPercent) progressPercent.innerText = '0%';
                if (progressLabel) progressLabel.innerText = 'Uploading...';

                const xhr = new XMLHttpRequest();
                let endpoint = '';
                switch(currentTab) {
                    case 'merge': endpoint = '/PdfTools/MergePdf'; break;
                    case 'split': endpoint = '/PdfTools/SplitPdf'; break;
                    case 'images': endpoint = '/PdfTools/ImagesToPdf'; break;
                    case 'compress': endpoint = '/PdfTools/CompressPdf'; break;
                }

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        if (progressBar) progressBar.style.width = percent + '%';
                        if (progressPercent) progressPercent.innerText = percent + '%';
                        if (percent === 100 && progressLabel) progressLabel.innerText = 'Processing on server...';
                    }
                };

                xhr.onload = () => {
                    if (actionBtn) actionBtn.disabled = false;
                    if (spinner) spinner.style.display = 'none';
                    if (progressContainer) progressContainer.classList.add('d-none');

                    if (xhr.status === 200) {
                        const res = JSON.parse(xhr.responseText);
                        if (res.success) {
                            showToast("Processing complete!", 'success');
                            if (resultSection) resultSection.classList.remove('d-none');
                            const downloadLink = document.getElementById('download-link');
                            if (downloadLink) downloadLink.href = res.fileUrl;
                            currentDownloadUrl = res.fileUrl;
                        } else {
                            showToast(res.message || "Failed to process", 'error');
                        }
                    } else {
                        showToast("Server error occurred", 'error');
                    }
                };

                xhr.onerror = () => {
                    showToast("Network error", 'error');
                    if (actionBtn) actionBtn.disabled = false;
                    if (spinner) spinner.style.display = 'none';
                    if (progressContainer) progressContainer.classList.add('d-none');
                };

                xhr.open('POST', endpoint);
                xhr.send(formData);

            } catch (e) {
                console.error("Process error:", e);
                showToast("An error occurred during processing", 'error');
                if (actionBtn) actionBtn.disabled = false;
                if (spinner) spinner.style.display = 'none';
            }
        }

        async function reprocessFile(filePath, toolType) {
            try {
                let targetTab = 'merge';
                if (toolType === 'Split') targetTab = 'split';
                if (toolType === 'Compress') targetTab = 'compress';
                if (toolType === 'ImagesToPdf') targetTab = 'images';
                
                const tabCard = document.querySelector(`.tool-card[data-tool="${targetTab}"]`);
                if(tabCard) tabCard.click();
                else switchTab(targetTab); 

                showToast("Loading file...", 'info');
                const url = `/PdfTools/DownloadFile?path=${encodeURIComponent(filePath)}`;
                const res = await fetch(url);
                if(!res.ok) throw new Error("File not found");
                
                const blob = await res.blob();
                const fileName = filePath.split('/').pop() || "reprocessed.pdf";
                const file = new File([blob], fileName, { type: blob.type });

                handleFiles([file]);
                showToast("File loaded for reprocessing", 'success');
                
            } catch (e) {
                showToast("Could not load file: " + e.message, 'error');
            }
        }

        // --- History Logic ---

        function confirmSingleDelete(id) {
            deleteTargets = [id];
            document.getElementById('deleteModalTitle').innerText = "Delete Document";
            document.getElementById('deleteModalMessage').innerText = "Are you sure you want to delete this document from your history?";
            deleteModal.show();
        }

        function confirmBulkDelete() {
            deleteTargets = Array.from(document.querySelectorAll('.history-checkbox:checked')).map(cb => cb.value);
            document.getElementById('deleteModalTitle').innerText = "Delete Selected";
            document.getElementById('deleteModalMessage').innerText = `Are you sure you want to delete the ${deleteTargets.length} selected documents?`;
            deleteModal.show();
        }

        async function executeBulkDelete() {
            try {
                const res = await fetch('/PdfTools/DeleteHistory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deleteTargets)
                });
                const data = await res.json();
                
                if (data.success) {
                    deleteModal.hide();
                    showToast("Deleted successfully", 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || "Deletion failed", 'error');
                }
            } catch (e) {
                showToast("An error occurred", 'error');
            }
        }

        function toggleSelectAll(source) {
            document.querySelectorAll('.history-checkbox').forEach(cb => cb.checked = source.checked);
            updateBulkDeleteState();
        }

        function updateBulkDeleteState() {
            const checkedCount = document.querySelectorAll('.history-checkbox:checked').length;
            if (checkedCount > 0) {
                bulkDeleteBtn.classList.remove('d-none');
                bulkDeleteBtn.innerHTML = `<i class="fas fa-trash-alt me-2"></i>Delete Selected (${checkedCount})`;
            } else {
                bulkDeleteBtn.classList.add('d-none');
            }
        }

        async function toggleFavorite(toolType, icon) {
            try {
                const res = await fetch('/PdfTools/ToggleFavorite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `toolType=${toolType}`
                });
                const data = await res.json();
                if (data.success) {
                    icon.classList.toggle('text-warning');
                    icon.classList.toggle('text-muted');
                    icon.classList.toggle('opacity-25');
                    showToast(data.message, 'success');
                }
            } catch (e) {
                showToast("Failed to update favorite", 'error');
            }
        }

        async function toggleAutoDelete(checkbox) {
            try {
                const res = await fetch('/PdfTools/ToggleAutoDelete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `enabled=${checkbox.checked}`
                });
                const data = await res.json();
                if (data.success) {
                    showToast(`Auto-delete ${checkbox.checked ? 'enabled' : 'disabled'}`, 'info');
                }
            } catch (e) {
                showToast("Failed to update setting", 'error');
            }
        }
    </script>
}
