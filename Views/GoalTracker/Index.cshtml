@model IEnumerable<TodoListApp.Models.Goal>
@{
    ViewData["Title"] = "Goal Tracker - Analytics Hub";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<div class="dashboard-container centered-view">
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; animation: slideDown 0.6s ease-out;">
        <div>
            <h1 style="margin: 0; font-weight: 850; letter-spacing: -1px; background: linear-gradient(135deg, #fff 0%, #14b8a6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Goal Analytics</h1>
            <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 1.1rem; opacity: 0.8;">Actionable insights for your personal milestones.</p>
        </div>
        <button onclick="openCreateModal()" class="btn-auth-primary" style="width: auto; padding: 0.85rem 1.75rem; display: flex; align-items: center; gap: 0.6rem; border-radius: 20px; background: #14b8a6; border: none; box-shadow: 0 10px 20px rgba(20, 184, 166, 0.2); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <span style="font-size: 1.2rem;">‚ú®</span> <span style="font-weight: 700;">Add New Goal</span>
        </button>
    </div>
    <div class="dashboard-tabs" style="display: flex; gap: 1rem; margin-bottom: 2.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem;">
        <button onclick="switchTab('goals')" class="tab-btn active" id="btn-tab-goals">üéØ Milestone List</button>
        <button onclick="switchTab('analytics')" class="tab-btn" id="btn-tab-analytics">üìä Performance Analytics</button>
        <button onclick="switchTab('calendar')" class="tab-btn" id="btn-tab-calendar">üìÖ Work Schedule</button>
    </div>

    <!-- Goals Tab -->
    <div id="goalsTab" class="tab-content">
        <!-- Filters & Sorting Bar -->
        <div class="filters-bar" style="display: flex; gap: 1.5rem; margin-bottom: 2.5rem; align-items: flex-end; flex-wrap: wrap; background: rgba(255,255,255,0.02); padding: 1.5rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
            <div class="filter-group">
                <label class="input-label-sm">Filter Status</label>
                <select id="filterStatus" class="form-control-sm" onchange="applyFilters()">
                    <option value="All">All Statuses</option>
                    <option value="On Track">On Track</option>
                    <option value="Off Track">Off Track</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="input-label-sm">Category</label>
                <select id="filterCategory" class="form-control-sm" onchange="applyFilters()">
                    <option value="All">All Categories</option>
                    <option value="Health">Health</option>
                    <option value="Work">Work</option>
                    <option value="Learning">Learning</option>
                    <option value="Finance">Finance</option>
                    <option value="Personal">Personal</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="input-label-sm">Sort By</label>
                <select id="sortField" class="form-control-sm" onchange="applyFilters()">
                    <option value="createdAt">Date Created</option>
                    <option value="progressPercent">Progress %</option>
                    <option value="endDate">Deadline</option>
                    <option value="priority">Priority</option>
                </select>
            </div>
            <div style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">
                <span id="filteredCount" style="color: #14b8a6; font-size: 1.1rem;">0</span> result(s)
            </div>
        </div>

        <div id="goalsContainer" class="goal-tracker-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
            <!-- Loading -->
            <div id="goalsLoading" style="grid-column: 1/-1; padding: 6rem; text-align: center;">
                <div class="spinner" style="margin: 0 auto 1.5rem; border-color: #14b8a6; border-top-color: transparent;"></div>
                <p style="color: var(--text-secondary);">Analyzing your performance data...</p>
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analyticsTab" class="tab-content" style="display: none;">
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div class="stats-overview-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                <div class="stat-mini-card">
                    <span class="stat-icon">üéØ</span>
                    <div><span class="stat-label">Total Goals</span><span class="stat-value" id="statTotalGoals">0</span></div>
                </div>
                <div class="stat-mini-card">
                    <span class="stat-icon pulse-teal">üèÅ</span>
                    <div><span class="stat-label">Completion Rate</span><span class="stat-value" id="statCompletionRate">0%</span></div>
                </div>
                <div class="stat-mini-card">
                    <span class="stat-icon">üìà</span>
                    <div><span class="stat-label">Active Focus</span><span class="stat-value" id="statActiveGoals">0</span></div>
                </div>
                <div class="stat-mini-card">
                    <span class="stat-icon">‚ö†Ô∏è</span>
                    <div><span class="stat-label">Overdue</span><span class="stat-value" id="statOverdueGoals">0</span></div>
                </div>
            </div>
            <div class="insight-card" style="padding: 1.5rem; background: rgba(255,255,255,0.02); display: flex; align-items: center; gap: 1.5rem; border-radius: 24px;">
                <div style="flex: 1; height: 180px;"><canvas id="statusChart"></canvas></div>
                <div style="flex: 1; height: 180px;"><canvas id="categoryChart"></canvas></div>
            </div>
        </div>
        
        <div class="insight-card" style="padding: 2.5rem; border-radius: 24px; margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h3 style="margin: 0; font-weight: 850; color: #fff;">Success Timeline</h3>
                    <p style="color: var(--text-secondary); margin: 0.25rem 0 0; font-size: 0.9rem;">Goal completions over the last 6 months.</p>
                </div>
            </div>
            <div style="height: 300px; width: 100%;"><canvas id="timelineChart"></canvas></div>
        </div>

        <!-- Smart Insights Panel -->
        <div class="insight-card" style="padding: 2rem; border-radius: 24px; margin-top: 2rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(251, 191, 36, 0.05)); border: 1px solid rgba(251, 191, 36, 0.2);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <span style="font-size: 2rem;">üß†</span>
                <div>
                    <h3 style="margin: 0; font-weight: 850; color: #fff;">Productivity Intelligence</h3>
                    <p style="color: var(--text-secondary); margin: 0.25rem 0 0; font-size: 0.9rem;">AI-powered insights to keep you on track.</p>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="stat-mini-card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <span class="stat-icon">‚ö†Ô∏è</span>
                    <div><span class="stat-label">At Risk</span><span class="stat-value" id="statGoalsAtRisk">0</span></div>
                </div>
                <div class="stat-mini-card" style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2);">
                    <span class="stat-icon">üí§</span>
                    <div><span class="stat-label">Stagnant</span><span class="stat-value" id="statStagnantGoals">0</span></div>
                </div>
            </div>
            <div id="smartInsightsList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Insights will be injected here -->
            </div>
        </div>
    </div>

    <!-- Achievements Hub -->
    <div id="achievementsHub" class="section-card" style="margin-bottom: 2rem; padding: 1.5rem; display: none; background: linear-gradient(135deg, rgba(20, 184, 166, 0.05), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(255,255,255,0.05);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span style="font-size: 1.5rem;">üèÜ</span>
                <h3 style="margin: 0; font-weight: 850; letter-spacing: -0.02em;">Achievements Hub</h3>
            </div>
            <span id="achievementCount" style="font-size: 0.85rem; font-weight: 700; color: #14b8a6; background: rgba(20,184,166,0.1); padding: 4px 12px; border-radius: 20px;">0 Unlocked</span>
        </div>
        <div id="achievementsList" style="display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 0.5rem; scrollbar-width: none;">
            <!-- Achievements will be injected here -->
        </div>
    </div>

    <!-- Calendar Tab -->
    <div id="calendarTab" class="tab-content" style="display: none;">
        <div class="calendar-container insight-card" style="padding: 2.5rem; border-radius: 30px;">
            <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 id="calendarMonthYear" style="margin: 0; font-weight: 850; color: #fff;">February 2026</h2>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="changeMonth(-1)" class="btn-card-action">‚óÄ</button>
                    <button onclick="changeMonth(1)" class="btn-card-action">‚ñ∂</button>
                </div>
            </div>
            <div class="calendar-grid-header" style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 1rem;">
                <div class="day-name">SUN</div><div class="day-name">MON</div><div class="day-name">TUE</div>
                <div class="day-name">WED</div><div class="day-name">THU</div><div class="day-name">FRI</div>
                <div class="day-name">SAT</div>
            </div>
            <div id="calendarGrid" class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.75rem;">
                <!-- Dates dynamically injected -->
            </div>
        </div>
    </div>
</div>

<!-- Add Schedule Modal -->
<div id="addScheduleModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="width: 100%; max-width: 450px; padding: 2.5rem; border-radius: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="margin: 0; font-weight: 800; color: #fff;">üìÖ Schedule Work</h2>
            <button onclick="closeScheduleModal()" class="btn-close-modal">&times;</button>
        </div>
        <form class="auth-form" id="scheduleForm" onsubmit="event.preventDefault(); submitSchedule();">
            <input type="hidden" id="scheduleGoalId" />
            <div class="form-group">
                <label>Target Date</label>
                <input id="schedDate" type="date" class="form-control" required />
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Start Time</label>
                    <input id="schedStart" type="time" class="form-control" value="09:00" required />
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input id="schedEnd" type="time" class="form-control" value="10:00" required />
                </div>
            </div>
            <div class="form-group">
                <label>Focus Notes</label>
                <textarea id="schedNotes" class="form-control" placeholder="What will you focus on?" style="min-height: 80px;"></textarea>
            </div>
            <button type="submit" class="btn-teal-full" style="margin-top: 1.5rem;">Confirm Schedule</button>
        </form>
    </div>
</div>

<!-- Day View Modal -->
<div id="dayViewModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="width: 100%; max-width: 500px; padding: 2.5rem; border-radius: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 id="dayViewTitle" style="margin: 0; font-weight: 800; color: #fff;">Planned for Today</h2>
            <button onclick="closeDayViewModal()" class="btn-close-modal">&times;</button>
        </div>
        <div id="dayScheduleContainer" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;">
            <!-- Schedule items injected here -->
        </div>
    </div>
</div>

<!-- Simple Toast System -->
<div id="toastContainer" style="position: fixed; top: 2rem; right: 2rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem;"></div>

<!-- Add/Edit Goal Modal -->
<div id="createGoalModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="width: 100%; max-width: 650px; padding: 2.5rem; border-radius: 24px; position: relative;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 id="modalTitle" style="margin: 0; font-weight: 800; color: #fff;">New Milestone</h2>
            <button onclick="closeCreateModal()" class="btn-close-modal">&times;</button>
        </div>
        <form class="auth-form" id="goalForm" onsubmit="event.preventDefault(); submitGoal();" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
            @Html.AntiForgeryToken()
            <input type="hidden" id="goalId" />
            <div class="form-group" style="grid-column: 1/-1;">
                <label>Goal Title</label>
                <input id="newGoalTitle" type="text" class="form-control" placeholder="e.g. Master Cloud Architecture" required />
            </div>
            <div class="form-group" style="grid-column: 1/-1;">
                <label>Description</label>
                <textarea id="newGoalDescription" class="form-control" placeholder="What are the details of this goal?" style="min-height: 70px;"></textarea>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="newGoalCategory" class="form-control">
                    <option value="Health">Health üèÉ‚Äç‚ôÇÔ∏è</option>
                    <option value="Work">Work üíº</option>
                    <option value="Learning">Learning üìö</option>
                    <option value="Finance">Finance üí∞</option>
                    <option value="Personal">Personal ‚ú®</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="newGoalPriority" class="form-control">
                    <option value="High">üî¥ High</option>
                    <option value="Medium" selected>üü† Medium</option>
                    <option value="Low">üü¢ Low</option>
                </select>
            </div>
            <div class="form-group">
                <label>Target Value</label>
                <input id="newGoalTarget" type="number" step="0.01" class="form-control" placeholder="e.g. 100" required />
            </div>
            <div class="form-group">
                <label>Unit</label>
                <input id="newGoalUnit" type="text" class="form-control" placeholder="e.g. hrs, pages" />
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input id="newGoalStart" type="date" class="form-control" />
            </div>
            <div class="form-group">
                <label>Deadline</label>
                <input id="newGoalEnd" type="date" class="form-control" />
            </div>
            <button type="submit" id="submitBtn" class="btn-teal-full btn-premium-submit" style="grid-column: 1/-1; margin-top: 1rem;">
                <span class="btn-text">Launch Milestone</span>
                <span class="btn-spinner" style="display: none;">
                    <div class="spinner-sm"></div>
                </span>
            </button>
        </form>
    </div>
</div>

<!-- Update Progress Modal -->
<div id="updateProgressModal" class="modal-overlay" style="display: none;">
    <div class="modal-card" style="width: 100%; max-width: 420px; padding: 2.5rem; border-radius: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="margin: 0; font-weight: 800; color: #fff;">Track Progress</h2>
            <button onclick="closeUpdateModal()" class="btn-close-modal">&times;</button>
        </div>
        <div class="auth-form">
            <input type="hidden" id="updateGoalId" />
            <input type="hidden" id="updateCurrentTotal" />
            <div class="form-group">
                <label id="updateModalLabel">Progress to Add</label>
                <input id="progressToAdd" type="number" step="0.01" class="form-control" placeholder="e.g. 5.5" required />
            </div>
            <button onclick="submitUpdateProgress()" class="btn-teal-full" style="margin-top: 1.5rem;">Save Progress</button>
        </div>
    </div>
</div>

<template id="goalCardTemplate">
    <div class="insight-card goal-card" style="padding: 2rem; border-radius: 24px; position: relative; overflow: hidden;">
        <div class="priority-accent" style="position: absolute; top: 0; right: 0; width: 60px; height: 60px; clip-path: polygon(100% 0, 0 0, 100% 100%); opacity: 0.1;"></div>
        
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
            <div style="max-width: 70%;">
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <span class="category-badge"></span>
                    <span class="priority-badge"></span>
                </div>
                <h3 class="goal-title" style="margin: 0; font-size: 1.4rem; font-weight: 850; color: #fff; line-height: 1.2;"></h3>
            </div>
            <span class="status-badge"></span>
        </div>

        <p class="goal-description" style="margin-bottom: 1.5rem; font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5; min-height: 3rem;"></p>

        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span style="font-size: 0.85rem; font-weight: 700; color: var(--text-secondary);">Progress (<span class="goal-unit"></span>)</span>
                <span class="progress-ratio" style="font-weight: 800; color: #14b8a6; font-size: 1rem;"></span>
            </div>
            <div class="mini-progress-bar" style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 30px; overflow: hidden; margin-bottom: 1rem;">
                <div class="progress-fill" style="height: 100%; width: 0%; transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);"></div>
            </div>
            <div class="suggestion-area" style="display: flex; align-items: center; gap: 0.5rem; background: rgba(20, 184, 166, 0.05); padding: 0.75rem 1rem; border-radius: 12px; border: 1px solid rgba(20, 184, 166, 0.1);">
                <span style="font-size: 1rem;">üí°</span>
                <span class="suggestion-text" style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);"></span>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
            <div style="display: flex; flex-direction: column; gap: 0.2rem;">
                <span class="days-remaining" style="font-size: 0.85rem; font-weight: 700; color: #14b8a6;"></span>
                <span style="font-size: 0.75rem; color: var(--text-secondary);">Target: <span class="goal-end-date"></span></span>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-card-action edit" title="Edit Milestone">‚úèÔ∏è</button>
                <button class="btn-card-action sched" title="Schedule Work">üìÖ</button>
                <button class="btn-card-action track" title="Track Progress">üìä</button>
                <button class="btn-card-action delete" title="Delete Milestone">üóëÔ∏è</button>
            </div>
        </div>
    </div>
</template>

<style>
    :root { --teal-accent: #14b8a6; --teal-glow: rgba(20, 184, 166, 0.3); }

    .input-label-sm { font-size: 0.75rem; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 0.5rem; display: block; letter-spacing: 0.5px; }

    .stat-mini-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 1.25rem 1.5rem; display: flex; align-items: center; gap: 1rem; transition: all 0.3s; }
    .stat-mini-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.05); }

    .stat-icon { font-size: 1.75rem; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border-radius: 12px; }
    .stat-label { display: block; font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; margin-bottom: 2px; }
    .stat-value { display: block; font-size: 1.4rem; font-weight: 850; color: #fff; line-height: 1; }

    .form-control-sm { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 0.6rem 1rem; color: #fff; font-weight: 600; min-width: 150px; outline: none; }
    .form-control-sm:focus { border-color: var(--teal-accent); }

    .category-badge { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; background: rgba(255,255,255,0.05); color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.05); }
    
    .priority-badge { padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; }
    .priority-badge.high { background: rgba(239, 68, 68, 0.1); color: #f87171; }
    .priority-badge.medium { background: rgba(245, 158, 11, 0.1); color: #fbbf24; }
    .priority-badge.low { background: rgba(16, 185, 129, 0.1); color: #34d399; }

    .status-badge { padding: 6px 12px; border-radius: 30px; font-size: 0.65rem; font-weight: 850; text-transform: uppercase; letter-spacing: 0.5px; }
    .status-badge.on-track { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-badge.off-track { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .status-badge.completed { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }

    .btn-card-action { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); cursor: pointer; transition: all 0.2s; font-size: 1.1rem; }
    .btn-card-action:hover { transform: scale(1.1); background: rgba(255,255,255,0.1); }
    .btn-card-action.delete:hover { background: #ef4444; color: #fff; }
    .btn-card-action.track:hover { background: var(--teal-accent); color: #fff; }

    .progress-fill.on-track { background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%); }
    .progress-fill.off-track { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
    .progress-fill.completed { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }

    .pulse-teal { animation: pulseGlow 2s infinite; }
    @@keyframes pulseGlow { 0% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(20, 184, 166, 0); } 100% { box-shadow: 0 0 0 0 rgba(20, 184, 166, 0); } }
    @@keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .toast { position: relative; background: #1e293b; color: #fff; padding: 1rem 1.75rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; display: flex; align-items: center; gap: 0.75rem; max-width: 320px; }
    .toast.success { border-left: 4px solid #14b8a6; }
    @@keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .btn-premium-submit { 
        background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        height: 52px;
        font-weight: 800;
        letter-spacing: 0.5px;
    }
    .btn-premium-submit:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 8px 25px rgba(20, 184, 166, 0.4); 
    }
    .btn-premium-submit:active { transform: scale(0.98); }
    .btn-premium-submit .btn-spinner { width: 20px; height: 20px; }
    .spinner-sm { 
        width: 20px; height: 20px; 
        border: 3px solid rgba(255,255,255,0.3); 
        border-top-color: #fff; 
        border-radius: 50%; 
        animation: spin 0.8s linear infinite; 
    }
    @@keyframes spin { to { transform: rotate(360deg); } }

    .tab-btn { background: none; border: none; color: var(--text-secondary); font-weight: 800; font-size: 1rem; padding: 1rem 1.5rem; cursor: pointer; border-radius: 12px; transition: all 0.3s; position: relative; }
    .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.03); }
    .tab-btn.active { color: #14b8a6; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -0.5rem; left: 0; width: 100%; height: 2px; background: #14b8a6; }

    .calendar-grid { min-height: 500px; }
    .calendar-day { background: rgba(255,255,255,0.02); aspect-ratio: 1; border-radius: 16px; padding: 1rem; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; cursor: pointer; position: relative; }
    .calendar-day:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); border-color: rgba(20, 184, 166, 0.3); }
    .calendar-day.today { border: 2px solid #14b8a6; }
    .calendar-day.has-work { background: rgba(20, 184, 166, 0.05); }
    .calendar-day.other-month { opacity: 0.3; pointer-events: none; }
    .day-number { font-weight: 850; font-size: 1.2rem; color: var(--text-secondary); }
    .today .day-number { color: #14b8a6; }
    .work-indicator { width: 8px; height: 8px; background: #14b8a6; border-radius: 50%; margin: 5px auto 0; box-shadow: 0 0 10px #14b8a6; }
    .day-name { font-size: 0.8rem; font-weight: 850; color: var(--text-secondary); opacity: 0.6; }

    .suggestion-text .highlight { color: #14b8a6; font-weight: 850; }
    .overdue-badge { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 850; display: inline-flex; align-items: center; gap: 4px; border: 1px solid rgba(239, 68, 68, 0.2); }
    .overdue-badge { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 850; display: inline-flex; align-items: center; gap: 4px; border: 1px solid rgba(239, 68, 68, 0.2); }

    /* Achievement Styles */
    .achievement-card { 
        min-width: 80px; height: 80px; 
        background: rgba(255,255,255,0.03); 
        border-radius: 16px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border: 1px solid rgba(255,255,255,0.05);
        cursor: help;
        position: relative;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        animation: badgePop 0.5s ease-out;
    }
    .achievement-card:hover { 
        background: rgba(255,255,255,0.08); 
        transform: translateY(-5px) scale(1.05);
        border-color: #14b8a6;
    }
    .achievement-card .icon { font-size: 2rem; margin-bottom: 0px; }

    /* Smooth Tab Transitions */
    .tab-content {
        animation: fadeIn 0.4s ease-out;
    }
    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .achievement-card .tooltip {
        position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
        background: #1e293b; color: #fff; padding: 0.75rem 1rem; border-radius: 12px;
        font-size: 0.8rem; font-weight: 600; width: 200px; text-align: center;
        opacity: 0; visibility: hidden; transition: all 0.2s ease;
        pointer-events: none; z-index: 100;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 10px;
    }
    .achievement-card:hover .tooltip { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-5px); }
    @@keyframes badgePop {
        0% { transform: scale(0.5); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
</style>

@section Scripts {
    <script>
        const API_BASE = '/GoalTracker';
        const getAntiforgeryToken = () => document.querySelector('#goalForm input[name="__RequestVerificationToken"]').value;

        let allGoals = [];
        let allSchedules = [];
        let statusChart, categoryChart, timelineChart;
        let currentCalendarDate = new Date();

        // Tabs
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            const activeTab = document.getElementById(tabId + 'Tab');
            if (activeTab) activeTab.style.display = 'block';
            
            const activeBtn = document.getElementById('btn-tab-' + tabId);
            if (activeBtn) activeBtn.classList.add('active');

            if (tabId === 'calendar') renderCalendar();
            if (tabId === 'analytics') loadAnalytics();
        }

        // Toast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span style="font-size: 1.2rem;">${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span style="font-weight: 500;">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.transition = '0.4s'; toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 400); }, 4000);
        }

        // Modals
        function openCreateModal(goal = null) {
            const modal = document.getElementById('createGoalModal');
            const title = document.getElementById('modalTitle');
            const btn = document.getElementById('submitBtn');
            
            if (goal) {
                title.textContent = "Edit Milestone";
                if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = "Save Changes";
                else btn.textContent = "Save Changes";
                document.getElementById('goalId').value = goal.id;
                document.getElementById('newGoalTitle').value = goal.title;
                document.getElementById('newGoalDescription').value = goal.description || '';
                document.getElementById('newGoalCategory').value = goal.category;
                document.getElementById('newGoalPriority').value = goal.priority;
                document.getElementById('newGoalTarget').value = goal.targetValue;
                document.getElementById('newGoalUnit').value = goal.unit;
                document.getElementById('newGoalStart').value = goal.startDate.split('T')[0];
                document.getElementById('newGoalEnd').value = goal.endDate.split('T')[0];
            } else {
                title.textContent = "New Milestone";
                if (btn.querySelector('.btn-text')) btn.querySelector('.btn-text').textContent = "Launch Milestone";
                else btn.textContent = "Launch Milestone";
                document.getElementById('goalId').value = '';
                document.getElementById('goalForm').reset();
            }
            modal.style.display = 'flex';
        }
        function closeCreateModal() { document.getElementById('createGoalModal').style.display = 'none'; }
        
        function openScheduleModal(goalId) {
            document.getElementById('scheduleGoalId').value = goalId;
            document.getElementById('schedDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addScheduleModal').style.display = 'flex';
        }
        function closeScheduleModal() { document.getElementById('addScheduleModal').style.display = 'none'; }

        function openDayViewModal(dateString) {
            const daySchedules = allSchedules.filter(s => s.scheduledDate.split('T')[0] === dateString);
            const container = document.getElementById('dayScheduleContainer');
            const title = document.getElementById('dayViewTitle');
            const dateObj = new Date(dateString);
            
            title.textContent = "Planned for " + dateObj.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
            container.innerHTML = '';

            if (daySchedules.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No deep work sessions planned for this day.</p>';
            } else {
                daySchedules.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'stat-mini-card';
                    div.style = 'flex-direction: column; align-items: flex-start; gap: 0.5rem; animation: slideInLeft 0.3s ease-out';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <span style="font-weight: 850; color: #14b8a6;">${s.goal.title}</span>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">${s.startTime} - ${s.endTime}</span>
                        </div>
                        ${s.notes ? `<p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">${s.notes}</p>` : ''}
                        <button onclick="handleDeleteSchedule(${s.id})" style="align-self: flex-end; background: none; border: none; color: #ef4444; font-size: 0.8rem; cursor: pointer; font-weight: 700;">Remove</button>
                    `;
                    container.appendChild(div);
                });
            }
            document.getElementById('dayViewModal').style.display = 'flex';
        }
        function closeDayViewModal() { document.getElementById('dayViewModal').style.display = 'none'; }

        function openUpdateModal(id, current) {
            document.getElementById('updateGoalId').value = id;
            document.getElementById('updateCurrentTotal').value = current;
            document.getElementById('progressToAdd').value = '';
            document.getElementById('updateProgressModal').style.display = 'flex';
        }
        function closeUpdateModal() { document.getElementById('updateProgressModal').style.display = 'none'; }

        // Logic
        async function loadGoals() {
            try {
                const res = await fetch(`${API_BASE}/GetGoals`);
                const result = await res.json();
                if (result.success) {
                    allGoals = result.data;
                    await loadSchedules();
                    await loadAchievements();
                    initCharts();
                    applyFilters();
                }
            } catch (err) { console.error(err); }
        }

        async function loadAchievements() {
            try {
                const res = await fetch(`${API_BASE}/GetUserAchievements`);
                const result = await res.json();
                if (result.success && result.data.length > 0) {
                    const hub = document.getElementById('achievementsHub');
                    const list = document.getElementById('achievementsList');
                    const count = document.getElementById('achievementCount');
                    
                    hub.style.display = 'block';
                    list.innerHTML = '';
                    count.textContent = `${result.data.length} Unlocked`;

                    result.data.forEach(a => {
                        const card = document.createElement('div');
                        card.className = 'achievement-card';
                        card.innerHTML = `
                            <span class="icon">${a.icon}</span>
                            <div class="tooltip">
                                <div style="color: #14b8a6; font-weight: 850; margin-bottom: 4px;">${a.achievementName}</div>
                                <div style="color: #cbd5e1; font-size: 0.75rem;">${a.description}</div>
                                <div style="margin-top: 8px; font-size: 0.65rem; color: var(--text-secondary); opacity: 0.6;">Unlocked ${new Date(a.achievedAt).toLocaleDateString()}</div>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                }
            } catch (err) { console.error(err); }
        }

        async function loadSchedules() {
            try {
                const res = await fetch(`${API_BASE}/GetCalendarData`);
                const result = await res.json();
                if (result.success) {
                    allSchedules = result.data;
                    if (document.getElementById('btn-tab-calendar').classList.contains('active')) {
                        renderCalendar();
                    }
                }
            } catch (err) { console.error(err); }
        }

        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const category = document.getElementById('filterCategory').value;
            const field = document.getElementById('sortField').value;

            let filtered = allGoals.filter(g => (status === 'All' || g.status === status) && (category === 'All' || g.category === category));

            filtered.sort((a, b) => {
                if (field === 'priority') {
                    const map = { 'High': 3, 'Medium': 2, 'Low': 1 };
                    return map[b.priority] - map[a.priority];
                }
                if (field === 'progressPercent') return b.progressPercent - a.progressPercent;
                if (field === 'endDate') return new Date(a.endDate) - new Date(b.endDate);
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            document.getElementById('filteredCount').textContent = filtered.length;
            renderGoals(filtered);
            if (document.getElementById('analyticsTab').style.display !== 'none') {
                loadAnalytics();
            }
        }

        function renderGoals(goals) {
            const container = document.getElementById('goalsContainer');
            const loading = document.getElementById('goalsLoading');
            if (loading) loading.style.display = 'none';
            container.querySelectorAll('.goal-card, .empty-state').forEach(el => el.remove());

            if (!goals.length) {
                const e = document.createElement('div'); e.className = 'empty-state'; e.style='grid-column: 1/-1; padding: 4rem; text-align: center; color: var(--text-secondary);';
                e.innerHTML = `<div style="font-size: 3rem; opacity: 0.3;">üéØ</div><h2 style="color:#fff;">No data found</h2>`;
                container.appendChild(e); return;
            }

            const template = document.getElementById('goalCardTemplate');
            goals.forEach((g, i) => {
                const clone = template.content.cloneNode(true);
                const card = clone.querySelector('.goal-card');
                
                card.querySelector('.priority-accent').style.background = g.priority === 'High' ? '#ef4444' : (g.priority === 'Medium' ? '#fbbf24' : '#10b981');
                card.querySelector('.goal-title').textContent = g.title;
                card.querySelector('.goal-description').textContent = g.description || 'No description provided...';
                card.querySelector('.goal-unit').textContent = g.unit || 'units';
                card.querySelector('.goal-end-date').textContent = new Date(g.endDate).toLocaleDateString();
                
                const cat = card.querySelector('.category-badge'); if (cat) cat.textContent = g.category || 'General';
                const prio = card.querySelector('.priority-badge'); 
                if (prio) {
                    prio.textContent = g.priority || 'Medium';
                    const prioClass = (g.priority || 'Medium').toLowerCase();
                    prio.classList.add(prioClass);
                }
                
                const badge = card.querySelector('.status-badge'); 
                if (badge) {
                    badge.textContent = g.status || 'Active';
                    const slug = (g.status || 'Active').toLowerCase().replace(' ', '-'); 
                    badge.classList.add(slug);
                }

                const fill = card.querySelector('.progress-fill'); 
                if (fill) {
                    const percent = g.progressPercent || 0;
                    fill.style.width = `${Math.min(percent, 100)}%`; 
                    const slug = (g.status || 'Active').toLowerCase().replace(' ', '-');
                    fill.classList.add(slug);
                }
                
                const ratio = card.querySelector('.progress-ratio');
                if (ratio) ratio.textContent = `${g.currentValue || 0}/${g.targetValue || 0} (${(g.progressPercent || 0).toFixed(1)}%)`;

                const rem = Math.ceil((new Date(g.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                card.querySelector('.days-remaining').textContent = rem > 0 ? `${rem} days remaining` : (rem === 0 ? "Today is the deadline!" : "Deadline passed");

                // Suggestion Logic
                const suggestText = card.querySelector('.suggestion-text');
                const suggestArea = card.querySelector('.suggestion-area');
                
                if (g.progressPercent >= 100) {
                    suggestArea.style.display = 'none';
                } else if (rem < 0) {
                    suggestArea.style.background = 'rgba(239, 68, 68, 0.05)';
                    suggestArea.style.borderColor = 'rgba(239, 68, 68, 0.1)';
                    suggestText.innerHTML = `<span class="overdue-badge">‚ö†Ô∏è Overdue</span> <span style="color: #ef4444;">Deadline has passed!</span>`;
                } else {
                    const remainingValue = g.targetValue - g.currentValue;
                    const daysToWork = Math.max(rem, 1); // Avoid division by zero
                    const dailyEffort = remainingValue / daysToWork;
                    const effortStr = dailyEffort % 1 === 0 ? dailyEffort.toString() : dailyEffort.toFixed(1);
                    suggestText.innerHTML = `Suggested daily effort: <span class="highlight">${effortStr} ${g.unit || 'units'}</span>/day`;
                }

                const btnEdit = card.querySelector('.edit');
                const btnSched = card.querySelector('.sched');
                const btnTrack = card.querySelector('.track');
                const btnDelete = card.querySelector('.delete');

                if (btnEdit) btnEdit.onclick = () => openCreateModal(g);
                if (btnSched) btnSched.onclick = () => openScheduleModal(g.id);
                if (btnTrack) btnTrack.onclick = () => openUpdateModal(g.id, g.currentValue);
                if (btnDelete) btnDelete.onclick = () => handleDelete(g.id);

                container.appendChild(clone);
            });
        }

        // Calendar Core
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('calendarMonthYear');
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(currentCalendarDate);
            monthLabel.textContent = `${monthName} ${year}`;
            
            grid.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayIdx = firstDay.getDay(); // 0 is Sunday
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            // Padding from prev month
            for (let i = startDayIdx - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<span class="day-number">${prevMonthLastDay - i}</span>`;
                grid.appendChild(day);
            }
            
            // Current month days
            const today = new Date();
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const day = document.createElement('div');
                const works = allSchedules.filter(s => s.scheduledDate.split('T')[0] === dateStr);
                
                day.className = 'calendar-day' + (works.length > 0 ? ' has-work' : '');
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === i) {
                    day.classList.add('today');
                }
                
                day.innerHTML = `
                    <span class="day-number">${i}</span>
                    ${works.length > 0 ? `<div class="work-indicator" title="${works.length} sessions planned"></div>` : ''}
                `;
                day.onclick = () => openDayViewModal(dateStr);
                grid.appendChild(day);
            }
        }

        // Charts
        async function loadAnalytics() {
            try {
                const res = await fetch(`${API_BASE}/GetGoalAnalytics`);
                const result = await res.json();
                if (result.success) {
                    const data = result.data;
                    document.getElementById('statTotalGoals').textContent = data.totalGoals;
                    document.getElementById('statCompletionRate').textContent = data.completionRate.toFixed(0) + '%';
                    document.getElementById('statActiveGoals').textContent = data.activeGoals;
                    document.getElementById('statOverdueGoals').textContent = data.overdueGoals;
                    
                    updateCharts(data);
                }
            } catch (err) { console.error(err); }
        }

        function initCharts() {
            if (statusChart) statusChart.destroy();
            if (categoryChart) categoryChart.destroy();
            if (timelineChart) timelineChart.destroy();
            
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            };

            const ctx1 = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctx1, { 
                type: 'doughnut', 
                data: { labels: ['Active', 'Completed', 'Overdue'], datasets:[{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#ef4444'], borderWidth: 0 }] }, 
                options: { ...baseOptions, cutout: '75%', plugins: { legend: { display: false } } } 
            });

            const ctx2 = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx2, { 
                type: 'bar', 
                data: { labels: [], datasets:[{ data: [], backgroundColor: '#14b8a6', borderRadius: 8 }] }, 
                options: { ...baseOptions, scales: { y: { display: false }, x: { ticks: { color: '#888', font: { size: 10 } } } } } 
            });

            const ctx3 = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(ctx3, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Completions', data: [], borderColor: '#14b8a6', backgroundColor: 'rgba(20, 184, 166, 0.1)', fill: true, tension: 0.4, borderWidth: 3, pointRadius: 4, pointBackgroundColor: '#14b8a6' }] },
                options: { 
                    ...baseOptions, 
                    scales: { 
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888', stepSize: 1 } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateCharts(data = null) {
            if (!statusChart) return;

            if (data) {
                // Use aggregated backend analytics
                statusChart.data.datasets[0].data = [data.activeGoals, data.completedGoals, data.overdueGoals];
                statusChart.update();

                categoryChart.data.labels = Object.keys(data.categoryBreakdown);
                categoryChart.data.datasets[0].data = Object.values(data.categoryBreakdown);
                categoryChart.update();

                if (timelineChart) {
                    timelineChart.data.labels = Object.keys(data.monthlyCompletionData);
                    timelineChart.data.datasets[0].data = Object.values(data.monthlyCompletionData);
                    timelineChart.update();
                }
            } else {
                // Fallback to client-side filtered results for small charts
                const statusCounts = { 'On Track': 0, 'Off Track': 0, 'Completed': 0 };
                const catCounts = {};
                
                allGoals.forEach(g => {
                    statusCounts[g.status]++;
                    catCounts[g.category] = (catCounts[g.category] || 0) + 1;
                });

                statusChart.data.datasets[0].data = [statusCounts['On Track'] + statusCounts['Off Track'], statusCounts['Completed'], 0];
                statusChart.update();

                categoryChart.data.labels = Object.keys(catCounts);
                categoryChart.data.datasets[0].data = Object.values(catCounts);
                categoryChart.update();
            }
        }

        // CRUD
        async function submitGoal() {
            const btn = document.getElementById('submitBtn');
            if (!btn) return;
            const btnText = btn.querySelector('.btn-text');
            const btnSpinner = btn.querySelector('.btn-spinner');

            try {
                // UI Loading State
                btn.disabled = true;
                if (btnText) btnText.style.opacity = '0.5';
                if (btnSpinner) btnSpinner.style.display = 'block';

                const id = document.getElementById('goalId').value;
                const data = {
                    id: id ? parseInt(id) : 0,
                    title: document.getElementById('newGoalTitle').value,
                    description: document.getElementById('newGoalDescription').value,
                    category: document.getElementById('newGoalCategory').value,
                    priority: document.getElementById('newGoalPriority').value,
                    status: id ? allGoals.find(g => g.id == id).status : "Active",
                    targetValue: parseFloat(document.getElementById('newGoalTarget').value) || 0,
                    unit: document.getElementById('newGoalUnit').value || '',
                    startDate: document.getElementById('newGoalStart').value || new Date().toISOString().split('T')[0],
                    endDate: document.getElementById('newGoalEnd').value || new Date().toISOString().split('T')[0]
                };

                const url = id ? `${API_BASE}/UpdateGoal` : `${API_BASE}/CreateGoal`;
                const res = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getAntiforgeryToken() }, 
                    body: JSON.stringify(data) 
                });
                
                const result = await res.json();
                if (result.success) { 
                    showToast(result.message); 
                    closeCreateModal(); 
                    loadGoals(); 
                } else { 
                    showToast(result.message, "error"); 
                }
            } catch (err) { 
                console.error(err);
                showToast("Connection error. Please try again.", "error");
            } finally {
                btn.disabled = false;
                if (btnText) btnText.style.opacity = '1';
                if (btnSpinner) btnSpinner.style.display = 'none';
            }
        }

        async function submitUpdateProgress() {
            const id = document.getElementById('updateGoalId').value;
            const toAdd = parseFloat(document.getElementById('progressToAdd').value);
            const total = parseFloat(document.getElementById('updateCurrentTotal').value) + toAdd;

            const fd = new FormData(); fd.append('id', id); fd.append('currentValue', total);
            try {
                const res = await fetch(`${API_BASE}/UpdateProgress`, { method: 'POST', headers: { 'RequestVerificationToken': getAntiforgeryToken() }, body: fd });
                const result = await res.json();
                if (result.success) { showToast("Progress synchronized."); closeUpdateModal(); loadGoals(); }
                else showToast(result.message, "error");
            } catch (err) { console.error(err); }
        }

        async function handleDelete(id) {
            if (!confirm("Remove this milestone permanently?")) return;
            const fd = new FormData(); fd.append('id', id);
            try {
                const res = await fetch(`${API_BASE}/DeleteGoal`, { method: 'POST', headers: { 'RequestVerificationToken': getAntiforgeryToken() }, body: fd });
                const result = await res.json();
                if (result.success) { showToast("Milestone removed."); loadGoals(); }
            } catch (err) { console.error(err); }
        }

        async function submitSchedule() {
            const data = {
                goalId: parseInt(document.getElementById('scheduleGoalId').value),
                scheduledDate: document.getElementById('schedDate').value,
                startTime: document.getElementById('schedStart').value,
                endTime: document.getElementById('schedEnd').value,
                notes: document.getElementById('schedNotes').value
            };

            try {
                const res = await fetch(`${API_BASE}/AddScheduleEntry`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': getAntiforgeryToken() }, 
                    body: JSON.stringify(data) 
                });
                const result = await res.json();
                if (result.success) {
                    showToast(result.message);
                    closeScheduleModal();
                    await loadSchedules();
                } else {
                    showToast(result.message, "error");
                }
            } catch (err) { console.error(err); }
        }

        async function handleDeleteSchedule(id) {
            if (!confirm("Cancel this work session?")) return;
            const fd = new FormData(); fd.append('id', id);
            try {
                const res = await fetch(`${API_BASE}/DeleteScheduleEntry`, { 
                    method: 'POST', 
                    headers: { 'RequestVerificationToken': getAntiforgeryToken() }, 
                    body: fd 
                });
                const result = await res.json();
                if (result.success) {
                    showToast("Session removed.");
                    await loadSchedules();
                    const dateStr = document.getElementById('dayViewTitle').textContent.split("Planned for ")[1];
                    // Close day view if empty or refresh
                    const remainingForDay = allSchedules.filter(s => s.id !== id && new Date(s.scheduledDate).toLocaleDateString() === dateStr).length;
                    if (remainingForDay === 0) closeDayViewModal(); else {
                        // We need the raw ISO string for openDayViewModal
                        const rawDate = allSchedules.find(s => s.id === id).scheduledDate.split('T')[0];
                        openDayViewModal(rawDate);
                    }
                }
            } catch (err) { console.error(err); }
        }

        document.addEventListener('DOMContentLoaded', loadGoals);
    </script>
}
