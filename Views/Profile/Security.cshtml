@model TodoListApp.Models.ApplicationUser
@{
    ViewData["Title"] = "Security Settings";
    var credentials = ViewBag.Credentials as List<UserWebAuthnCredential> ?? new List<UserWebAuthnCredential>();
}

<div class="dashboard-container fade-in">
    <div class="dashboard-header">
        <div>
            <h1 data-translate="true">Security Settings</h1>
            <p class="subtitle" data-translate="true">Manage your PIN protection and biometric devices</p>
        </div>
        <div class="header-actions">
            <a asp-action="Index" class="btn-secondary" style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Back to Profile
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success mt-4 fade-in" style="background: rgba(74, 222, 128, 0.1); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.2); border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 12px; margin-bottom: 2rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mt-4 fade-in" style="background: rgba(248, 113, 113, 0.1); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.2); border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 12px; margin-bottom: 2rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12.01" y2="8"></line><line x1="12" y1="12" x2="12" y2="16"></line></svg>
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
        
        <!-- 1. Passkey Settings (PIN) -->
        <div class="todo-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-key"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                Passkey PIN Settings
            </h3>
            
            @if (Model.IsPasskeyEnabled)
            {
                <div style="background: rgba(74, 222, 128, 0.05); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(74, 222, 128, 0.1); margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px; color: #4ade80; font-weight: 500;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        PIN Protection Enabled
                    </div>
                    <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 0.5rem; margin-bottom: 0;">Your secure modules are protected. Re-verification is required on every entry.</p>
                </div>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="btn-primary" onclick="showPinModal('change')" style="width: 100%;">Change PIN</button>
                    
                    <form asp-action="DisablePin" method="post" onsubmit="return confirm('Disabling PIN protection will lower your account security. Are you sure?')">
                        <button type="submit" class="btn-secondary" style="width: 100%; color: #f87171; border-color: rgba(248, 113, 113, 0.3);">Disable PIN Protection</button>
                    </form>
                </div>
            }
            else
            {
                <div style="background: rgba(248, 113, 113, 0.05); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(248, 113, 113, 0.1); margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px; color: #f87171; font-weight: 500;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12.01" y2="8"></line><line x1="12" y1="12" x2="12" y2="16"></line></svg>
                        PIN Protection Disabled
                    </div>
                </div>
                <button class="btn-glow-primary" onclick="showPinModal('enable')" style="width: 100%;">Enable PIN Protection</button>
            }
        </div>

        <!-- 2. Biometric Unlock Section -->
        <div class="todo-card">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-command"><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3z"></path><path d="M6 6a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v12a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3V6z"></path></svg>
                Biometric Unlock
            </h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem;">
                Use Face ID, Fingerprint, or Windows Hello to unlock secure modules. 
            </p>

            <div id="biometricStatus">
                @if (credentials.Any())
                {
                    <div style="background: rgba(74, 222, 128, 0.05); padding: 1rem; border-radius: 12px; border: 1px solid rgba(74, 222, 128, 0.1); margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 10px; color: #4ade80; font-weight: 500;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            Biometrics Enabled
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <label style="font-size: 0.75rem; text-transform: uppercase; opacity: 0.5; margin-bottom: 4px;">Registered Devices</label>
                        @foreach (var cred in credentials)
                        {
                            <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid var(--glass-border);">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-smartphone"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                                    <span style="font-size: 0.9rem;">@cred.DeviceName</span>
                                    <span style="font-size: 0.7rem; opacity: 0.5;">(@cred.CreatedAt.ToString("MMM dd, yyyy"))</span>
                                </div>
                                <form asp-action="RemoveBiometric" asp-route-id="@cred.Id" method="post" style="margin:0;" onsubmit="return confirm('Are you sure you want to remove this biometric device?')">
                                    <button type="submit" style="background:transparent; border:none; color: #f87171; cursor:pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(248,113,113,0.1)'" onmouseout="this.style.background='transparent'">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                    </button>
                                </form>
                            </div>
                        }
                    </div>
                    <button id="btnRegisterBiometric" class="btn-glow-accent" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                        Register Another Device
                    </button>
                }
                else
                {
                    <div style="background: rgba(0,0,0,0.1); padding: 1.25rem; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 1.5rem; text-align: center;">
                        <div style="opacity: 0.5; margin-bottom: 4px;">No devices registered</div>
                    </div>
                    <button id="btnRegisterBiometric" class="btn-glow-primary" style="width: 100%;">Enable Face ID / Fingerprint</button>
                }
            </div>

            <div id="noSupportNote" style="display:none; color: #f87171; font-size: 0.85rem; margin-top: 1rem; text-align: center; border: 1px solid rgba(248, 113, 113, 0.2); background: rgba(248, 113, 113, 0.05); padding: 0.75rem; border-radius: 8px;">
                Your browser or device does not support WebAuthn biometrics.
            </div>
        </div>
    </div>
</div>

<!-- PIN Management Modal -->
<div id="pinModal" class="modal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(8px); z-index:1000; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition: opacity 0.3s ease;">
    <div class="auth-card" style="max-width:400px; width:90%; position:relative;">
        <button onclick="closePinModal()" style="position:absolute; top:1rem; right:1rem; background:transparent; border:none; color:var(--text-secondary); cursor:pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>

        <h2 id="pinModalTitle" style="margin-bottom: 0.5rem;">Setup Passkey PIN</h2>
        <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:2rem;">Your PIN must be 4 or 6 numeric digits.</p>

        <form asp-action="UpdatePin" method="post">
            <div class="form-group mb-3">
                <label class="form-label" style="display:block; margin-bottom:8px;">New PIN</label>
                <input type="password" name="pin" class="form-control text-center" maxlength="6" pattern="\d{4}|\d{6}" inputmode="numeric" required 
                       style="font-size: 2rem; letter-spacing: 0.5rem; height: 3.5rem; border-radius: 12px; border: 1px solid var(--glass-border); background:rgba(255,255,255,0.02); color:var(--accent-color);"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <div class="form-group mb-4">
                <label class="form-label" style="display:block; margin-bottom:8px;">Confirm PIN</label>
                <input type="password" name="confirmPin" class="form-control text-center" maxlength="6" pattern="\d{4}|\d{6}" inputmode="numeric" required 
                       style="font-size: 2rem; letter-spacing: 0.5rem; height: 3.5rem; border-radius: 12px; border: 1px solid var(--glass-border); background:rgba(255,255,255,0.02); color:var(--accent-color);"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <button type="submit" class="btn-glow-primary" style="width:100%;">Save Secret PIN</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Modal Logic
        function showPinModal(type) {
            const modal = document.getElementById('pinModal');
            const title = document.getElementById('pinModalTitle');
            title.innerText = type === 'change' ? 'Change Passkey PIN' : 'Enable Passkey PIN';
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
            }, 10);
        }

        function closePinModal() {
            const modal = document.getElementById('pinModal');
            modal.style.opacity = '0';
            modal.style.pointerEvents = 'none';
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // WebAuthn Logic
        function base64urlToUint8Array(base64url) {
            const padding = '='.repeat((4 - base64url.length % 4) % 4);
            const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
        }

        function uint8ArrayToBase64url(array) {
            const base64 = btoa(String.fromCharCode(...array));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        async function registerBiometric() {
            const btn = document.getElementById('btnRegisterBiometric');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerText = 'Initializing...';

            try {
                const response = await fetch('/WebAuthn/MakeCredentialOptions', { method: 'POST' });
                const options = await response.json();

                if (options.success === false) {
                    showToast(options.message, 'error');
                    return;
                }

                options.user.id = base64urlToUint8Array(options.user.id);
                options.challenge = base64urlToUint8Array(options.challenge);
                if (options.excludeCredentials) {
                    for (let cred of options.excludeCredentials) {
                        cred.id = base64urlToUint8Array(cred.id);
                    }
                }

                const credential = await navigator.credentials.create({ publicKey: options });

                // Detect platform for device name
                let deviceName = 'Registered Device';
                const ua = navigator.userAgent;
                if (ua.includes('iPhone')) deviceName = 'iPhone';
                else if (ua.includes('iPad')) deviceName = 'iPad';
                else if (ua.includes('Android')) deviceName = 'Android Device';
                else if (ua.includes('Macintosh')) deviceName = 'MacBook / iMac';
                else if (ua.includes('Windows')) deviceName = 'Windows PC';

                const attestationResponse = {
                    id: credential.id,
                    rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                    type: credential.type,
                    response: {
                        attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                        clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON))
                    }
                };

                const verifyResponse = await fetch('/WebAuthn/MakeCredential', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        attestationResponse: attestationResponse,
                        deviceName: deviceName
                    })
                });

                const result = await verifyResponse.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (err) {
                console.error(err);
                if (err.name !== 'NotAllowedError') {
                    showToast(err.message || 'Biometric registration failed', 'error');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        if (document.getElementById('btnRegisterBiometric')) {
            document.getElementById('btnRegisterBiometric').addEventListener('click', registerBiometric);
        }

        if (!window.PublicKeyCredential) {
            if (document.getElementById('btnRegisterBiometric')) document.getElementById('btnRegisterBiometric').style.display = 'none';
            document.getElementById('noSupportNote').style.display = 'block';
        }
    </script>
}
